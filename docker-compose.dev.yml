# ZakApp Development Configuration
# Local build with hot-reload support
# Run with: docker compose -f docker-compose.dev.yml up
# Or use deploy-dev-build.sh for one-shot deployment

services:
  # Reverse proxy with automatic HTTPS (same as production)
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    profiles: ["dev"]
    ports:
      - "${FRONTEND_PORT:-3002}:80"
      - "${FRONTEND_PORT_SSL:-3444}:443"
    volumes:
      - ./docker/Caddyfile.dev:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_certs:/root/.local/share/caddy
    environment:
      - ZAKAPP_DOMAIN=${ZAKAPP_DOMAIN:-}
      - ZAKAPP_IP=${ZAKAPP_IP:-}
    networks:
      - zakapp-dev-network
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend - build from source and serve with nginx
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      target: frontend-production
    profiles: ["dev"]
    expose:
      - "80"
    ports:
      - "3003:80"
    networks:
      - zakapp-dev-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Backend - builds from local source with hot-reload
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
      target: development
    profiles: ["dev"]
    expose:
      - "3001"
    volumes:
      - ./server:/app/server
      - ./shared:/app/shared
      - /app/server/node_modules
      - /app/shared/node_modules
      - /app/shared/dist
      - zakapp-db:/app/server/prisma/data
    env_file:
      - .env.dev
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DATABASE_URL=file:./prisma/data/dev.db
      - FEEDBACK_WEBHOOK_URL=${REACT_APP_FEEDBACK_WEBHOOK_URL:-}
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_URL=http://couchdb:5984
    networks:
      - zakapp-dev-network
    depends_on:
      couchdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

  # Database migrations - runs once on startup

  # Database on startup
  migrations:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
      target: development
    profiles: ["dev"]
    environment:
      - DATABASE_URL=file:./prisma/data/dev.db
    volumes:
      - zakapp-db:/app/server/prisma/data
    networks:
      - zakapp-dev-network
    depends_on:
      - backend
    command: >
      sh -c "echo 'Running database migrations...' &&
             cd /app/server &&
             npx prisma migrate deploy ||
             (echo 'Migration completed or already up to date' && exit 0)"

  # CouchDB for multi-device sync
  couchdb:
    image: apache/couchdb:3.5.1
    profiles: ["dev"]
    expose:
      - "5984"
    ports:
      - "5985:5984"
      - "6985:6984"
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - COUCHDB_BIND_ADDRESS=0.0.0.0
      - COUCHDB_PORT=5984
      - COUCHDB_HTTPD_ENABLE_CORS=true
      - COUCHDB_CORS_ORIGINS=${ALLOWED_ORIGINS}
      - COUCHDB_CORS_CREDENTIALS=true
      - COUCHDB_CORS_HEADERS=accept, authorization, content-type, origin, referer
      - COUCHDB_CORS_METHODS=GET, PUT, POST, HEAD, DELETE
    volumes:
      - couchdb-data:/opt/couchdb/data
      - ./docker/couchdb/entrypoint-wrapper.sh:/usr/local/bin/entrypoint-wrapper.sh
      - ./docker/couchdb/generate-cert.sh:/usr/local/bin/generate-cert.sh
    entrypoint: ["/usr/local/bin/entrypoint-wrapper.sh"]
    command: ["couchdb"]
    networks:
      - zakapp-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

volumes:
  caddy_data:
  caddy_certs:
  zakapp-db:
    name: zakapp-dev-database
  couchdb-data:
    name: couchdb-dev-data

networks:
  zakapp-dev-network:
    name: zakapp-dev-network
    driver: bridge
