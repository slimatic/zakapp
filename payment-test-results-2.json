
> zakapp@0.9.2 test
> npm run test:server && npm run test:client && npm run test:cli --testNamePattern=payment-records.contract.test.ts --reporter=json


> zakapp@0.9.2 test:server
> cd server && npm test


> zakapp-server@0.9.2 test
> vitest run


 RUN  v3.2.4 /home/chuwi_agent/workspace/zakapp/server

[globalSetup] Preparing test database schema...
Prisma schema loaded from prisma/schema.prisma
Datasource "db": SQLite database "base.db" at "file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/base.db"

The database is already in sync with the Prisma schema.

Running generate... (Use --skip-generate to skip the generators)
[2K[1A[2K[GRunning generate... - Prisma Client
[2K[1A[2K[Gâœ” Generated Prisma Client (v6.19.2) to ./node_modules/@prisma/client in 314ms

[globalSetup] Base test database schema created.
[globalSetup] Test database schema is ready.
stdout | ../tests/contract/payment-records.contract.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2580e38f30ebedd4.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2580e38f30ebedd4.db

stdout | tests/integration/liveTracking.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4ba617e46958124b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4ba617e46958124b.db

stdout | ../tests/contract/auth-refresh.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-5467cab936e299c9.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-5467cab936e299c9.db

stdout | ../tests/contract/payment-records.contract.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/auth-refresh.test.ts > Contract Test: POST /api/auth/refresh
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/liveTracking.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/auth-refresh.test.ts > Contract Test: POST /api/auth/refresh
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/liveTracking.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/payment-records.contract.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 391.811 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 387.426 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 406.718 ms - -[0m
[0mPOST /api/assets [32m201[0m 13.785 ms - 503[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqgvb700050gjww9ti3rb1 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqgvb700050gjww9ti3rb1 for user cmldqgv8z00000gjwubis8tnt 

[0mPOST /api/nisab-year-records [32m201[0m 26.197 ms - 797[0m
[0mGET /api/nisab-year-records/status [32m200[0m 8.175 ms - 222[0m
[0mGET /api/nisab-year-records/cmldqgvb700050gjww9ti3rb1 [32m200[0m 10.139 ms - -[0m
[0mPOST /api/assets [32m201[0m 11.801 ms - 503[0m
[0mGET /api/nisab-year-records/cmldqgvb700050gjww9ti3rb1 [32m200[0m 3.684 ms - -[0m
[0mPOST /api/assets [33m400[0m 1.032 ms - 191[0m
[0mPOST /api/assets [32m201[0m 15.163 ms - 506[0m
[0mGET /api/nisab-year-records/cmldqgvb700050gjww9ti3rb1 [32m200[0m 5.930 ms - -[0m
[0mPOST /api/assets [32m201[0m 8.204 ms - 506[0m
[0mGET /api/nisab-year-records/cmldqgvb700050gjww9ti3rb1 [32m200[0m 3.838 ms - -[0m
[0mGET /api/nisab-year-records/cmldqgvb700050gjww9ti3rb1 [32m200[0m 4.139 ms - -[0m
[0mPOST /api/assets [32m201[0m 8.419 ms - 515[0m
[0mGET /api/nisab-year-records/cmldqgvb700050gjww9ti3rb1 [32m200[0m 4.920 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 344.068 ms - -[0m
[0mPOST /api/assets [32m201[0m 115.887 ms - 497[0m
 â¯ ../tests/contract/auth-refresh.test.ts (13 tests | 13 failed) 4328ms
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should refresh tokens with valid refresh token and return standardized response 2ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should require refresh token in request body 1ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle invalid refresh token format 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle expired refresh token 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle revoked refresh token 1ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle non-existent refresh token 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle deactivated user account 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should revoke old refresh token after successful refresh 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should include user info in refresh response 1ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should validate token rotation security 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle concurrent refresh attempts 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle refresh rate limiting 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should create audit log entry for token refresh 0ms
     â†’ resetAuthState is not a function
[0mPOST /api/assets [32m201[0m 108.003 ms - 497[0m
[0mPOST /api/auth/login [32m200[0m 363.302 ms - -[0m
[0mPOST /api/assets [32m201[0m 117.085 ms - 498[0m
[0mPOST /api/assets [32m201[0m 105.490 ms - 498[0m
[0mPOST /api/assets [32m201[0m 128.593 ms - 498[0m
[0mPOST /api/assets [32m201[0m 116.252 ms - 498[0m
[0mPOST /api/zakat/payments [32m201[0m 18.038 ms - 623[0m
[0mPOST /api/assets [32m201[0m 140.027 ms - 498[0m
[0mPOST /api/assets [32m201[0m 128.954 ms - 498[0m
[0mPOST /api/assets [32m201[0m 152.842 ms - 498[0m
[0mPOST /api/assets [32m201[0m 140.666 ms - 498[0m
[0mPOST /api/assets [32m201[0m 165.291 ms - 498[0m
[0mPOST /api/assets [32m201[0m 149.295 ms - 498[0m
[0mPOST /api/assets [32m201[0m 145.844 ms - 498[0m
[0mPOST /api/assets [32m201[0m 158.934 ms - 498[0m
[0mPOST /api/assets [32m201[0m 156.282 ms - 498[0m
[0mPOST /api/assets [32m201[0m 168.997 ms - 498[0m
[0mPOST /api/assets [32m201[0m 166.586 ms - 498[0m
[0mPOST /api/assets [32m201[0m 179.169 ms - 498[0m
[0mPOST /api/assets [32m201[0m 177.663 ms - 498[0m
[0mPOST /api/assets [32m201[0m 191.200 ms - 498[0m
[0mPOST /api/assets [32m201[0m 187.856 ms - 498[0m
[0mPOST /api/assets [32m201[0m 205.479 ms - 498[0m
[0mPOST /api/assets [32m201[0m 200.940 ms - 498[0m
[0mPOST /api/assets [32m201[0m 203.827 ms - 498[0m
[0mPOST /api/assets [32m201[0m 202.490 ms - 498[0m
[0mPOST /api/assets [32m201[0m 215.590 ms - 498[0m
[0mPOST /api/assets [32m201[0m 213.823 ms - 498[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

[0mPOST /api/assets [32m201[0m 239.182 ms - 498[0m
[0mPOST /api/assets [32m201[0m 236.964 ms - 498[0m
[0mPOST /api/assets [32m201[0m 230.923 ms - 498[0m
[0mPOST /api/assets [32m201[0m 231.756 ms - 498[0m
[0mPOST /api/assets [32m201[0m 234.620 ms - 498[0m
[0mPOST /api/assets [32m201[0m 238.261 ms - 498[0m
[0mPOST /api/assets [32m201[0m 250.033 ms - 498[0m
[0mPOST /api/assets [32m201[0m 278.356 ms - 498[0m
[0mPOST /api/assets [32m201[0m 340.091 ms - 497[0m
[0mPOST /api/assets [32m201[0m 351.487 ms - 497[0m
[0mPOST /api/assets [32m201[0m 355.465 ms - 497[0m
[0mPOST /api/assets [32m201[0m 359.881 ms - 497[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

[0mPOST /api/assets [32m201[0m 362.354 ms - 498[0m
stdout | ../tests/contract/assets-get.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f06061b3cd3c1211.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f06061b3cd3c1211.db

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

[0mPOST /api/auth/register [32m201[0m 352.079 ms - -[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

[0mPOST /api/auth/login [32m200[0m 336.716 ms - -[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

[0mPOST /api/zakat/payments [32m201[0m 11.239 ms - 562[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | ../tests/contract/assets-get.test.ts > Contract Test: GET /api/assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

[0mPOST /api/auth/register [32m201[0m 387.636 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 306.230 ms - -[0m
[0mPOST /api/zakat/payments [33m400[0m 1.938 ms - 162[0m
[0mPOST /api/auth/register [32m201[0m 316.356 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 312.040 ms - -[0m
[0mPOST /api/zakat/payments [33m400[0m 1.142 ms - 166[0m
stdout | ../tests/contract/assets-get.test.ts > Contract Test: GET /api/assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 326.134 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 355.968 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 300.849 ms - -[0m
[0mPOST /api/zakat/payments [33m401[0m 0.462 ms - 94[0m
[0mPOST /api/auth/login [32m200[0m 300.427 ms - -[0m
[0mGET /api/assets [33m401[0m 0.738 ms - 94[0m
[0mGET /api/assets [33m401[0m 0.917 ms - 91[0m
[0mGET /api/assets [33m401[0m 1.453 ms - 91[0m
 â¯ ../tests/contract/assets-get.test.ts (7 tests | 4 failed) 2576ms
   âœ“ Contract Test: GET /api/assets > GET /api/assets > should require authentication 8ms
   Ã— Contract Test: GET /api/assets > GET /api/assets > should return user assets with standardized response format 1ms
     â†’ App or auth token not available
   Ã— Contract Test: GET /api/assets > GET /api/assets > should return encrypted asset data with proper structure 0ms
     â†’ App or auth token not available
   Ã— Contract Test: GET /api/assets > GET /api/assets > should handle empty asset list correctly 4ms
     â†’ expected true to be false // Object.is equality
   âœ“ Contract Test: GET /api/assets > GET /api/assets > should reject invalid JWT tokens 4ms
   âœ“ Contract Test: GET /api/assets > GET /api/assets > should reject expired JWT tokens 5ms
   Ã— Contract Test: GET /api/assets > GET /api/assets > should respect rate limiting 1ms
     â†’ expected true to be false // Object.is equality
[0mPOST /api/auth/register [32m201[0m 319.430 ms - -[0m
stdout | ../tests/contract/assets-post.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3583871cd08e1d41.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3583871cd08e1d41.db

[0mPOST /api/auth/login [32m200[0m 327.653 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 13.132 ms - 585[0m
[0mPOST /api/zakat/payments [32m201[0m 7.463 ms - 585[0m
[0mPOST /api/zakat/payments [32m201[0m 7.696 ms - 585[0m
[0mGET /api/zakat/payments [32m200[0m 3.759 ms - -[0m
stdout | ../tests/contract/assets-post.test.ts > Contract Test: POST /api/assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 329.710 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 311.373 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 7.969 ms - 585[0m
[0mPOST /api/zakat/payments [32m201[0m 8.028 ms - 585[0m
[0mPOST /api/zakat/payments [32m201[0m 7.616 ms - 585[0m
[0mGET /api/zakat/payments?year=2024 [32m200[0m 2.823 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 310.268 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 305.575 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 8.126 ms - 585[0m
[0mPOST /api/zakat/payments [32m201[0m 7.405 ms - 585[0m
[0mPOST /api/zakat/payments [32m201[0m 8.368 ms - 585[0m
[0mGET /api/zakat/payments?page=1&limit=2 [32m200[0m 2.634 ms - -[0m
stdout | ../tests/contract/assets-post.test.ts > Contract Test: POST /api/assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/assets [31m500[0m 5169.641 ms - 567[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should provide asset breakdown by category
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [31m500[0m 5176.206 ms - 567[0m
[0mPOST /api/assets [31m500[0m 5169.236 ms - 567[0m
[0mPOST /api/auth/register [32m201[0m 334.380 ms - -[0m
[0mPOST /api/assets [31m500[0m 5373.651 ms - 567[0m
[0mPOST /api/assets [32m201[0m 5379.203 ms - 498[0m
[0mPOST /api/assets [32m201[0m 5394.368 ms - 498[0m
[0mPOST /api/assets [32m201[0m 5366.581 ms - 498[0m
[0mPOST /api/assets [32m201[0m 5424.963 ms - 498[0m
[0mPOST /api/assets [32m201[0m 5454.808 ms - 497[0m
[0mPOST /api/assets [32m201[0m 5464.558 ms - 497[0m
[0mGET /api/nisab-year-records/cmldqgvb700050gjww9ti3rb1 [32m200[0m 535.204 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 398.195 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 324.779 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 7.630 ms - 585[0m
[0mPOST /api/zakat/payments [32m201[0m 7.495 ms - 585[0m
[0mPOST /api/zakat/payments [32m201[0m 9.478 ms - 585[0m
[0mGET /api/zakat/payments [33m401[0m 0.244 ms - 94[0m
[0mPOST /api/auth/login [32m200[0m 307.101 ms - -[0m
 â¯ ../tests/contract/assets-post.test.ts (8 tests | 8 skipped) 2518ms
   â†“ Contract Test: POST /api/assets > POST /api/assets > should require authentication
   â†“ Contract Test: POST /api/assets > POST /api/assets > should create asset with valid data and return standardized response
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate required fields
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate asset type enum
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate currency format (ISO 4217)
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate minimum asset value
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate description length limit
   â†“ Contract Test: POST /api/assets > POST /api/assets > should handle all valid asset types
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

[0mPOST /api/auth/register [32m201[0m 316.764 ms - -[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqgv8z00000gjwubis8tnt 

stdout | src/__tests__/integration/admin-system.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-88c1c1076333d529.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-88c1c1076333d529.db

[0mPOST /api/auth/login [32m200[0m 315.610 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 8.184 ms - 592[0m
[0mPUT /api/zakat/payments/cmldqh09x001n0gjx4201gw4f [32m200[0m 11.781 ms - 644[0m
[0mPOST /api/auth/register [32m201[0m 327.600 ms - -[0m
stdout | src/__tests__/integration/admin-system.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 310.951 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 6.926 ms - 592[0m
[0mPUT /api/zakat/payments/non-existent-id [33m404[0m 1.771 ms - 161[0m
[0mPOST /api/auth/register [32m201[0m 315.020 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 300.874 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 9.161 ms - 592[0m
[0mPUT /api/zakat/payments/cmldqh1a5001x0gjxfztcz2px [33m401[0m 0.471 ms - 94[0m
stdout | src/__tests__/integration/admin-system.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 319.459 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 297.182 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 7.525 ms - 561[0m
[0mDELETE /api/zakat/payments/cmldqh1rv00220gjxgm65f6yl [32m200[0m 7.391 ms - 143[0m
[0mGET /api/zakat/payments/cmldqh1rv00220gjxgm65f6yl [33m404[0m 3.015 ms - 183[0m
[0mPOST /api/auth/register [32m201[0m 342.042 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 310.385 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 298.810 ms - -[0m
[0mGET /api/admin/system/status [32m200[0m 25.867 ms - 304[0m
[0mGET /api/admin/system/status/schema [32m200[0m 3.159 ms - 214[0m
[0mPOST /api/auth/login [32m200[0m 305.793 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 7.291 ms - 561[0m
[0mDELETE /api/zakat/payments/non-existent-id [33m404[0m 1.478 ms - 161[0m
[0mPOST /api/auth/register [32m201[0m 311.985 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 312.403 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 297.517 ms - -[0m
[0mGET /api/admin/system/status [33m403[0m 1.865 ms - 95[0m
 â¯ src/__tests__/integration/admin-system.test.ts (3 tests | 1 failed) 1349ms
   âœ“ Admin System API > GET /api/admin/system/status returns system status 31ms
   Ã— Admin System API > GET /api/admin/system/status/schema returns detailed schema info 13ms
     â†’ expected false to be true // Object.is equality
   âœ“ Admin System API > GET /api/admin/system/status requires admin privileges  622ms
stdout | tests/integration/invalidOperations.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4fcad81c94115b66.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4fcad81c94115b66.db

[0mPOST /api/auth/login [32m200[0m 320.490 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 7.182 ms - 561[0m
[0mDELETE /api/zakat/payments/cmldqh2s5002c0gjxnryfvs4s [33m401[0m 0.302 ms - 94[0m
[0mPOST /api/auth/register [32m201[0m 327.475 ms - -[0m
stdout | tests/integration/invalidOperations.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 314.016 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 17.620 ms - 596[0m
[0mPOST /api/zakat/payments [32m201[0m 9.030 ms - 562[0m
[0mPOST /api/auth/register [32m201[0m 311.972 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 306.235 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 6.896 ms - 596[0m
[0mPOST /api/zakat/payments [32m201[0m 6.403 ms - 562[0m
[0mGET /api/zakat/receipts/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwYXltZW50SWQiOiJjbWxkcWgzc3gwMDJxMGdqeHV1NWxhMHExIiwidXNlcklkIjoiY21sZHFoM2poMDAyazBnanhyYmlleGlkeiIsImlhdCI6MTc3MDU1NDU2NywiZXhwIjoxODAyMTEyMTY3fQ.h76gqvH50kfGIwbm7Q-KXVRGPJFHS3fKJ0xP24dV9Yw [32m200[0m 2.069 ms - 249[0m
 â¯ ../tests/contract/payment-records.contract.test.ts (17 tests | 2 failed) 11488ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should create new payment record with valid data  818ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should create payment record with minimal data  714ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should return 400 for invalid amount  710ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should return 400 for missing required fields  641ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should return 401 for unauthorized request  638ms
   âœ“ Payment Records Contract Tests > GET /api/zakat/payments > should return paginated list of payments  699ms
   âœ“ Payment Records Contract Tests > GET /api/zakat/payments > should filter payments by year  685ms
   âœ“ Payment Records Contract Tests > GET /api/zakat/payments > should support pagination  658ms
   âœ“ Payment Records Contract Tests > GET /api/zakat/payments > should return 401 for unauthorized request  697ms
   âœ“ Payment Records Contract Tests > PUT /api/zakat/payments/:id > should update payment record  665ms
   âœ“ Payment Records Contract Tests > PUT /api/zakat/payments/:id > should return 404 for non-existent payment  659ms
   âœ“ Payment Records Contract Tests > PUT /api/zakat/payments/:id > should return 401 for unauthorized request  636ms
   Ã— Payment Records Contract Tests > DELETE /api/zakat/payments/:id > should soft delete payment record 651ms
     â†’ expected undefined to be false // Object.is equality
   âœ“ Payment Records Contract Tests > DELETE /api/zakat/payments/:id > should return 404 for non-existent payment  636ms
   âœ“ Payment Records Contract Tests > DELETE /api/zakat/payments/:id > should return 401 for unauthorized request  653ms
   Ã— Payment Records Contract Tests > Receipt URL Generation > should generate valid receipt URL 680ms
     â†’ expected '/api/zakat/receipts/eyJhbGciOiJIUzI1Nâ€¦' to match /^\/api\/receipts\//api\
   âœ“ Payment Records Contract Tests > Receipt URL Generation > should allow access to receipt via generated URL  645ms
stdout | tests/integration/unlockEdit.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-92236e39911894f4.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-92236e39911894f4.db

stdout | tests/integration/invalidOperations.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/unlockEdit.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 368.542 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 318.642 ms - -[0m
[0mGET /api/nisab-year-records [33m401[0m 0.842 ms - 94[0m
[0mGET /api/nisab-year-records [33m401[0m 1.073 ms - 91[0m
[0mGET /api/nisab-year-records [33m401[0m 1.746 ms - 91[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from accessing another user's records
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from accessing another user's records
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4sm00060gpw4b1hye2j 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from accessing another user's records
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4sm00060gpw4b1hye2j for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 23.684 ms - 805[0m
[0mGET /api/nisab-year-records/cmldqh4sm00060gpw4b1hye2j [33m404[0m 6.077 ms - 66[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from modifying another user's records
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from modifying another user's records
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4to00090gpw0l68yfn4 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from modifying another user's records
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4to00090gpw0l68yfn4 for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 16.986 ms - 803[0m
[0mPUT /api/nisab-year-records/cmldqh4to00090gpw0l68yfn4 [33m404[0m 3.287 ms - 66[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from deleting another user's records
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from deleting another user's records
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4uh000c0gpwa28no3vy 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from deleting another user's records
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4uh000c0gpwa28no3vy for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 19.273 ms - 803[0m
[0mDELETE /api/nisab-year-records/cmldqh4uh000c0gpwa28no3vy [33m404[0m 2.623 ms - 66[0m
[0mPOST /api/nisab-year-records [33m400[0m 0.833 ms - 82[0m
[0mPOST /api/nisab-year-records [33m400[0m 0.969 ms - 90[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid Hawl completion date (not 354 days)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid Hawl completion date (not 354 days)
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4vh000f0gpwp8y5kusu 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid Hawl completion date (not 354 days)
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4vh000f0gpwp8y5kusu for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 19.008 ms - 806[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject negative wealth values
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject negative wealth values
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4w1000i0gpw68fl6pfx 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject negative wealth values
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4w1000i0gpw68fl6pfx for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 16.614 ms - 805[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject Zakat amount not equal to 2.5% of zakatable wealth
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject Zakat amount not equal to 2.5% of zakatable wealth
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4wm000l0gpwszkpvut5 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject Zakat amount not equal to 2.5% of zakatable wealth
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4wm000l0gpwszkpvut5 for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 17.106 ms - 805[0m
[0mGET /api/nisab-year-records/nonexistent_id_12345 [33m404[0m 2.224 ms - 66[0m
[0mPOST /api/nisab-year-records/fake_id/finalize [33m404[0m 2.855 ms - 66[0m
[0mPOST /api/nisab-year-records/fake_id/unlock [33m400[0m 0.957 ms - 81[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject finalization before Hawl completion without override
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject finalization before Hawl completion without override
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4xi000o0gpws3pgc7rx 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject finalization before Hawl completion without override
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4xi000o0gpws3pgc7rx for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 16.343 ms - 805[0m
[0mPOST /api/nisab-year-records/cmldqh4xi000o0gpws3pgc7rx/finalize [33m409[0m 4.161 ms - 115[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4y9000r0gpw19kra1s3 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4y9000r0gpw19kra1s3 for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 17.130 ms - 805[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh4y9000r0gpw19kra1s3 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh4y9000r0gpw19kra1s3 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh4y9000r0gpw19kra1s3/finalize [32m200[0m 17.367 ms - 821[0m
[0mPOST /api/nisab-year-records/cmldqh4y9000r0gpw19kra1s3/unlock [33m400[0m 0.775 ms - 81[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh4zi000w0gpwq66y9vgu 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh4zi000w0gpwq66y9vgu for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 16.638 ms - 803[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh4zi000w0gpwq66y9vgu 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh4zi000w0gpwq66y9vgu with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh4zi000w0gpwq66y9vgu/finalize [32m200[0m 15.587 ms - 821[0m
[0mPOST /api/nisab-year-records/cmldqh4zi000w0gpwq66y9vgu/unlock [33m400[0m 0.661 ms - 81[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Edge Cases > should handle very large wealth values
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Edge Cases > should handle very large wealth values
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh50m00110gpw8bkesepd 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Edge Cases > should handle very large wealth values
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh50m00110gpw8bkesepd for user cmldqh4hp00000gpwne4ov7al 

[0mPOST /api/nisab-year-records [32m201[0m 15.424 ms - 831[0m
[0mPOST /api/nisab-year-records [33m400[0m 3.004 ms - 145[0m
[0mPOST /api/nisab-year-records [31m500[0m 3.670 ms - 49[0m
 â¯ tests/integration/invalidOperations.test.ts (20 tests | 11 failed) 1077ms
   âœ“ Integration: Invalid Operations and Error Handling > Authentication Errors > should reject requests without auth token 7ms
   âœ“ Integration: Invalid Operations and Error Handling > Authentication Errors > should reject requests with invalid token 4ms
   âœ“ Integration: Invalid Operations and Error Handling > Authentication Errors > should reject requests with expired token 6ms
   Ã— Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from accessing another user's records 42ms
     â†’ expected 404 to be 403 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from modifying another user's records 27ms
     â†’ expected 404 to be 403 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from deleting another user's records 29ms
     â†’ expected 404 to be 403 // Object.is equality
   âœ“ Integration: Invalid Operations and Error Handling > Validation Errors > should reject creation with missing required fields 3ms
   âœ“ Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid nisabBasis value 4ms
   Ã— Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid Hawl completion date (not 354 days) 22ms
     â†’ expected 201 to be 400 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Validation Errors > should reject negative wealth values 20ms
     â†’ expected 201 to be 400 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Validation Errors > should reject Zakat amount not equal to 2.5% of zakatable wealth 20ms
     â†’ expected 201 to be 400 // Object.is equality
   âœ“ Integration: Invalid Operations and Error Handling > Not Found Errors > should return 404 for non-existent record 5ms
   Ã— Integration: Invalid Operations and Error Handling > Not Found Errors > should return 400 when finalizing non-existent record 6ms
     â†’ expected 404 to be 400 // Object.is equality
   âœ“ Integration: Invalid Operations and Error Handling > Not Found Errors > should return 400 when unlocking non-existent record 3ms
   Ã— Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject finalization before Hawl completion without override 25ms
     â†’ expected 409 to be 400 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason 44ms
     â†’ expected 'unlockReason is required' to contain 'reason'
   Ã— Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short 42ms
     â†’ expected 'unlockReason is required' to contain '10 characters'
   âœ“ Integration: Invalid Operations and Error Handling > Edge Cases > should handle very large wealth values 18ms
   Ã— Integration: Invalid Operations and Error Handling > Edge Cases > should handle concurrent edits to same record 5ms
     â†’ Cannot read properties of undefined (reading 'id')
   âœ“ Integration: Invalid Operations and Error Handling > Edge Cases > should handle malformed JSON in request body 7ms
stdout | tests/integration/statusTransitions.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-87bf21674d0f492c.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-87bf21674d0f492c.db

stdout | tests/integration/unlockEdit.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/statusTransitions.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 374.088 ms - -[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh5ul00030gqnieq47bzv 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh5ul00030gqnieq47bzv for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 25.283 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
CREATE RESPONSE STATUS: [33m201[39m
CREATE RESPONSE BODY: {
  "success": true,
  "data": {
    "id": "cmldqh5ul00030gqnieq47bzv",
    "userId": "cmldqh5t500000gqnzqr6nftx",
    "hawlStartDate": "2025-02-08T12:42:50.194Z",
    "hawlStartDateHijri": "1444-06-08",
    "hawlCompletionDate": "2026-01-29T12:42:50.194Z",
    "hawlCompletionDateHijri": "1445-06-08",
    "nisabThresholdAtStart": 0,
    "nisabBasis": "GOLD",
    "totalWealth": 10000,
    "totalLiabilities": 0,
    "zakatableWealth": 10000,
    "zakatAmount": 250,
    "methodologyUsed": "standard",
    "assetBreakdown": "IOqJCrrhJiXki6Oa:upE=:U35wRxoAgO16+TT629ux9w==",
    "calculationDetails": "{}",
    "status": "DRAFT",
    "finalizedAt": null,
    "userNotes": null,
    "calculationDate": "2026-02-08T12:42:50.204Z",
    "gregorianYear": 2026,
    "gregorianMonth": 2,
    "gregorianDay": 8,
    "hijriYear": 1444,
    "hijriMonth": 6,
    "hijriDay": 8,
    "isPrimary": false,
    "createdAt": "2026-02-08T12:42:50.205Z",
    "updatedAt": "2026-02-08T12:42:50.205Z"
  }
}

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh5ul00030gqnieq47bzv 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh5ul00030gqnieq47bzv with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh5ul00030gqnieq47bzv/finalize [32m200[0m 24.092 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh5ul00030gqnieq47bzv 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh5ul00030gqnieq47bzv with reason: Need to correct asse... 

[0mPOST /api/nisab-year-records/cmldqh5ul00030gqnieq47bzv/unlock [32m200[0m 15.610 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh5x0000a0gqn9nuk35ke 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh5x0000a0gqn9nuk35ke for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 16.089 ms - 803[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh5x0000a0gqn9nuk35ke 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh5x0000a0gqn9nuk35ke with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh5x0000a0gqn9nuk35ke/finalize [32m200[0m 16.622 ms - 821[0m
[0mPOST /api/nisab-year-records/cmldqh5x0000a0gqn9nuk35ke/unlock [33m400[0m 1.092 ms - 100[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh5yj000f0gqna44ausem 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh5yj000f0gqna44ausem for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 16.879 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh5yj000f0gqna44ausem 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh5yj000f0gqna44ausem with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh5yj000f0gqna44ausem/finalize [32m200[0m 14.790 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh5yj000f0gqna44ausem 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh5yj000f0gqna44ausem with reason: Correcting asset val... 

[0mPOST /api/nisab-year-records/cmldqh5yj000f0gqna44ausem/unlock [32m200[0m 15.579 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqh5yj000f0gqna44ausem 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqh5yj000f0gqna44ausem 

[0mPUT /api/nisab-year-records/cmldqh5yj000f0gqna44ausem [32m200[0m 17.862 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh619000o0gqn1btawgeg 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh619000o0gqn1btawgeg for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 18.123 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh619000o0gqn1btawgeg 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh619000o0gqn1btawgeg with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh619000o0gqn1btawgeg/finalize [32m200[0m 15.051 ms - 823[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh619000o0gqn1btawgeg 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh619000o0gqn1btawgeg with reason: Discovered missing l... 

[0mPOST /api/nisab-year-records/cmldqh619000o0gqn1btawgeg/unlock [32m200[0m 15.254 ms - 822[0m
[0mGET /api/nisab-year-records/cmldqh619000o0gqn1btawgeg/audit [32m200[0m 6.583 ms - -[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh63k000v0gqnbd7br7ai 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh63k000v0gqnbd7br7ai for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 18.731 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh63k000v0gqnbd7br7ai 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh63k000v0gqnbd7br7ai with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh63k000v0gqnbd7br7ai/finalize [32m200[0m 18.419 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh63k000v0gqnbd7br7ai 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh63k000v0gqnbd7br7ai with reason: Correcting calculati... 

[0mPOST /api/nisab-year-records/cmldqh63k000v0gqnbd7br7ai/unlock [32m200[0m 14.095 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqh63k000v0gqnbd7br7ai 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqh63k000v0gqnbd7br7ai 

[0mPUT /api/nisab-year-records/cmldqh63k000v0gqnbd7br7ai [32m200[0m 14.528 ms - 820[0m
[0mGET /api/nisab-year-records/cmldqh63k000v0gqnbd7br7ai/audit [32m200[0m 4.449 ms - -[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh66400140gqnxp88ol3v 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh66400140gqnxp88ol3v for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 15.358 ms - 803[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh66400140gqnxp88ol3v 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh66400140gqnxp88ol3v with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh66400140gqnxp88ol3v/finalize [32m200[0m 16.109 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh66400140gqnxp88ol3v 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh66400140gqnxp88ol3v with reason: Correcting valuation... 

[0mPOST /api/nisab-year-records/cmldqh66400140gqnxp88ol3v/unlock [32m200[0m 13.506 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqh66400140gqnxp88ol3v 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqh66400140gqnxp88ol3v 

[0mPUT /api/nisab-year-records/cmldqh66400140gqnxp88ol3v [32m200[0m 14.758 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh66400140gqnxp88ol3v 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh66400140gqnxp88ol3v with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh66400140gqnxp88ol3v/finalize [32m200[0m 14.197 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh68u001f0gqn40hivtn7 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh68u001f0gqn40hivtn7 for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 16.413 ms - 803[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh68u001f0gqn40hivtn7 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh68u001f0gqn40hivtn7 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh68u001f0gqn40hivtn7/finalize [32m200[0m 14.491 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh68u001f0gqn40hivtn7 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh68u001f0gqn40hivtn7 with reason: Fixing data entry mi... 

[0mPOST /api/nisab-year-records/cmldqh68u001f0gqn40hivtn7/unlock [32m200[0m 15.685 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqh68u001f0gqn40hivtn7 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqh68u001f0gqn40hivtn7 

[0mPUT /api/nisab-year-records/cmldqh68u001f0gqn40hivtn7 [32m200[0m 15.529 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh68u001f0gqn40hivtn7 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh68u001f0gqn40hivtn7 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh68u001f0gqn40hivtn7/finalize [32m200[0m 15.228 ms - 821[0m
[0mGET /api/nisab-year-records/cmldqh68u001f0gqn40hivtn7/audit [32m200[0m 3.881 ms - -[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should NOT allow unlocking DRAFT record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should NOT allow unlocking DRAFT record
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh6bw001q0gqnv1bl4k4h 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should NOT allow unlocking DRAFT record
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh6bw001q0gqnv1bl4k4h for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 17.469 ms - 804[0m
[0mPOST /api/nisab-year-records/cmldqh6bw001q0gqnv1bl4k4h/unlock [33m409[0m 6.393 ms - 90[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh6d0001t0gqn9mkiluvd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh6d0001t0gqn9mkiluvd for user cmldqh5t500000gqnzqr6nftx 

[0mPOST /api/nisab-year-records [32m201[0m 19.802 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh6d0001t0gqn9mkiluvd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh6d0001t0gqn9mkiluvd with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh6d0001t0gqn9mkiluvd/finalize [32m200[0m 16.657 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh6d0001t0gqn9mkiluvd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh6d0001t0gqn9mkiluvd with reason: Correcting error due... 

[0mPOST /api/nisab-year-records/cmldqh6d0001t0gqn9mkiluvd/unlock [32m200[0m 13.764 ms - 820[0m
[0mGET /api/nisab-year-records/cmldqh6d0001t0gqn9mkiluvd/audit [32m200[0m 3.939 ms - -[0m
 â¯ tests/integration/unlockEdit.test.ts (9 tests | 1 failed) 1154ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason 93ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters 55ms
   Ã— Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record 96ms
     â†’ expected +0 to be 12000 // Object.is equality
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason 81ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary 96ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit 99ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail 108ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should NOT allow unlocking DRAFT record 42ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail 75ms
stdout | tests/integration/finalization.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a30c0e84b8b6b860.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a30c0e84b8b6b860.db

stdout | tests/integration/statusTransitions.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/finalization.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 364.926 ms - -[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh74j00030grfsfthyra9 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh74j00030grfsfthyra9 for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 25.241 ms - 805[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh74j00030grfsfthyra9 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh74j00030grfsfthyra9 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh74j00030grfsfthyra9/finalize [32m200[0m 24.461 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh76300080grf0ghgan6c 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh76300080grf0ghgan6c for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 25.080 ms - 803[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh76300080grf0ghgan6c 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh76300080grf0ghgan6c with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh76300080grf0ghgan6c/finalize [32m200[0m 17.307 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh76300080grf0ghgan6c 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh76300080grf0ghgan6c with reason: Valid reason for unl... 

[0mPOST /api/nisab-year-records/cmldqh76300080grf0ghgan6c/unlock [32m200[0m 15.972 ms - 820[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh77x000f0grflv9h2n93 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh77x000f0grflv9h2n93 for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 15.587 ms - 803[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh77x000f0grflv9h2n93 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh77x000f0grflv9h2n93 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh77x000f0grflv9h2n93/finalize [32m200[0m 14.856 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh77x000f0grflv9h2n93 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh77x000f0grflv9h2n93 with reason: Unlocking for necess... 

[0mPOST /api/nisab-year-records/cmldqh77x000f0grflv9h2n93/unlock [32m200[0m 13.717 ms - 820[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh77x000f0grflv9h2n93 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh77x000f0grflv9h2n93 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh77x000f0grflv9h2n93/finalize [32m200[0m 17.625 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow DRAFT â†’ UNLOCKED transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow DRAFT â†’ UNLOCKED transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh79z000o0grflwrfhjeo 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow DRAFT â†’ UNLOCKED transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh79z000o0grflwrfhjeo for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 15.513 ms - 803[0m
[0mPOST /api/nisab-year-records/cmldqh79z000o0grflwrfhjeo/unlock [33m409[0m 5.908 ms - 90[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh7ar000r0grfz037iqxk 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh7ar000r0grfz037iqxk for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 16.143 ms - 803[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh7ar000r0grfz037iqxk 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh7ar000r0grfz037iqxk with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh7ar000r0grfz037iqxk/finalize [32m200[0m 14.980 ms - 821[0m
[0mPUT /api/nisab-year-records/cmldqh7ar000r0grfz037iqxk [33m400[0m 1.174 ms - 113[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh7bv000w0grfrdp5n48g 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh7bv000w0grfrdp5n48g for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 15.997 ms - 805[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh7bv000w0grfrdp5n48g 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh7bv000w0grfrdp5n48g with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh7bv000w0grfrdp5n48g/finalize [32m200[0m 15.063 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh7bv000w0grfrdp5n48g 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh7bv000w0grfrdp5n48g with reason: Unlocking for correc... 

[0mPOST /api/nisab-year-records/cmldqh7bv000w0grfrdp5n48g/unlock [32m200[0m 13.561 ms - 820[0m
[0mPUT /api/nisab-year-records/cmldqh7bv000w0grfrdp5n48g [33m400[0m 0.693 ms - 113[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow direct status field updates
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow direct status field updates
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh7dc00130grfds341tw5 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow direct status field updates
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh7dc00130grfds341tw5 for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 15.152 ms - 805[0m
[0mPUT /api/nisab-year-records/cmldqh7dc00130grfds341tw5 [33m400[0m 0.754 ms - 113[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh7dy00160grfb4qhmb3l 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh7dy00160grfb4qhmb3l for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 16.875 ms - 805[0m
[0mGET /api/nisab-year-records/cmldqh7dy00160grfb4qhmb3l [32m200[0m 4.849 ms - 1013[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh7dy00160grfb4qhmb3l 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh7dy00160grfb4qhmb3l with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh7dy00160grfb4qhmb3l/finalize [32m200[0m 14.796 ms - 821[0m
[0mGET /api/nisab-year-records/cmldqh7dy00160grfb4qhmb3l [32m200[0m 2.034 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqh7dy00160grfb4qhmb3l 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqh7dy00160grfb4qhmb3l with reason: Correction needed af... 

[0mPOST /api/nisab-year-records/cmldqh7dy00160grfb4qhmb3l/unlock [32m200[0m 13.641 ms - 820[0m
[0mGET /api/nisab-year-records/cmldqh7dy00160grfb4qhmb3l [32m200[0m 2.226 ms - 820[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh7fu001d0grfpooos12q 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh7fu001d0grfpooos12q for user cmldqh73400000grf3q4m4txn 

[0mPOST /api/nisab-year-records [32m201[0m 18.069 ms - 805[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh7fu001d0grfpooos12q 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh7fu001d0grfpooos12q with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh7fu001d0grfpooos12q/finalize [32m200[0m 18.930 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh7fu001d0grfpooos12q 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh7fu001d0grfpooos12q with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh7fu001d0grfpooos12q/finalize [32m200[0m 36.007 ms - 821[0m
 â¯ tests/integration/statusTransitions.test.ts (9 tests | 1 failed) 876ms
   âœ“ Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition 60ms
   âœ“ Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition 69ms
   âœ“ Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization) 73ms
   âœ“ Integration: Status Transition Validation > Invalid Transitions > should NOT allow DRAFT â†’ UNLOCKED transition 28ms
   âœ“ Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition 40ms
   âœ“ Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition 54ms
   âœ“ Integration: Status Transition Validation > Invalid Transitions > should NOT allow direct status field updates 21ms
   âœ“ Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations 67ms
   Ã— Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes 64ms
     â†’ expected 0 to be greater than or equal to 1
stdout | src/__tests__/integration/encryption-admin.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-75a6e002f667098a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-75a6e002f667098a.db

stdout | tests/integration/finalization.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/encryption-admin.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 350.044 ms - -[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh8gg00030gs8ll00s8gi 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh8gg00030gs8ll00s8gi for user cmldqh8f300000gs8sd8ipupf 

[0mPOST /api/nisab-year-records [32m201[0m 24.809 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh8gg00030gs8ll00s8gi 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh8gg00030gs8ll00s8gi with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh8gg00030gs8ll00s8gi/finalize [32m200[0m 23.073 ms - 821[0m
[0mPUT /api/nisab-year-records/cmldqh8gg00030gs8ll00s8gi [33m409[0m 6.919 ms - 94[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT finalize before Hawl completion date without override
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT finalize before Hawl completion date without override
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh8ib00080gs8guer8x07 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT finalize before Hawl completion date without override
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh8ib00080gs8guer8x07 for user cmldqh8f300000gs8sd8ipupf 

[0mPOST /api/nisab-year-records [32m201[0m 17.419 ms - 803[0m
[0mPOST /api/nisab-year-records/cmldqh8ib00080gs8guer8x07/finalize [33m409[0m 2.630 ms - 115[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should allow early finalization with override flag
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should allow early finalization with override flag
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh8jg000b0gs8sxnhjqgp 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should allow early finalization with override flag
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh8jg000b0gs8sxnhjqgp for user cmldqh8f300000gs8sd8ipupf 

[0mPOST /api/nisab-year-records [32m201[0m 26.807 ms - 805[0m
[0mPOST /api/nisab-year-records/cmldqh8jg000b0gs8sxnhjqgp/finalize [33m409[0m 2.945 ms - 115[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh8km000e0gs8qd026i0k 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh8km000e0gs8qd026i0k for user cmldqh8f300000gs8sd8ipupf 

[0mPOST /api/nisab-year-records [32m201[0m 30.806 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh8km000e0gs8qd026i0k 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh8km000e0gs8qd026i0k with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh8km000e0gs8qd026i0k/finalize [32m200[0m 15.180 ms - 821[0m
[0mGET /api/nisab-year-records/cmldqh8km000e0gs8qd026i0k/audit-trail [33m404[0m 2.364 ms - 199[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh8m2000j0gs86iisms3h 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh8m2000j0gs86iisms3h for user cmldqh8f300000gs8sd8ipupf 

[0mPOST /api/nisab-year-records [32m201[0m 17.972 ms - 803[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh8m2000j0gs86iisms3h 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh8m2000j0gs86iisms3h with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh8m2000j0gs86iisms3h/finalize [32m200[0m 18.008 ms - 821[0m
[0mDELETE /api/nisab-year-records/cmldqh8m2000j0gs86iisms3h [33m409[0m 2.858 ms - 137[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh8nc000o0gs8wlu3jo1t 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh8nc000o0gs8wlu3jo1t for user cmldqh8f300000gs8sd8ipupf 

[0mPOST /api/nisab-year-records [32m201[0m 17.965 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh8nc000o0gs8wlu3jo1t 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh8nc000o0gs8wlu3jo1t with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh8nc000o0gs8wlu3jo1t/finalize [32m200[0m 16.109 ms - 821[0m
[0mGET /api/nisab-year-records/cmldqh8nc000o0gs8wlu3jo1t [32m200[0m 2.460 ms - 821[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh8ok000t0gs84x8fpwf9 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh8ok000t0gs84x8fpwf9 for user cmldqh8f300000gs8sd8ipupf 

[0mPOST /api/nisab-year-records [32m201[0m 16.751 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh8ok000t0gs84x8fpwf9 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh8ok000t0gs84x8fpwf9 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh8ok000t0gs84x8fpwf9/finalize [32m200[0m 16.438 ms - 821[0m
[0mPOST /api/nisab-year-records/cmldqh8ok000t0gs84x8fpwf9/finalize [33m409[0m 3.898 ms - 96[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqh8pr000y0gs8urfdwjkv 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqh8pr000y0gs8urfdwjkv for user cmldqh8f300000gs8sd8ipupf 

[0mPOST /api/nisab-year-records [32m201[0m 15.762 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqh8pr000y0gs8urfdwjkv 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqh8pr000y0gs8urfdwjkv with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqh8pr000y0gs8urfdwjkv/finalize [32m200[0m 14.914 ms - 821[0m
 â¯ tests/integration/finalization.test.ts (8 tests | 7 failed) 762ms
   Ã— Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date 74ms
     â†’ expected 409 to be 403 // Object.is equality
   Ã— Integration: Finalization Workflow > should NOT finalize before Hawl completion date without override 31ms
     â†’ expected 409 to be 400 // Object.is equality
   Ã— Integration: Finalization Workflow > should allow early finalization with override flag 45ms
     â†’ expected 409 to be 200 // Object.is equality
   Ã— Integration: Finalization Workflow > should record FINALIZED event in audit trail 58ms
     â†’ expected 404 to be 200 // Object.is equality
   Ã— Integration: Finalization Workflow > should prevent deletion of FINALIZED record 46ms
     â†’ expected 409 to be 403 // Object.is equality
   Ã— Integration: Finalization Workflow > should lock all financial values on finalization 44ms
     â†’ expected +0 to be 11000 // Object.is equality
   Ã— Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record 44ms
     â†’ expected 409 to be 400 // Object.is equality
   âœ“ Integration: Finalization Workflow > should include finalizedAt timestamp 35ms
stdout | tests/integration/hawlDetection.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9becfc064cab352e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9becfc064cab352e.db

stdout | src/__tests__/integration/encryption-admin.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetection.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 365.790 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 301.399 ms - -[0m
[0mPOST /api/admin/encryption/scan [32m200[0m 7.794 ms - 28[0m
[0mGET /api/admin/encryption/issues [32m200[0m 2.704 ms - 28[0m
 â¯ src/__tests__/integration/encryption-admin.test.ts (2 tests | 2 failed) 753ms
   Ã— Admin Encryption Remediation API > scan creates remediation for prev-key encrypted payment 16ms
     â†’ expected 0 to be greater than or equal to 1
   Ã— Admin Encryption Remediation API > retry with correct previous key resolves remediation and re-encrypts 8ms
     â†’ expected undefined to be truthy
stdout | ../tests/unit/EncryptionService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-583be6f396a4f149.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-583be6f396a4f149.db

 â¯ ../tests/unit/EncryptionService.test.ts (29 tests | 5 failed) 307ms
   âœ“ Implementation Task T023: EncryptionService > Core Encryption/Decryption > should encrypt and decrypt data successfully 4ms
   âœ“ Implementation Task T023: EncryptionService > Core Encryption/Decryption > should generate different encrypted values for the same plaintext 1ms
   Ã— Implementation Task T023: EncryptionService > Core Encryption/Decryption > should throw error for empty plaintext 9ms
     â†’ promise resolved "'hFbk2dLc12vsw4Vm::hc0rRb8N2g7Xy/ojmXTâ€¦'" instead of rejecting
   Ã— Implementation Task T023: EncryptionService > Core Encryption/Decryption > should throw error for empty key 1ms
     â†’ You must provide a Promise to expect() when using .rejects, not 'object'.
   âœ“ Implementation Task T023: EncryptionService > Core Encryption/Decryption > should throw error for invalid encrypted data format 1ms
   âœ“ Implementation Task T023: EncryptionService > Object Encryption/Decryption > should encrypt and decrypt objects successfully 1ms
   âœ“ Implementation Task T023: EncryptionService > Object Encryption/Decryption > should handle complex nested objects 1ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should generate secure random keys 0ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should derive keys from passwords using PBKDF2 141ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should generate different keys for different salts 128ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should generate cryptographically secure salts 0ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should reject empty password for key derivation 0ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should reject empty salt for key derivation 0ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should create consistent SHA-256 hashes 1ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should create different hashes for different data 0ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should verify hashes correctly 0ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should handle empty data in hash verification 0ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should throw error for empty data hashing 0ms
   âœ“ Implementation Task T023: EncryptionService > Islamic Compliance Features > should encrypt asset data with integrity checks 1ms
   Ã— Implementation Task T023: EncryptionService > Islamic Compliance Features > should validate asset data integrity 4ms
     â†’ promise resolved "{ type: 'gold', value: 50000, â€¦(2) }" instead of rejecting
   âœ“ Implementation Task T023: EncryptionService > Islamic Compliance Features > should include timestamp in encrypted asset data 1ms
   âœ“ Implementation Task T023: EncryptionService > Security Features > should detect encrypted data format 1ms
   âœ“ Implementation Task T023: EncryptionService > Security Features > should normalize keys correctly 0ms
   Ã— Implementation Task T023: EncryptionService > Security Features > should validate encryption configuration 4ms
     â†’ expected false to be true // Object.is equality
   âœ“ Implementation Task T023: EncryptionService > Security Features > should handle key length variations 1ms
   Ã— Implementation Task T023: EncryptionService > Error Handling > should provide meaningful error messages 1ms
     â†’ promise resolved "'z6JBXSXAy1GiCSGL::A4JS+G9GGiRFbBq3iI7â€¦'" instead of rejecting
   âœ“ Implementation Task T023: EncryptionService > Error Handling > should handle malformed encrypted data gracefully 1ms
   âœ“ Implementation Task T023: EncryptionService > Performance and Scalability > should handle large data encryption efficiently 1ms
   âœ“ Implementation Task T023: EncryptionService > Performance and Scalability > should handle multiple concurrent encryptions 1ms
stdout | tests/integration/hawlDetection.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlInterruption.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c97e863e248d4b56.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c97e863e248d4b56.db

[0mPOST /api/auth/register [32m201[0m 364.359 ms - -[0m
[0mPOST /api/assets [32m201[0m 13.594 ms - 506[0m
[0mGET /api/nisab-year-records/status [32m200[0m 5.679 ms - 16[0m
[0mPOST /api/assets [32m201[0m 8.863 ms - 504[0m
[0mGET /api/nisab-year-records/status [32m200[0m 4.200 ms - 16[0m
[0mPOST /api/assets [32m201[0m 9.087 ms - 498[0m
[0mGET /api/nisab-year-records/status [32m200[0m 3.281 ms - 16[0m
[0mPOST /api/assets [32m201[0m 9.977 ms - 502[0m
[0mGET /api/nisab-year-records/status [32m200[0m 3.003 ms - 16[0m
[0mPOST /api/assets [32m201[0m 9.149 ms - 496[0m
[0mGET /api/nisab-year-records/status [32m200[0m 2.698 ms - 16[0m
[0mGET /api/nisab-year-records/undefined [33m404[0m 4.678 ms - 66[0m
[0mPOST /api/assets [32m201[0m 10.735 ms - 498[0m
[0mGET /api/nisab-year-records/status [32m200[0m 2.184 ms - 16[0m
[0mPOST /api/assets [32m201[0m 9.564 ms - 495[0m
[0mGET /api/nisab-year-records/status [32m200[0m 2.496 ms - 16[0m
[0mGET /api/nisab-year-records/undefined [33m404[0m 2.253 ms - 66[0m
stdout | tests/integration/hawlInterruption.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 â¯ tests/integration/hawlDetection.test.ts (6 tests | 6 failed) 610ms
   Ã— Integration: Nisab Achievement Detection > should detect Nisab achievement and create DRAFT record 60ms
     â†’ expected false to be true // Object.is equality
   Ã— Integration: Nisab Achievement Detection > should not create duplicate Hawl if active DRAFT exists 34ms
     â†’ expected false to be true // Object.is equality
   Ã— Integration: Nisab Achievement Detection > should use gold-based Nisab if gold threshold is lower 26ms
     â†’ expected false to be true // Object.is equality
   Ã— Integration: Nisab Achievement Detection > should lock Nisab threshold value at Hawl start 31ms
     â†’ expected undefined to be defined
   Ã— Integration: Nisab Achievement Detection > should calculate Hawl completion date as 354 days from start 27ms
     â†’ expected NaN to be 354 // Object.is equality
   Ã— Integration: Nisab Achievement Detection > should include Hijri date equivalents 30ms
     â†’ .toMatch() expects to receive a string, but got undefined
stdout | tests/contract/nisabYearRecords.post.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3336b26501f472d1.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3336b26501f472d1.db

 â¯ tests/integration/liveTracking.test.ts (8 tests | 6 failed) 21168ms
   âœ“ Integration: Live Wealth Tracking > should update DRAFT record when asset is added 39ms
   Ã— Integration: Live Wealth Tracking > should update DRAFT record when asset value is modified 8ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Integration: Live Wealth Tracking > should update DRAFT record when asset is deleted 19ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Integration: Live Wealth Tracking > should recalculate Zakat amount when wealth changes 30ms
     â†’ expected NaN to be close to NaN, received difference is NaN, but expected 0.005
   âœ“ Integration: Live Wealth Tracking > should handle non-zakatable assets correctly 26ms
   Ã— Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation) 5002ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Integration: Live Wealth Tracking > should provide asset breakdown by category 544ms
     â†’ expected undefined to be defined
   Ã— Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation 5002ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
stdout | ../tests/contract/nisabYearRecords.get.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-802946d9cc763123.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-802946d9cc763123.db

stdout | tests/contract/nisabYearRecords.post.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlInterruption.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.get.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 428.051 ms - -[0m
[0mPOST /api/assets [32m201[0m 16.489 ms - 506[0m
[0mPOST /api/assets [32m201[0m 10.620 ms - 495[0m
[0mGET /api/nisab-year-records/status [32m200[0m 5.100 ms - 16[0m
[0mGET /api/assets [32m200[0m 3.620 ms - 678[0m
[0mPOST /api/assets [32m201[0m 10.321 ms - 498[0m
[0mPOST /api/assets [32m201[0m 11.002 ms - 497[0m
[0mPOST /api/assets [32m201[0m 12.025 ms - 497[0m
[0mGET /api/nisab-year-records/status [32m200[0m 4.049 ms - 16[0m
[0mPOST /api/assets [32m201[0m 12.108 ms - 495[0m
[0mGET /api/nisab-year-records/status [32m200[0m 3.567 ms - 16[0m
[0mGET /api/assets [32m200[0m 3.352 ms - 678[0m
[0mPOST /api/assets [32m201[0m 11.513 ms - 498[0m
[0mGET /api/nisab-year-records/status [32m200[0m 2.677 ms - 16[0m
 â¯ tests/integration/hawlInterruption.test.ts (6 tests | 6 failed) 679ms
   Ã— Integration: Hawl Interruption > should detect Hawl interruption when wealth drops below Nisab 29ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Integration: Hawl Interruption > should archive interrupted DRAFT record 43ms
     â†’ Cannot read properties of undefined (reading '0')
   Ã— Integration: Hawl Interruption > should allow new Hawl to start after interruption if wealth rises again 21ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Integration: Hawl Interruption > should not interrupt if wealth temporarily fluctuates but stays above Nisab 53ms
     â†’ expected false to be true // Object.is equality
   Ã— Integration: Hawl Interruption > should record interruption in audit trail 35ms
     â†’ Cannot read properties of undefined (reading '0')
   Ã— Integration: Hawl Interruption > should clear Hawl completion date on interruption 28ms
     â†’ expected undefined to be defined
stdout | tests/contract/nisabYearRecords.post.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.put.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-779f542575053021.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-779f542575053021.db

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create DRAFT record with required fields
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create DRAFT record with required fields
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhcw100010gvz67th5q0y 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create DRAFT record with required fields
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhcw100010gvz67th5q0y for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 40.396 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create record with silver nisab basis
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create record with silver nisab basis
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhcx900040gvzsa96omb0 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create record with silver nisab basis
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhcx900040gvzsa96omb0 for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 24.135 ms - 797[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate nisabThresholdAtStart if not provided
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate nisabThresholdAtStart if not provided
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhcye00070gvzt2m6n6si 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate nisabThresholdAtStart if not provided
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhcye00070gvzt2m6n6si for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 31.351 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept user-provided nisabThresholdAtStart
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept user-provided nisabThresholdAtStart
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhczh000a0gvz38nir9ww 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept user-provided nisabThresholdAtStart
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhczh000a0gvz38nir9ww for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 17.223 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept optional userNotes field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept optional userNotes field
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhd0n000d0gvz1hh7vvkw 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept optional userNotes field
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhd0n000d0gvz1hh7vvkw for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 24.182 ms - 825[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate hawlCompletionDate (354 days after start)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate hawlCompletionDate (354 days after start)
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhd1j000g0gvz451egqll 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate hawlCompletionDate (354 days after start)
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhd1j000g0gvz451egqll for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 22.307 ms - 795[0m
[0mPOST /api/nisab-year-records [33m400[0m 4.093 ms - 82[0m
[0mPOST /api/nisab-year-records [33m400[0m 4.188 ms - 90[0m
[0mPOST /api/nisab-year-records [33m400[0m 1.193 ms - 90[0m
[0mPOST /api/nisab-year-records [33m400[0m 1.084 ms - 91[0m
[0mPOST /api/nisab-year-records [33m400[0m 0.971 ms - 97[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.596 ms - 94[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.847 ms - 91[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should create record with authenticated user ID
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should create record with authenticated user ID
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhd4r000j0gvzey6bob9x 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should create record with authenticated user ID
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhd4r000j0gvzey6bob9x for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 34.604 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should return correct response structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should return correct response structure
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhd5x000m0gvz7ge2rx1d 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should return correct response structure
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhd5x000m0gvz7ge2rx1d for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 20.536 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should include Hijri dates in response
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should include Hijri dates in response
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhd6r000p0gvz9owsjmh4 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should include Hijri dates in response
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhd6r000p0gvz9owsjmh4 for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 19.689 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should encrypt sensitive fields in database
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should encrypt sensitive fields in database
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhd7q000s0gvzq1nhha8r 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should encrypt sensitive fields in database
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhd7q000s0gvzq1nhha8r for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 26.927 ms - 795[0m
stdout | ../tests/contract/nisabYearRecords.get.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should set correct initial status to DRAFT
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should set correct initial status to DRAFT
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqhd8q000v0gvz0ihchhiz 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should set correct initial status to DRAFT
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqhd8q000v0gvz0ihchhiz for user cmldqhcum00000gvz270pqv9j 

[0mPOST /api/nisab-year-records [32m201[0m 23.695 ms - 795[0m
 â¯ tests/contract/nisabYearRecords.post.test.ts (18 tests | 2 failed) 551ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create DRAFT record with required fields 71ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create record with silver nisab basis 40ms
   Ã— POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate nisabThresholdAtStart if not provided 43ms
     â†’ expected 0 to be greater than 0
   Ã— POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept user-provided nisabThresholdAtStart 38ms
     â†’ expected +0 to be 5687.2 // Object.is equality
   âœ“ POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept optional userNotes field 34ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate hawlCompletionDate (354 days after start) 38ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when hawlStartDate is missing 11ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when nisabBasis is missing 8ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when nisabBasis is invalid 16ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when hawlStartDate is invalid format 11ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when nisabThresholdAtStart is negative 13ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should return 401 without auth token 11ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should return 401 with invalid token 6ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should create record with authenticated user ID 45ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should return correct response structure 30ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should include Hijri dates in response 30ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should encrypt sensitive fields in database 40ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should set correct initial status to DRAFT 33ms
[0mGET /api/nisab-year-records [32m200[0m 14.126 ms - 820[0m
[0mGET /api/nisab-year-records?status=DRAFT [32m200[0m 6.024 ms - 820[0m
[0mGET /api/nisab-year-records?year=2025 [32m200[0m 3.899 ms - 820[0m
[0mGET /api/nisab-year-records [33m401[0m 0.492 ms - 94[0m
[0mGET /api/nisab-year-records?status=FINALIZED&year=1900 [32m200[0m 3.929 ms - 86[0m
 â¯ ../tests/contract/nisabYearRecords.get.test.ts (5 tests | 5 failed) 141ms
   Ã— GET /api/nisab-year-records > should return 200 with all records for authenticated user 44ms
     â†’ expected false to be true // Object.is equality
   Ã— GET /api/nisab-year-records > should filter records by status=DRAFT 16ms
     â†’ expected { records: [ { â€¦(28) } ], â€¦(4) } to deeply equal ArrayContaining{â€¦}
   Ã— GET /api/nisab-year-records > should filter records by year parameter 16ms
     â†’ actual value must be number or bigint, received "undefined"
   Ã— GET /api/nisab-year-records > should return 401 for unauthenticated request 10ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   Ã— GET /api/nisab-year-records > should return empty array when no records match filter 8ms
     â†’ expected { records: [], total: +0, â€¦(3) } to deeply equal []
stdout | ../tests/contract/nisabYearRecords.put.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.unlock.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-483f3a268adc0392.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-483f3a268adc0392.db

stdout | ../tests/contract/nisabYearRecords.getById.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-30ff5e6a95b7dc3c.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-30ff5e6a95b7dc3c.db

stdout | ../tests/contract/nisabYearRecords.unlock.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.getById.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.put.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPUT /api/nisab-year-records/cmldqhes200020gxiqu2vkmu7 [33m401[0m 15.579 ms - 91[0m
[0mPUT /api/nisab-year-records/cmldqhes200020gxiqu2vkmu7 [33m401[0m 1.199 ms - 91[0m
[0mPUT /api/nisab-year-records/cmldqhes200020gxiqu2vkmu7 [33m401[0m 0.760 ms - 91[0m
[0mPUT /api/nisab-year-records/cmldqhes200020gxiqu2vkmu7 [33m401[0m 0.745 ms - 91[0m
[0mPUT /api/nisab-year-records/nonexistent-id [33m401[0m 0.952 ms - 91[0m
[0mPUT /api/nisab-year-records/cmldqhes200020gxiqu2vkmu7 [33m401[0m 0.608 ms - 94[0m
 â¯ ../tests/contract/nisabYearRecords.put.test.ts (6 tests | 6 failed) 122ms
   Ã— PUT /api/nisab-year-records/:id > should update record fields for DRAFT status 48ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should transition from DRAFT to FINALIZED 6ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should require unlock reason when transitioning to UNLOCKED 6ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should reject invalid status transitions 7ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should return 404 for non-existent record 7ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should return 401 for unauthenticated request 8ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
stdout | ../tests/contract/nisabYearRecords.finalize.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-5a42d0c70db6c57b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-5a42d0c70db6c57b.db

stdout | ../tests/contract/nisabYearRecords.unlock.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.getById.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/nisab-year-records/cmldqhfd000020gya9h8oeom2/unlock [33m401[0m 11.406 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqhfd000020gya9h8oeom2/unlock [33m401[0m 1.342 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqhfd000020gya9h8oeom2/unlock [33m401[0m 0.796 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqhfd000020gya9h8oeom2/unlock [33m401[0m 2.957 ms - 91[0m
[0mPOST /api/nisab-year-records/nonexistent-id/unlock [33m401[0m 0.850 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqhfd000020gya9h8oeom2/unlock [33m401[0m 0.640 ms - 94[0m
[0mPOST /api/nisab-year-records/cmldqhfd000020gya9h8oeom2/unlock [33m401[0m 0.716 ms - 91[0m
 â¯ ../tests/contract/nisabYearRecords.unlock.test.ts (7 tests | 5 failed) 124ms
   Ã— POST /api/nisab-year-records/:id/unlock > should unlock a FINALIZED record with valid reason 43ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/unlock > should reject unlock reason shorter than 10 characters 7ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/unlock > should reject unlock without reason 9ms
     â†’ expected 401 to be 400 // Object.is equality
   âœ“ POST /api/nisab-year-records/:id/unlock > should create audit trail entry with unlock reason 8ms
   Ã— POST /api/nisab-year-records/:id/unlock > should return 404 for non-existent record 5ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/unlock > should return 401 for unauthenticated request 7ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   âœ“ POST /api/nisab-year-records/:id/unlock > should return encrypted unlock reason in audit trail 6ms
[0mGET /api/nisab-year-records/cmldqhfgv00020gyuw5sef68a [33m401[0m 4.272 ms - 91[0m
[0mGET /api/nisab-year-records/cmldqhfgv00020gyuw5sef68a [33m401[0m 1.118 ms - 91[0m
[0mGET /api/nisab-year-records/cmldqhfgv00020gyuw5sef68a [33m401[0m 1.624 ms - 91[0m
[0mGET /api/nisab-year-records/nonexistent-id [33m401[0m 0.458 ms - 91[0m
[0mGET /api/nisab-year-records/cmldqhfgv00020gyuw5sef68a [33m401[0m 0.512 ms - 94[0m
[0mGET /api/nisab-year-records/cmldqhfgv00020gyuw5sef68a [33m401[0m 0.319 ms - 116[0m
 â¯ ../tests/contract/nisabYearRecords.getById.test.ts (6 tests | 6 failed) 125ms
   Ã— GET /api/nisab-year-records/:id > should return 200 with record details 34ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— GET /api/nisab-year-records/:id > should include audit trail in response 7ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— GET /api/nisab-year-records/:id > should include live tracking fields for DRAFT records 6ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— GET /api/nisab-year-records/:id > should return 404 for non-existent record 8ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— GET /api/nisab-year-records/:id > should return 401 for unauthenticated request 8ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   Ã— GET /api/nisab-year-records/:id > should not return records of other users 15ms
     â†’ expected 401 to be 404 // Object.is equality
stdout | ../tests/contract/nisabYearRecords.finalize.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.put.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a0379dac7b03f956.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a0379dac7b03f956.db

stdout | tests/contract/nisabYearRecords.getById.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f0d49d39b9b7630b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f0d49d39b9b7630b.db

stdout | tests/contract/nisabYearRecords.put.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.getById.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.finalize.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/nisab-year-records/cmldqhgzr00020gzuf5pf9eox/finalize [33m401[0m 11.721 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqhgzx00040gzuyscraa5x/finalize [33m401[0m 1.632 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqhgzx00040gzuyscraa5x/finalize [33m401[0m 0.757 ms - 91[0m
[0mPOST /api/nisab-year-records/nonexistent-id/finalize [33m401[0m 0.846 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqhgzr00020gzuf5pf9eox/finalize [33m401[0m 0.653 ms - 94[0m
[0mPOST /api/nisab-year-records/cmldqhgzr00020gzuf5pf9eox/finalize [33m401[0m 0.769 ms - 91[0m
 â¯ ../tests/contract/nisabYearRecords.finalize.test.ts (6 tests | 5 failed) 113ms
   Ã— POST /api/nisab-year-records/:id/finalize > should finalize a DRAFT record when Hawl is complete 39ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/finalize > should not finalize when Hawl is incomplete 7ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/finalize > should allow override with acknowledgePremature flag 6ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/finalize > should return 404 for non-existent record 5ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/finalize > should return 401 for unauthenticated request 7ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   âœ“ POST /api/nisab-year-records/:id/finalize > should create audit trail entry for finalization 4ms
stdout | ../tests/contract/nisabYearRecords.post.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7b0918ac919e0eb8.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7b0918ac919e0eb8.db

stdout | tests/contract/nisabYearRecords.put.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.getById.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.put.test.ts
JWT_SECRET (jwt.ts): supersecret

stdout | tests/contract/nisabYearRecords.getById.test.ts
JWT_SECRET (jwt.ts): supersecret

[0mGET /api/nisab-year-records/cmldqhhk800020g114a632o3c [32m200[0m 20.420 ms - -[0m
stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update userNotes on DRAFT record
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqhhjt00020g0nvsbs778x 

stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update userNotes on DRAFT record
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqhhjt00020g0nvsbs778x 

[0mGET /api/nisab-year-records/cmldqhhk800020g114a632o3c [32m200[0m 4.803 ms - -[0m
[0mPUT /api/nisab-year-records/cmldqhhjt00020g0nvsbs778x [32m200[0m 50.381 ms - -[0m
[0mGET /api/nisab-year-records/00000000-0000-0000-0000-000000000000 [33m404[0m 6.084 ms - 66[0m
[0mGET /api/nisab-year-records/cmldqhhk800020g114a632o3c [33m401[0m 0.351 ms - 94[0m
[0mGET /api/nisab-year-records/cmldqhhk800020g114a632o3c [33m404[0m 3.632 ms - 66[0m
stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update totalLiabilities on DRAFT record
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqhhmg00060g0nz4ght0g5 

stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update totalLiabilities on DRAFT record
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqhhmg00060g0nz4ght0g5 

[0mPUT /api/nisab-year-records/cmldqhhmg00060g0nz4ght0g5 [32m200[0m 27.184 ms - -[0m
[0mGET /api/nisab-year-records/cmldqhhk800020g114a632o3c [32m200[0m 4.408 ms - -[0m
[0mGET /api/nisab-year-records/cmldqhhk800020g114a632o3c [32m200[0m 3.771 ms - -[0m
stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqhhnv000a0g0nv5al0j4u 

stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqhhnv000a0g0nv5al0j4u 

[0mPUT /api/nisab-year-records/cmldqhhnv000a0g0nv5al0j4u [32m200[0m 22.091 ms - -[0m
 â¯ tests/contract/nisabYearRecords.getById.test.ts (7 tests | 1 failed) 186ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Successful Retrieval > should return 200 with complete record data 47ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Successful Retrieval > should include live tracking for DRAFT records 14ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 404 for non-existent record ID 13ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 401 without auth token 6ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 404 when accessing another user's record 31ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Response Schema Validation > should return correct response structure 11ms
   Ã— GET /api/nisab-year-records/:id - Contract Tests > Response Schema Validation > should decrypt sensitive fields for display 15ms
     â†’ expected 'number' to be 'string' // Object.is equality
[0mPUT /api/nisab-year-records/cmldqhhp3000e0g0nz0dnfirn [33m409[0m 9.737 ms - 94[0m
[0mPUT /api/nisab-year-records/00000000-0000-0000-0000-000000000000 [33m404[0m 6.071 ms - 66[0m
[0mPUT /api/nisab-year-records/some-id [33m401[0m 0.628 ms - 94[0m
 â¯ tests/contract/nisabYearRecords.put.test.ts (6 tests | 1 failed) 276ms
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update userNotes on DRAFT record 96ms
   Ã— PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update totalLiabilities on DRAFT record 52ms
     â†’ expected '0' to be '1500' // Object.is equality
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update UNLOCKED record 44ms
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Update Restriction Validation > should reject updates to FINALIZED records 30ms
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 404 for non-existent record 12ms
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 401 without auth token 5ms
stdout | ../tests/contract/nisabYearRecords.post.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/unit/encryption.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2a6ac41cd0e0b283.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2a6ac41cd0e0b283.db

stdout | ../tests/contract/nisabYearRecords.delete.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f525f96dd0cbb96a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f525f96dd0cbb96a.db

 â¯ ../tests/unit/encryption.test.ts (29 tests | 2 failed | 1 skipped) 125ms
   âœ“ EncryptionService > Constructor and Initialization > should have encryption key configured 2ms
   âœ“ EncryptionService > Constructor and Initialization > should throw error with missing encryption key 1ms
   âœ“ EncryptionService > Constructor and Initialization > should throw error with invalid encryption key length 0ms
   â†“ EncryptionService > Constructor and Initialization > should create singleton instance
   âœ“ EncryptionService > Basic Encryption/Decryption > should encrypt and decrypt text data 4ms
   âœ“ EncryptionService > Basic Encryption/Decryption > should encrypt and decrypt JSON objects 1ms
   âœ“ EncryptionService > Basic Encryption/Decryption > should encrypt and decrypt arrays 1ms
   Ã— EncryptionService > Basic Encryption/Decryption > should handle empty strings 14ms
     â†’ expected '{"encryptedData":"","iv":"728a75c6e31â€¦' to be '' // Object.is equality
   âœ“ EncryptionService > Basic Encryption/Decryption > should handle null and undefined values in objects 1ms
   âœ“ EncryptionService > Security Properties > should generate different IV for each encryption 1ms
   âœ“ EncryptionService > Security Properties > should produce different ciphertext for identical inputs 2ms
   âœ“ EncryptionService > Security Properties > should handle sensitive financial data correctly 4ms
   âœ“ EncryptionService > Security Properties > should use AES-256-GCM algorithm 1ms
   âœ“ EncryptionService > Error Handling > should throw error for invalid encrypted data format 1ms
   âœ“ EncryptionService > Error Handling > should throw error for invalid IV format 1ms
   âœ“ EncryptionService > Error Handling > should throw error for missing encrypted data 0ms
   Ã— EncryptionService > Error Handling > should throw error for missing IV 3ms
     â†’ expected [Function] to throw an error
   âœ“ EncryptionService > Error Handling > should handle JSON parsing errors gracefully 1ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle very long strings 1ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle unicode characters 0ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle special characters and symbols 0ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle complex nested objects 0ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle numeric precision correctly 0ms
   âœ“ EncryptionService > Performance and Memory > should encrypt/decrypt within reasonable time limits 12ms
   âœ“ EncryptionService > Performance and Memory > should not leak memory with repeated operations 70ms
   âœ“ EncryptionService > Islamic Compliance Data Protection > should properly encrypt Zakat calculation data 1ms
   âœ“ EncryptionService > Islamic Compliance Data Protection > should encrypt user profile data securely 1ms
   âœ“ EncryptionService > Backwards Compatibility > should maintain consistent encryption format 1ms
   âœ“ EncryptionService > Backwards Compatibility > should decrypt data encrypted with same algorithm 1ms
stdout | src/__tests__/calendarService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-be43efd7b6aa7b5e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-be43efd7b6aa7b5e.db

 â¯ src/__tests__/calendarService.test.ts (37 tests | 1 failed) 32ms
   âœ“ CalendarService > gregorianToHijri conversion > should convert known Gregorian dates to Hijri dates accurately 3ms
   âœ“ CalendarService > gregorianToHijri conversion > should convert January 1, 2024 to a valid Hijri date 1ms
   âœ“ CalendarService > gregorianToHijri conversion > should convert October 9, 2025 (current date) to valid Hijri 0ms
   âœ“ CalendarService > gregorianToHijri conversion > should handle year boundary conversions correctly 4ms
   âœ“ CalendarService > gregorianToHijri conversion > should handle month boundary conversions correctly 1ms
   âœ“ CalendarService > gregorianToHijri conversion > should return valid month names 2ms
   Ã— CalendarService > getCurrentIslamicDate > should return current Hijri date 9ms
     â†’ expected undefined to be truthy
   âœ“ CalendarService > formatHijriDate > should format Hijri date correctly 0ms
   âœ“ CalendarService > formatHijriDate > should format all month names correctly 1ms
   âœ“ CalendarService > formatHijriDate > should handle different day values 0ms
   âœ“ CalendarService > isHijriLeapYear > should correctly identify leap years in 30-year cycle 1ms
   âœ“ CalendarService > isHijriLeapYear > should work for years beyond first cycle 0ms
   âœ“ CalendarService > isHijriLeapYear > should handle year 0 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should return 30 days for odd months 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should return 29 days for even months (except month 12 in leap years) 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should return 29 days for month 12 in leap years 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should return 30 days for month 12 in non-leap years 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should handle all 12 months correctly 0ms
   âœ“ CalendarService > getLunarYearAdjustment > should return correct lunar year adjustment factor 0ms
   âœ“ CalendarService > getLunarYearAdjustment > should be less than 1 (lunar year is shorter) 0ms
   âœ“ CalendarService > getCalendarInfo > should return complete calendar calculation information 0ms
   âœ“ CalendarService > getCalendarInfo > should include valid Hijri date components 0ms
   âœ“ CalendarService > getCalendarInfo > should return lunar adjustment factor by default 0ms
   âœ“ CalendarService > calculateZakatYearPeriod > should calculate lunar year period correctly 0ms
   âœ“ CalendarService > calculateZakatYearPeriod > should calculate solar year period correctly 0ms
   âœ“ CalendarService > calculateZakatYearPeriod > should handle leap years correctly for solar calendar 1ms
   âœ“ CalendarService > calculateZakatYearPeriod > should calculate different end dates for lunar vs solar 0ms
   âœ“ CalendarService > Edge cases and error handling > should handle very old dates 0ms
   âœ“ CalendarService > Edge cases and error handling > should handle future dates 0ms
   âœ“ CalendarService > Edge cases and error handling > should handle Islamic epoch date 0ms
   âœ“ CalendarService > should handle midnight dates 1ms
   âœ“ CalendarService > should handle end of day dates 0ms
   âœ“ CalendarService > Zakat calculation integration > should provide correct adjustment factor for zakat calculations 0ms
   âœ“ CalendarService > Zakat calculation integration > should calculate next zakat date correctly 0ms
   âœ“ CalendarService > Performance and consistency > should return consistent results for same date 0ms
   âœ“ CalendarService > Performance and consistency > should handle rapid sequential calls 1ms
   âœ“ CalendarService > Performance and consistency > should complete conversion in reasonable time 0ms
stdout | ../tests/contract/nisabYearRecords.delete.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/MetalPriceScraperService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-8e32a522158bf5dc.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-8e32a522158bf5dc.db

 â¯ src/__tests__/MetalPriceScraperService.test.ts (7 tests | 2 failed) 39ms
   âœ“ MetalPriceScraperService > scrapeGoldPrice > should extract gold price from page title 13ms
   âœ“ MetalPriceScraperService > scrapeGoldPrice > should extract gold price from body as fallback 2ms
   âœ“ MetalPriceScraperService > scrapeGoldPrice > should throw error if price cannot be found 5ms
   Ã— MetalPriceScraperService > scrapeSilverPrice > should extract silver price from gram format in title 9ms
     â†’ Could not find silver price on https://www.livepriceofgold.com/silver-price/us.html. Check if page structure changed.
   Ã— MetalPriceScraperService > scrapeSilverPrice > should convert ounce price if gram price missing 2ms
     â†’ Could not find silver price on https://www.livepriceofgold.com/silver-price/us.html. Check if page structure changed.
   âœ“ MetalPriceScraperService > scrapeSilverPrice > should ignore high values (gold price) in body and throw or find correct silver price 5ms
   âœ“ MetalPriceScraperService > scrapeSilverPrice > should throw error if only high value (gold) is found 1ms
stdout | ../tests/contract/nisabYearRecords.post.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/unit/zakatService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-89e8eafb12789371.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-89e8eafb12789371.db

[0mPOST /api/nisab-year-records [33m401[0m 13.091 ms - 91[0m
[0mPOST /api/nisab-year-records [33m401[0m 1.391 ms - 91[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.768 ms - 91[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.736 ms - 91[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.627 ms - 94[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.665 ms - 91[0m
 â¯ ../tests/contract/nisabYearRecords.post.test.ts (6 tests | 6 failed) 102ms
   Ã— POST /api/nisab-year-records > should create a new DRAFT record with valid data 42ms
     â†’ expected 401 to be 201 // Object.is equality
   Ã— POST /api/nisab-year-records > should reject request without required hawlStartDate 7ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records > should reject request without required nisabBasis 8ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records > should reject invalid nisabBasis value 7ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records > should return 401 for unauthenticated request 8ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   Ã— POST /api/nisab-year-records > should calculate nisabThresholdAtStart if not provided 6ms
     â†’ expected 401 to be 201 // Object.is equality
stdout | ../tests/unit/islamic-calculation.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e723ffe2af685339.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e723ffe2af685339.db

stdout | ../tests/unit/zakatService.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 â¯ ../tests/unit/zakatService.test.ts (27 tests | 7 failed) 43ms
   âœ“ Comprehensive ZakatService Methodology Tests > Nisab Calculations by Method > Hanafi method uses silver nisab exclusively 2ms
   âœ“ Comprehensive ZakatService Methodology Tests > Nisab Calculations by Method > Shafi'i method uses dual minimum nisab 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Nisab Calculations by Method > Standard method uses minimum with specific basis tracking 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Nisab Calculations by Method > Custom method allows configurable nisab approach 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Nisab Boundary Conditions > should handle assets exactly at nisab threshold 5ms
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Nisab Boundary Conditions > should handle assets just below nisab threshold 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Nisab Boundary Conditions > should handle assets just above nisab threshold 0ms
   Ã— Comprehensive ZakatService Methodology Tests > Edge Case Tests > Debt Deduction Tests > should apply comprehensive debt deduction for Hanafi method 11ms
     â†’ expected 'conservative' to be 'comprehensive' // Object.is equality
   Ã— Comprehensive ZakatService Methodology Tests > Edge Case Tests > Debt Deduction Tests > should apply conservative debt deduction for Shafi'i method 2ms
     â†’ expected 'comprehensive' to be 'conservative' // Object.is equality
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Debt Deduction Tests > should handle zero debt scenario 1ms
   Ã— Comprehensive ZakatService Methodology Tests > Edge Case Tests > Business Asset Inclusion Tests > should include business assets comprehensively in Hanafi method 4ms
     â†’ expected [ 'Hanafi methodology applied' ] to include 'Comprehensive business asset inclusion'
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Business Asset Inclusion Tests > should categorize business assets detailed for Shafi'i method 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Cross-Method Validation and Consistency > should produce logically consistent results across all methods 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Cross-Method Validation and Consistency > should demonstrate Hanafi vs Standard nisab differences 0ms
   Ã— Comprehensive ZakatService Methodology Tests > Cross-Method Validation and Consistency > should validate method-specific source citations 1ms
     â†’ expected [ Array(1) ] to include 'Al-Hidayah by al-Marghinani'
   âœ“ Comprehensive ZakatService Methodology Tests > Cross-Method Validation and Consistency > should ensure all methods handle same asset categories 1ms
   Ã— Comprehensive ZakatService Methodology Tests > Method-Specific Rule Validation > should apply Hanafi-specific rules correctly 1ms
     â†’ expected [ 'Hanafi methodology applied' ] to include 'Comprehensive business asset inclusion'
   Ã— Comprehensive ZakatService Methodology Tests > Method-Specific Rule Validation > should apply Shafi'i-specific rules correctly 1ms
     â†’ expected 'silver' to be 'dual_minimum' // Object.is equality
   Ã— Comprehensive ZakatService Methodology Tests > Method-Specific Rule Validation > should apply Standard method (AAOIFI) rules correctly 1ms
     â†’ expected [ Array(1) ] to include 'AAOIFI FAS 9'
   âœ“ Comprehensive ZakatService Methodology Tests > Custom Method Configuration Tests > should handle custom nisab values 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Custom Method Configuration Tests > should validate custom method configuration requirements 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Performance and Error Handling Tests > should handle large asset portfolios efficiently 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Performance and Error Handling Tests > should handle invalid method gracefully 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Performance and Error Handling Tests > should handle empty asset list 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Performance and Error Handling Tests > should handle extreme price scenarios 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Integration and Comprehensive Scenarios > should handle complete zakat calculation scenario 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Integration and Comprehensive Scenarios > should provide consistent calculation breakdown structure 1ms
 â¯ ../tests/unit/islamic-calculation.test.ts (30 tests | 26 failed | 4 skipped) 26ms
   â†“ IslamicCalculationService > Nisab Threshold Calculations > should calculate correct gold nisab threshold
   â†“ IslamicCalculationService > Nisab Threshold Calculations > should calculate correct silver nisab threshold
   â†“ IslamicCalculationService > Nisab Threshold Calculations > should use lower of gold and silver nisab for cash calculations
   â†“ IslamicCalculationService > Nisab Threshold Calculations > should handle different currency conversions
   Ã— IslamicCalculationService > Zakat Rate Calculations > should apply 2.5% rate for cash and cash equivalents 11ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should apply 2.5% rate for gold 1ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should apply 2.5% rate for silver 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should apply 2.5% rate for business assets 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should not apply zakat to property for personal use 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should handle cryptocurrency as cash equivalent 1ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Hanafi Methodology > should use specific nisab calculations for Hanafi school 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Hanafi Methodology > should apply Hanafi rules for mixed assets 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Shafi Methodology > should use Shafi-specific rules for calculations 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Maliki Methodology > should apply Maliki school interpretations 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Hanbali Methodology > should follow Hanbali jurisprudence rules 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Lunar Calendar Considerations > should calculate correct lunar year completion 1ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Lunar Calendar Considerations > should handle incomplete lunar year 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Lunar Calendar Considerations > should adjust for Hijri calendar differences 2ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Complex Asset Calculations > should handle mixed asset portfolio calculation 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Complex Asset Calculations > should exclude non-zakatable business assets 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Complex Asset Calculations > should handle debt deductions correctly 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should handle zero or negative asset values 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should handle assets below nisab threshold 2ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should validate input data types 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should handle very large numbers correctly 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should maintain precision with decimal calculations 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Historical Accuracy Validation > should match traditional Islamic scholarship calculations 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Historical Accuracy Validation > should validate against contemporary Islamic finance standards 2ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Performance and Optimization > should complete calculations within reasonable time 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Performance and Optimization > should cache nisab calculations for performance 0ms
     â†’ IslamicCalculationService is not a constructor
stdout | ../tests/contract/nisabYearRecords.delete.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/unit/services/hawlTrackingService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7fdc2b86e85970d1.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7fdc2b86e85970d1.db

stdout | ../tests/contract/assets-put.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-5ceace6164c1d6ac.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-5ceace6164c1d6ac.db

 â¯ ../tests/contract/assets-put.test.ts (12 tests | 12 skipped) 15ms
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should require authentication
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should update asset with valid data and return standardized response
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should handle asset not found
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should handle unauthorized access to other users assets
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate asset value when provided
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate currency format when provided
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate description length when provided
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate notes length when provided
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should not allow changing asset type
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should handle partial updates
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should handle empty update request
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate UUID format for asset ID
[0mDELETE /api/nisab-year-records/cmldqhjuu00020g37dn74mqxh [33m401[0m 4.334 ms - 91[0m
stdout | tests/unit/services/hawlTrackingService.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mDELETE /api/nisab-year-records/cmldqhjv200040g37crjgomgy [33m401[0m 0.798 ms - 91[0m
[0mDELETE /api/nisab-year-records/nonexistent-id [33m401[0m 0.653 ms - 91[0m
[0mDELETE /api/nisab-year-records/cmldqhjuu00020g37dn74mqxh [33m401[0m 0.570 ms - 94[0m
[0mDELETE /api/nisab-year-records/cmldqhjuu00020g37dn74mqxh [33m401[0m 0.436 ms - 91[0m
stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > detectNisabAchievement > should process users and create DRAFT records if Nisab reached
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > detectNisabAchievement > should process users and create DRAFT records if Nisab reached
[HawlTrackingService] INFO: Nisab detection complete: 0 DRAFT records created 

 â¯ ../tests/contract/nisabYearRecords.delete.test.ts (5 tests | 4 failed) 130ms
   Ã— DELETE /api/nisab-year-records/:id > should delete a DRAFT record 43ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— DELETE /api/nisab-year-records/:id > should not delete FINALIZED records 6ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— DELETE /api/nisab-year-records/:id > should return 404 for non-existent record 10ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— DELETE /api/nisab-year-records/:id > should return 401 for unauthenticated request 9ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   âœ“ DELETE /api/nisab-year-records/:id > should not return deleted record in subsequent GET 6ms
stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > handleWealthChange > should start Hawl if wealth >= Nisab and no active Hawl
[HawlTrackingService] INFO: Handling wealth change for user user1 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > handleWealthChange > should interrupt Hawl if wealth < Nisab and active Hawl exists
[HawlTrackingService] INFO: Handling wealth change for user user1 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > handleWealthChange > should do nothing if wealth < Nisab and no active Hawl
[HawlTrackingService] INFO: Handling wealth change for user user1 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > handleWealthChange > should do nothing if wealth >= Nisab and active Hawl exists
[HawlTrackingService] INFO: Handling wealth change for user user1 

 â¯ tests/unit/services/hawlTrackingService.test.ts (9 tests | 3 failed) 67ms
   âœ“ HawlTrackingService > calculateHawlCompletionDate > should add 354 days to start date for lunar year 15ms
   âœ“ HawlTrackingService > toHijriDate > should convert Gregorian date to Hijri format 3ms
   Ã— HawlTrackingService > detectNisabAchievement > should process users and create DRAFT records if Nisab reached 18ms
     â†’ expected +0 to be 1 // Object.is equality
   âœ“ HawlTrackingService > isHawlComplete > should return true if 354 days have passed 2ms
   âœ“ HawlTrackingService > isHawlComplete > should return false if 354 days have not passed 1ms
   Ã— HawlTrackingService > handleWealthChange > should start Hawl if wealth >= Nisab and no active Hawl 16ms
     â†’ expected "spy" to be called at least once
   Ã— HawlTrackingService > handleWealthChange > should interrupt Hawl if wealth < Nisab and active Hawl exists 3ms
     â†’ expected "spy" to be called with arguments: [ { where: { id: 'record1' } } ][90m

Number of calls: [1m0[22m
[39m
   âœ“ HawlTrackingService > handleWealthChange > should do nothing if wealth < Nisab and no active Hawl 2ms
   âœ“ HawlTrackingService > handleWealthChange > should do nothing if wealth >= Nisab and active Hawl exists 4ms
stdout | ../tests/integration/assetRefresh.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-81412b696ce2f8a6.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-81412b696ce2f8a6.db

stdout | tests/unit/EncryptionServiceAltSeparator.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6de49548415b8322.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6de49548415b8322.db

stdout | ../tests/integration/asset-management-enhancements.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-327e7ed345dd0ecf.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-327e7ed345dd0ecf.db

 â¯ tests/unit/EncryptionServiceAltSeparator.test.ts (2 tests | 1 failed) 16ms
   âœ“ EncryptionService alternative separator handling > should decrypt encrypted payloads where separator has been replaced with `.=`, and isEncrypted should detect it 4ms
   Ã— EncryptionService alternative separator handling > PaymentRecordService should decrypt fields that use ".=" separator 7ms
     â†’ expected NaN to be close to 12.34, received difference is NaN, but expected 0.005
stdout | ../tests/integration/asset-management.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-688485b409ae52b0.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-688485b409ae52b0.db

stdout | ../tests/integration/errorHandling.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-36c8d207726c2d39.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-36c8d207726c2d39.db

stdout | ../tests/integration/assetRefresh.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/integration/finalization.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-919fffc9b8560c9b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-919fffc9b8560c9b.db

stdout | ../tests/integration/hawlDetectionAssets.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-533c2aa5b3707664.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-533c2aa5b3707664.db

stdout | ../tests/integration/hawlInterruption.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9317dc97ba1b6a8f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9317dc97ba1b6a8f.db

stdout | ../tests/integration/liveWealth.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d0806afba6ec5c0e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d0806afba6ec5c0e.db

stdout | ../tests/integration/nisabAchievement.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d7e5ba0cfdd553d4.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d7e5ba0cfdd553d4.db

stdout | ../tests/integration/statusTransitions.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-affbc030c5d700c5.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-affbc030c5d700c5.db

stdout | ../tests/integration/unlockEditRefinalize.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-bcd3050eaad935bb.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-bcd3050eaad935bb.db

stdout | ../tests/integration/user-registration.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e01814be6279bcc6.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e01814be6279bcc6.db

stdout | ../tests/performance/api-performance.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9990899119bdcf97.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9990899119bdcf97.db

stdout | ../tests/unit/data-migration.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b53a690bd5134b20.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b53a690bd5134b20.db

stdout | ../tests/integration/assetRefresh.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 â¯ ../tests/integration/assetRefresh.test.ts (8 tests | 8 skipped) 6ms
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return current assets for DRAFT record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for UNLOCKED record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 404 for non-existent record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 403 when accessing another user's record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should handle assets deleted after record creation
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication
stdout | ../tests/unit/zakat-engine.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-841964137067c784.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-841964137067c784.db

stdout | ../tests/unit/components/AuditTrailView.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-43af524fa2979550.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-43af524fa2979550.db

stdout | ../tests/unit/components/FinalizationModal.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4932b16da8eca3ee.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4932b16da8eca3ee.db

stdout | ../tests/unit/components/HawlProgressIndicator.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c5d0764618d009a1.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c5d0764618d009a1.db

stdout | ../tests/unit/components/NisabComparisonWidget.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-1975450570886506.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-1975450570886506.db

stdout | ../tests/unit/components/UnlockReasonDialog.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-db2deb0350242ea0.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-db2deb0350242ea0.db

stdout | ../tests/unit/security/payment-security-audit.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-923a40518c3c8da2.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-923a40518c3c8da2.db

stdout | ../tests/unit/services/auditTrailService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-613f756c481d9571.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-613f756c481d9571.db

stdout | ../tests/unit/services/hawlTrackingService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-15922270d25f216c.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-15922270d25f216c.db

stdout | ../tests/unit/services/nisabCalculationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b13072e59998d42f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b13072e59998d42f.db

stdout | ../tests/unit/services/nisabYearRecordService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4c271b0ecc67b202.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4c271b0ecc67b202.db

stdout | ../tests/unit/services/wealthAggregationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9414d792373d314d.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9414d792373d314d.db

stdout | tests/integration/hawlDetectionAssets.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c675ca8bf4343419.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c675ca8bf4343419.db

stdout | ../tests/contract/auth-register.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a0fabae3adff240e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a0fabae3adff240e.db

stdout | tests/integration/hawlDetectionAssets.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/assetRefresh.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2edc4114d37ef93d.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2edc4114d37ef93d.db

stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/assetRefresh.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionAssets.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should register user with valid data and return standardized response
Database cleaned in beforeEach

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/assetRefresh.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 534.468 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate required fields
Database cleaned in beforeEach

[0mPOST /api/auth/register [32m201[0m 548.416 ms - -[0m
[0mPOST /api/auth/register [33m400[0m 2.311 ms - 243[0m
[0mPOST /api/auth/register [33m400[0m 1.363 ms - 382[0m
[0mPOST /api/auth/register [33m400[0m 1.375 ms - 183[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate email format
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 4.577 ms - 197[0m
[0mPOST /api/auth/register [33m400[0m 1.130 ms - 192[0m
[0mPOST /api/auth/register [33m400[0m 1.183 ms - 203[0m
[0mPOST /api/auth/register [33m400[0m 1.302 ms - 202[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate password strength requirements
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 1.501 ms - 312[0m
[0mPOST /api/auth/register [33m400[0m 0.976 ms - 227[0m
[0mPOST /api/auth/register [33m400[0m 0.961 ms - 227[0m
[0mPOST /api/auth/register [33m400[0m 1.315 ms - 230[0m
[0mPOST /api/auth/register [33m400[0m 0.928 ms - 231[0m
[0mPOST /api/auth/register [33m400[0m 0.697 ms - 231[0m
[0mPOST /api/auth/register [33m400[0m 2.606 ms - 228[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate password confirmation match
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 0.987 ms - 206[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate name fields format
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 0.848 ms - 183[0m
[0mPOST /api/auth/register [33m400[0m 0.810 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should handle duplicate email registration
Database cleaned in beforeEach

[0mPOST /api/auth/register [32m201[0m 404.142 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 322.211 ms - -[0m
[0mPOST /api/assets [32m201[0m 21.996 ms - 506[0m
[0mPOST /api/assets [32m201[0m 26.773 ms - 500[0m
[0mPOST /api/assets [32m201[0m 33.257 ms - 503[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhpgi00000gmxhneo9bb4, wealth: 10500, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

[0mPOST /api/auth/register [32m201[0m 350.733 ms - -[0m
[0mPOST /api/auth/register [33m409[0m 2.739 ms - 105[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should normalize email to lowercase
Database cleaned in beforeEach

[0mPOST /api/auth/login [32m200[0m 321.919 ms - -[0m
[0mPOST /api/assets [32m201[0m 18.053 ms - 503[0m
[0mPOST /api/assets [32m201[0m 23.408 ms - 508[0m
[0mPOST /api/assets [32m201[0m 8.693 ms - 510[0m
[0mGET /api/nisab-year-records/cmldqhpyt00080gob19i76u56/assets/refresh [32m200[0m 13.009 ms - 662[0m
[0mPOST /api/auth/register [32m201[0m 330.859 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate optional fields when provided
Database cleaned in beforeEach

[0mPOST /api/auth/register [32m201[0m 349.567 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhpgi00000gmxhneo9bb4 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhpgi00000gmxhneo9bb4 

[0mPOST /api/auth/register [32m201[0m 344.133 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhpgi00000gmxhneo9bb4 

[0mPOST /api/auth/register [32m201[0m 336.816 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should create user audit log entry
Database cleaned in beforeEach

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 366.286 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 15.067 ms - 506[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhq3a000d0gmxwdfnbasw, wealth: 7500.5, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhpnj00000goba56kazyl 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhpnj00000goba56kazyl 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhpnj00000goba56kazyl 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 372.114 ms - -[0m
[0mGET /api/nisab-year-records/cmldqhqks000f0gob8hwm7kum/assets/refresh [33m400[0m 4.483 ms - 96[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/register [32m201[0m 350.121 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should handle registration rate limiting
Database cleaned in beforeEach

[0mPOST /api/auth/register [32m201[0m 337.404 ms - -[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for UNLOCKED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for UNLOCKED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhq3a000d0gmxwdfnbasw 

[0mPOST /api/auth/register [32m201[0m 338.900 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 337.982 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 328.603 ms - -[0m
[0mPOST /api/assets [32m201[0m 9.495 ms - 495[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 10.517 ms - 515[0m
[0mPOST /api/assets [32m201[0m 8.403 ms - 495[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhqp0000m0gmxmcedghmn, wealth: 8000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

[0mPOST /api/auth/login [32m200[0m 324.148 ms - -[0m
[0mGET /api/nisab-year-records/cmldqhr4q000k0gobdd9tkdnu/assets/refresh [33m400[0m 2.790 ms - 96[0m
[0mPOST /api/auth/register [32m201[0m 347.295 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 336.874 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 335.195 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 341.089 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhqp0000m0gmxmcedghmn 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhqp0000m0gmxmcedghmn 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhqp0000m0gmxmcedghmn 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 376.515 ms - -[0m
[0mPOST /api/assets [32m201[0m 11.105 ms - 499[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhra0000z0gmx9bj191hq, wealth: 10000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

[0mPOST /api/auth/login [32m200[0m 323.111 ms - -[0m
[0mGET /api/nisab-year-records/clxxxxxxxxxxxxxxxxxxxxxxxx/assets/refresh [33m404[0m 6.786 ms - 66[0m
[0mPOST /api/auth/register [32m201[0m 342.081 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 330.867 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 332.663 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 327.312 ms - -[0m
[0mPOST /api/auth/register [33m429[0m 0.371 ms - 140[0m
 âœ“ ../tests/contract/auth-register.test.ts (11 tests) 6059ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should register user with valid data and return standardized response  668ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should handle duplicate email registration  359ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should normalize email to lowercase  335ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should validate optional fields when provided  341ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should create user audit log entry  358ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should handle registration rate limiting  1718ms
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhra0000z0gmx9bj191hq 

stdout | ../tests/contract/methodology-config.contract.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f16d004b5b1df04f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f16d004b5b1df04f.db

[0mPOST /api/auth/login [32m200[0m 336.490 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[HawlTrackingService] INFO: Nisab detection complete: 0 DRAFT records created 

[0mPOST /api/auth/login [32m200[0m 327.118 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 343.721 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 345.353 ms - -[0m
stdout | ../tests/contract/methodology-config.contract.test.ts > Methodology Configuration Contract Tests
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 330.416 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 332.332 ms - -[0m
[0mPOST /api/assets [32m201[0m 10.330 ms - 504[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with assets below Nisab
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with assets below Nisab
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with assets below Nisab
[HawlTrackingService] INFO: Nisab detection complete: 0 DRAFT records created 

[0mGET /api/nisab-year-records/cmldqhsq7000v0gob8cizozqw/assets/refresh [33m403[0m 3.950 ms - 101[0m
[0mPOST /api/auth/register [32m201[0m 343.897 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 341.232 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhsfg001d0gmxvjwok3hp 

[0mPOST /api/auth/login [32m200[0m 317.882 ms - -[0m
[0mPOST /api/assets [32m201[0m 15.237 ms - 498[0m
[0mPOST /api/auth/login [32m200[0m 334.246 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 26.336 ms - 500[0m
[0mGET /api/nisab-year-records/cmldqhtac00140gobc2vwwd4w/assets/refresh [32m200[0m 6.446 ms - 263[0m
[0mPOST /api/assets [32m201[0m 15.240 ms - 505[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhszy001k0gmxfthuf6ez, wealth: 10000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

[0mPOST /api/auth/register [32m201[0m 332.542 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 338.310 ms - -[0m
stdout | ../tests/contract/methodology-config.contract.test.ts > Methodology Configuration Contract Tests
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhszo000w0gobwkbgnrwe 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhszo000w0gobwkbgnrwe 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhszy001k0gmxfthuf6ez 

[0mPOST /api/auth/login [32m200[0m 343.305 ms - -[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 11.315 ms - 495[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 13.586 ms - 505[0m
[0mPOST /api/auth/login [32m200[0m 351.736 ms - -[0m
[0mPOST /api/assets [32m201[0m 13.037 ms - 503[0m
[0mPOST /api/assets [32m201[0m 9.946 ms - 495[0m
[0mPOST /api/assets [32m201[0m 11.990 ms - 496[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhtl5001t0gmx4tvkoosn, wealth: 10000, Nisab: 5686.2 

[0mGET /api/nisab-year-records/cmldqhtwb001h0gobu0ab7pqe/assets/refresh [32m200[0m 6.847 ms - 638[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Nisab detection complete: 0 DRAFT records created 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/register [32m201[0m 385.018 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 338.940 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 337.600 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 323.121 ms - -[0m
[0mGET /api/methodologies [32m200[0m 7.741 ms - -[0m
[0mGET /api/methodologies [33m401[0m 0.622 ms - 94[0m
[0mGET /api/methodologies/STANDARD [32m200[0m 1.760 ms - -[0m
[0mGET /api/methodologies/UNKNOWN [33m404[0m 2.578 ms - 87[0m
[0mPUT /api/methodologies/STANDARD [33m400[0m 2.635 ms - 94[0m
[0mGET /api/methodologies/UNKNOWN [33m404[0m 1.786 ms - 87[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhtkf00150gobgihlr0ug 

[0mPOST /api/methodologies/custom [32m201[0m 10.079 ms - 178[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhtkf00150gobgihlr0ug 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhtl5001t0gmx4tvkoosn 

[0mPUT /api/methodologies/cmldqhucl00040gpprp6oj7bk [32m200[0m 11.532 ms - 180[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhtkf00150gobgihlr0ug 

[0mPUT /api/methodologies/STANDARD [33m400[0m 2.111 ms - 172[0m
[0mPUT /api/methodologies/INVALID_ID [33m404[0m 3.884 ms - 97[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhtkf00150gobgihlr0ug 

[0mPOST /api/methodologies/custom [32m201[0m 9.129 ms - 235[0m
[0mPOST /api/methodologies/custom [33m400[0m 1.237 ms - 287[0m
[0mPOST /api/methodologies/custom [32m201[0m 7.162 ms - 178[0m
[0mDELETE /api/methodologies/cmldqhue600080gppwjlgm4k4 [32m200[0m 8.888 ms - 68[0m
[0mGET /api/methodologies/cmldqhue600080gppwjlgm4k4 [33m404[0m 1.850 ms - 105[0m
[0mDELETE /api/methodologies/STANDARD [33m400[0m 1.322 ms - 94[0m
 âœ“ ../tests/contract/methodology-config.contract.test.ts (13 tests) 2806ms
[0mPOST /api/auth/login [32m200[0m 341.995 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 8.834 ms - 505[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 10.502 ms - 501[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhu6i00220gmx4dhyu01i, wealth: 7000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

stdout | ../tests/contract/calendar.contract.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-41172997821630fe.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-41172997821630fe.db

[0mPOST /api/auth/register [32m201[0m 328.657 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhu6i00220gmx4dhyu01i 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhu6i00220gmx4dhyu01i 

[0mPOST /api/auth/login [32m200[0m 337.678 ms - -[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 14.659 ms - 502[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 11.058 ms - 503[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhurn002d0gmxjs4ag008, wealth: 7000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

[0mPOST /api/auth/register [32m201[0m 316.647 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhurn002d0gmxjs4ag008 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqhurn002d0gmxjs4ag008 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 325.278 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 8.535 ms - 502[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[HawlTrackingService] INFO: Created DRAFT record for user cmldqhvf5002o0gmxmuven81d, wealth: 10000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

 âœ“ tests/integration/hawlDetectionAssets.test.ts (11 tests) 8688ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved  1041ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot  788ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot  757ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field  779ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets  710ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with assets below Nisab  739ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection  768ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved  772ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value  763ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date  856ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure  710ms
stdout | ../tests/contract/auth-login.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a65d6f44fac2764f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a65d6f44fac2764f.db

stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/auth-login.test.ts > Contract Test: POST /api/auth/login
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 339.861 ms - -[0m
[0mPOST /api/calendar/convert [32m200[0m 3.320 ms - 210[0m
[0mPOST /api/calendar/convert [32m200[0m 1.365 ms - 210[0m
[0mPOST /api/calendar/convert [33m400[0m 0.891 ms - 111[0m
[0mPOST /api/calendar/convert [33m400[0m 2.945 ms - 93[0m
[0mPOST /api/calendar/convert [33m400[0m 1.403 ms - 114[0m
[0mPOST /api/calendar/convert [33m401[0m 0.579 ms - 94[0m
[0mPOST /api/calendar/zakat-year [32m200[0m 1.226 ms - 284[0m
[0mPOST /api/calendar/zakat-year [32m200[0m 1.136 ms - 150[0m
[0mPOST /api/calendar/zakat-year [33m400[0m 1.095 ms - 107[0m
[0mPOST /api/calendar/zakat-year [33m400[0m 0.777 ms - 101[0m
[0mPOST /api/calendar/zakat-year [33m401[0m 0.538 ms - 94[0m
[0mGET /api/calendar/preference [32m200[0m 5.001 ms - 43[0m
[0mGET /api/calendar/preference [33m401[0m 0.465 ms - 94[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests > PUT /api/calendar/preference > should update calendar preference to HIJRI
Update Calendar/Methodology Request: {
  userId: [32m'cmldqhwbd00000gqhh4nenuzz'[39m,
  body: { preferredCalendar: [32m'HIJRI'[39m }
}

[0mPUT /api/calendar/preference [32m200[0m 10.073 ms - 98[0m
[0mGET /api/calendar/preference [32m200[0m 2.919 ms - 39[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests > PUT /api/calendar/preference > should update calendar preference to GREGORIAN
Update Calendar/Methodology Request: {
  userId: [32m'cmldqhwbd00000gqhh4nenuzz'[39m,
  body: { preferredCalendar: [32m'GREGORIAN'[39m }
}

[0mPUT /api/calendar/preference [32m200[0m 7.189 ms - 102[0m
[0mPUT /api/calendar/preference [33m400[0m 0.825 ms - 101[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests > PUT /api/calendar/preference > should reject invalid calendar preference
Update Calendar/Methodology Request: {
  userId: [32m'cmldqhwbd00000gqhh4nenuzz'[39m,
  body: { preferredCalendar: [32m'INVALID'[39m }
}

[0mPUT /api/calendar/preference [33m400[0m 1.547 ms - 146[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests > PUT /api/calendar/preference > should reject missing calendarPreference
Update Calendar/Methodology Request: { userId: [32m'cmldqhwbd00000gqhh4nenuzz'[39m, body: {} }

[0mPUT /api/calendar/preference [33m401[0m 0.510 ms - 94[0m
 âœ“ ../tests/contract/calendar.contract.test.ts (18 tests) 2593ms
stdout | ../tests/contract/assets-delete.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-933a1f9a1ec63c49.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-933a1f9a1ec63c49.db

stdout | ../tests/contract/assets-delete.test.ts > Contract Test: DELETE /api/assets/:id
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/auth-login.test.ts > Contract Test: POST /api/auth/login
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 344.038 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 309.449 ms - -[0m
[0mPOST /api/auth/login [33m401[0m 2.306 ms - 103[0m
[0mPOST /api/auth/login [33m400[0m 1.425 ms - 198[0m
[0mPOST /api/auth/login [33m400[0m 0.873 ms - 155[0m
[0mPOST /api/auth/login [33m400[0m 0.838 ms - 186[0m
[0mPOST /api/auth/login [33m401[0m 1.681 ms - 103[0m
 âœ“ ../tests/contract/auth-login.test.ts (5 tests) 2642ms
   âœ“ Contract Test: POST /api/auth/login > POST /api/auth/login > should accept valid login credentials and return standardized response  686ms
stdout | src/__tests__/authController.isVerified.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-25b76fb0457d3ca6.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-25b76fb0457d3ca6.db

stdout | ../tests/contract/assets-delete.test.ts > Contract Test: DELETE /api/assets/:id
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [31m500[0m 5432.472 ms - 96[0m
[0mPOST /api/auth/register [32m201[0m 390.012 ms - -[0m
stdout | src/__tests__/authController.isVerified.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 427.866 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 336.379 ms - -[0m
[0mGET /api/nisab-year-records/some-id/assets/refresh [33m401[0m 0.289 ms - 94[0m
[0mPOST /api/auth/login [32m200[0m 339.215 ms - -[0m
 â¯ tests/integration/assetRefresh.test.ts (9 tests | 1 failed) 12510ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return current assets for DRAFT record  886ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record  771ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for UNLOCKED record  704ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 404 for non-existent record  683ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 403 when accessing another user's record  1378ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should handle assets deleted after record creation  750ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets  783ms
   Ã— Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly 5801ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication  751ms
[0mPOST /api/assets [32m201[0m 14.937 ms - 524[0m
[0mDELETE /api/assets/cmldqhyzu00040gs0dipuk1ij [33m401[0m 0.869 ms - 94[0m
[0mPOST /api/assets [32m201[0m 17.331 ms - 530[0m
[0mDELETE /api/assets/cmldqhz0l00060gs08y4d4vsc [32m200[0m 10.596 ms - 811[0m
[0mDELETE /api/assets/12345678-1234-4123-a123-123456789012 [33m404[0m 2.709 ms - 150[0m
[0mDELETE /api/assets/cmldqhyzu00040gs0dipuk1ij [33m403[0m 0.499 ms - 89[0m
[0mDELETE /api/assets/invalid-uuid [33m400[0m 0.954 ms - 237[0m
[0mPOST /api/assets [32m201[0m 11.159 ms - 537[0m
[0mDELETE /api/assets/cmldqhz2500080gs0j1m3hqng [32m200[0m 8.804 ms - 818[0m
[0mGET /api/assets/cmldqhz2500080gs0j1m3hqng [33m404[0m 2.831 ms - 150[0m
[0mPOST /api/assets [32m201[0m 9.564 ms - 530[0m
[0mDELETE /api/assets/cmldqhz2z000a0gs0jdgyod83 [32m200[0m 10.926 ms - 811[0m
[0mPOST /api/assets [32m201[0m 12.970 ms - 529[0m
[0mDELETE /api/assets/cmldqhz3r000c0gs0yf4nb6e7 [32m200[0m 8.948 ms - 810[0m
[0mPOST /api/assets [32m201[0m 11.569 ms - 530[0m
[0mDELETE /api/assets/cmldqhz4m000e0gs09cu28lhk?force=true [32m200[0m 11.523 ms - 765[0m
[0mPOST /api/assets [32m201[0m 10.343 ms - 532[0m
[0mDELETE /api/assets/cmldqhz5k000g0gs0sgcmzajd [32m200[0m 10.359 ms - 813[0m
[0mPOST /api/assets [32m201[0m 15.411 ms - 535[0m
[0mDELETE /api/assets/cmldqhz6c000i0gs0sgz4a2x4 [32m200[0m 14.080 ms - 816[0m
[0mDELETE /api/assets/cmldqhz6c000i0gs0sgz4a2x4 [33m404[0m 29.659 ms - 150[0m
 âœ“ ../tests/contract/assets-delete.test.ts (12 tests | 1 skipped) 2930ms
stdout | src/__tests__/performance-testing.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-868e77940b4f6195.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-868e77940b4f6195.db

stdout | src/__tests__/integration/assets.eligibility.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-40f80c00b00fc56b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-40f80c00b00fc56b.db

stdout | src/__tests__/authController.isVerified.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/assets.eligibility.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 364.077 ms - -[0m
 âœ“ src/__tests__/performance-testing.test.ts (22 tests) 1179ms
   âœ“ Performance Testing and Optimization - T155 > API Performance > should validate API response times  440ms
stdout | src/__tests__/integration/assets.api.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b8ca0fb390476eab.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b8ca0fb390476eab.db

[0mPOST /api/auth/login [32m200[0m 331.905 ms - -[0m
[0mGET /api/auth/me [32m200[0m 14.346 ms - 554[0m
[0mPOST /api/auth/login [33m401[0m 2.144 ms - 103[0m
stdout | src/__tests__/authController.isVerified.test.ts > AuthController isVerified Response > Admin verification flow > should update isVerified status when admin verifies user
Skipping admin test - no admin user available

 âœ“ src/__tests__/authController.isVerified.test.ts (4 tests) 774ms
   âœ“ AuthController isVerified Response > POST /auth/register > should return isVerified field in response  390ms
   âœ“ AuthController isVerified Response > POST /auth/login > should return isVerified field in response  338ms
stdout | src/__tests__/integration/analytics-api.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-fafeeb5e0c50be19.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-fafeeb5e0c50be19.db

stdout | src/__tests__/integration/assets.api.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/assets.eligibility.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/analytics-api.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 399.739 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 328.739 ms - -[0m
[0mPOST /api/assets [32m201[0m 18.079 ms - 505[0m
[0mGET /api/assets [32m200[0m 4.813 ms - 693[0m
[0mPUT /api/assets/cmldqi1ne00040gu30rjl3ars [32m200[0m 10.290 ms - 506[0m
[0mGET /api/assets [32m200[0m 3.304 ms - 691[0m
 âœ“ src/__tests__/integration/assets.eligibility.test.ts (1 test) 816ms
   âœ“ Integration: Asset eligibility and passive modifier > creates a passive asset, then disables eligibility and verifies summary excludes it  814ms
stdout | tests/integration/hawlDetectionJob.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-92389044958cdb5a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-92389044958cdb5a.db

stdout | tests/integration/hawlDetectionJob.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/assets.api.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/analytics-api.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 385.348 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 338.477 ms - -[0m
[0mPOST /api/assets [32m201[0m 13.791 ms - 513[0m
 âœ“ src/__tests__/integration/assets.api.test.ts (1 test) 782ms
   âœ“ Integration: Auth and Assets API > should register, login, and create an asset successfully  780ms
[0mPOST /api/auth/register [32m201[0m 393.029 ms - -[0m
[0mGET /api/analytics/summary [32m200[0m 36.852 ms - 841[0m
[0mGET /api/analytics/summary?year=2024 [32m200[0m 22.433 ms - 841[0m
[0mGET /api/analytics/summary?includeTrends=true [32m200[0m 25.457 ms - -[0m
[0mGET /api/analytics/metrics [32m200[0m 48.167 ms - -[0m
[0mGET /api/analytics/metrics?metricTypes=wealth_trend,zakat_trend [32m200[0m 26.046 ms - 763[0m
[0mGET /api/analytics/trends [32m200[0m 33.607 ms - 780[0m
stdout | tests/contract/nisabYearRecords.unlock.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f935ab2d9ae6c9cc.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f935ab2d9ae6c9cc.db

[0mGET /api/analytics/trends?period=6months [32m200[0m 26.401 ms - 779[0m
[0mGET /api/analytics/comparison [32m200[0m 11.956 ms - 421[0m
[0mGET /api/analytics/comparison?period1=2025&period2=2026 [32m200[0m 12.704 ms - 416[0m
[0mPOST /api/analytics/cache/clear [32m200[0m 8.211 ms - 65[0m
 âœ“ src/__tests__/integration/analytics-api.test.ts (10 tests) 727ms
stdout | tests/performance/wealthAggregation.performance.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2423762f39212b92.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2423762f39212b92.db

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should calculate wealth for 500 assets in < 100ms

âœ“ Wealth calculation: 8ms for 500 assets

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should maintain consistent performance across 10 runs

âœ“ Average: 6.40ms
  Min: 5ms, Max: 8ms

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)

ðŸ“Š Performance scaling:

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)
  50 assets: 2ms (target: <50ms)

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)
  100 assets: 2ms (target: <75ms)

stdout | tests/contract/nisabYearRecords.unlock.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)
  250 assets: 3ms (target: <90ms)

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)
  500 assets: 10ms (target: <100ms)

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should efficiently query with userId + isActive index

âœ“ Indexed query: 10ms (excellent performance)

 âœ“ tests/performance/wealthAggregation.performance.test.ts (4 tests) 446ms
stdout | tests/integration/hawlDetectionJob.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionJob.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.get.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9aa5985b067bfda4.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9aa5985b067bfda4.db

[0mPOST /api/auth/register [32m201[0m 390.243 ms - -[0m
[0mPOST /api/assets [32m201[0m 15.156 ms - 496[0m
stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[hawlDetectionJob] INFO: Starting Hawl detection & reconciliation job 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[hawlDetectionJob] INFO: Processing 1 users 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[AuditTrailService] INFO: Audit event recorded: NISAB_ACHIEVED for record cmldqi41r00060gwghsccyd37 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[hawlDetectionJob] INFO: SAFETY NET: Started missed Hawl for user cmldqi3zu00000gwg8wroa0jy 
[hawlDetectionJob] INFO: Hawl detection job complete: 1 users, 1 reconciled, 1 achievements, 0 interruptions, 0 completions, 0 errors, 34ms 

[0mPOST /api/assets [32m201[0m 10.267 ms - 495[0m
stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should detect missed Nisab achievement (Safety Net)
[hawlDetectionJob] INFO: Starting Hawl detection & reconciliation job 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should detect missed Nisab achievement (Safety Net)
[hawlDetectionJob] INFO: Processing 1 users 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should detect missed Nisab achievement (Safety Net)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should detect missed Nisab achievement (Safety Net)
[hawlDetectionJob] INFO: SAFETY NET: Detected missed Nisab achievement for user cmldqi3zu00000gwg8wroa0jy 
[hawlDetectionJob] INFO: Hawl detection job complete: 1 users, 0 reconciled, 1 achievements, 0 interruptions, 0 completions, 0 errors, 11ms 

 âœ“ tests/integration/hawlDetectionJob.test.ts (2 tests) 549ms
stdout | tests/contract/nisabYearRecords.get.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.finalize.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-92a0f718ca185bfe.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-92a0f718ca185bfe.db

stdout | tests/contract/nisabYearRecords.unlock.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.unlock.test.ts
JWT_SECRET (jwt.ts): supersecret

stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Successful Unlock > should unlock FINALIZED record with valid reason
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqi4qt00020gx9r19986rg 

stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Successful Unlock > should unlock FINALIZED record with valid reason
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqi4qt00020gx9r19986rg with reason: Need to correct tota... 

[0mPOST /api/nisab-year-records/cmldqi4qt00020gx9r19986rg/unlock [32m200[0m 43.864 ms - -[0m
stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Successful Unlock > should create audit trail entry with unlock reason
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqi4tg00060gx9kf7wnalb 

stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Successful Unlock > should create audit trail entry with unlock reason
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqi4tg00060gx9kf7wnalb with reason: Discovered uncounted... 

[0mPOST /api/nisab-year-records/cmldqi4tg00060gx9kf7wnalb/unlock [32m200[0m 25.176 ms - -[0m
[0mPOST /api/nisab-year-records/cmldqi4uu000a0gx99o3uuc5d/unlock [33m400[0m 1.724 ms - 81[0m
[0mPOST /api/nisab-year-records/cmldqi4vj000c0gx9at9y54au/unlock [33m400[0m 1.061 ms - 100[0m
stdout | tests/contract/nisabYearRecords.finalize.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/nisab-year-records/cmldqi4wd000e0gx9fkm66s2g/unlock [33m409[0m 12.152 ms - 90[0m
[0mPOST /api/nisab-year-records/cmldqi4xs000g0gx9m9zk3yn6/unlock [33m409[0m 7.298 ms - 93[0m
[0mPOST /api/nisab-year-records/00000000-0000-0000-0000-000000000000/unlock [33m404[0m 5.759 ms - 66[0m
[0mPOST /api/nisab-year-records/some-id/unlock [33m401[0m 0.617 ms - 94[0m
[0mPOST /api/nisab-year-records/cmldqi4z9000i0gx9rwbai2z4/unlock [33m404[0m 3.772 ms - 66[0m
stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Response Schema Validation > should return correct response structure
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqi50h000l0gx9c6e7vcgz 

stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Response Schema Validation > should return correct response structure
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqi50h000l0gx9c6e7vcgz with reason: Correction needed fo... 

[0mPOST /api/nisab-year-records/cmldqi50h000l0gx9c6e7vcgz/unlock [32m200[0m 17.358 ms - -[0m
 âœ“ tests/contract/nisabYearRecords.unlock.test.ts (10 tests) 416ms
stdout | tests/contract/nisabYearRecords.delete.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-977d92062ee3e74e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-977d92062ee3e74e.db

stdout | tests/contract/nisabYearRecords.get.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.get.test.ts
JWT_SECRET (jwt.ts): supersecret

[0mGET /api/nisab-year-records [32m200[0m 12.486 ms - 86[0m
[0mGET /api/nisab-year-records [32m200[0m 8.204 ms - -[0m
[0mGET /api/nisab-year-records?status=DRAFT [32m200[0m 5.710 ms - -[0m
[0mGET /api/nisab-year-records?status=FINALIZED [32m200[0m 7.787 ms - -[0m
[0mGET /api/nisab-year-records?year=2025 [32m200[0m 5.899 ms - -[0m
[0mGET /api/nisab-year-records?status=ALL [32m200[0m 3.705 ms - -[0m
[0mGET /api/nisab-year-records [33m401[0m 0.425 ms - 94[0m
[0mGET /api/nisab-year-records [33m401[0m 0.623 ms - 91[0m
[0mGET /api/nisab-year-records [32m200[0m 3.184 ms - 86[0m
[0mGET /api/nisab-year-records/cmldqi5re000f0gys5bbmuchu [32m200[0m 13.221 ms - -[0m
 âœ“ tests/contract/nisabYearRecords.get.test.ts (10 tests) 282ms
stdout | tests/contract/nisabYearRecords.delete.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/unit/ValidationMiddleware.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a11105748d5a1b7a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a11105748d5a1b7a.db

stdout | tests/contract/nisabYearRecords.finalize.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.finalize.test.ts
JWT_SECRET (jwt.ts): supersecret

 âœ“ ../tests/unit/ValidationMiddleware.test.ts (20 tests) 28ms
stdout | tests/contract/nisabYearRecords.finalize.test.ts > POST /api/nisab-year-records/:id/finalize - Contract Tests > Successful Finalization > should finalize DRAFT record when Hawl is complete
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqi66z00020gzkknqyoltx 

stdout | tests/contract/nisabYearRecords.finalize.test.ts > POST /api/nisab-year-records/:id/finalize - Contract Tests > Successful Finalization > should finalize DRAFT record when Hawl is complete
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqi66z00020gzkknqyoltx with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqi66z00020gzkknqyoltx/finalize [32m200[0m 44.196 ms - -[0m
[0mPOST /api/nisab-year-records/cmldqi69m00060gzkhkapsfgk/finalize [33m409[0m 8.562 ms - 115[0m
stdout | tests/contract/nisabYearRecords.finalize.test.ts > POST /api/nisab-year-records/:id/finalize - Contract Tests > Successful Finalization > should allow finalization with override flag even when Hawl early
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqi69m00060gzkhkapsfgk 

stdout | tests/contract/nisabYearRecords.finalize.test.ts > POST /api/nisab-year-records/:id/finalize - Contract Tests > Successful Finalization > should allow finalization with override flag even when Hawl early
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqi69m00060gzkhkapsfgk with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqi69m00060gzkhkapsfgk/finalize [32m200[0m 42.098 ms - -[0m
[0mPOST /api/nisab-year-records/cmldqi6bv000a0gzkcxw91u1h/finalize [33m409[0m 2.837 ms - 115[0m
[0mPOST /api/nisab-year-records/cmldqi6co000c0gzkibf1hy2d/finalize [33m409[0m 3.770 ms - 115[0m
[0mPOST /api/nisab-year-records/cmldqi6da000e0gzkyfr7lm1l/finalize [33m409[0m 10.356 ms - 96[0m
[0mPOST /api/nisab-year-records/00000000-0000-0000-0000-000000000000/finalize [33m404[0m 4.366 ms - 66[0m
[0mPOST /api/nisab-year-records/some-id/finalize [33m401[0m 0.380 ms - 94[0m
 âœ“ tests/contract/nisabYearRecords.finalize.test.ts (7 tests) 299ms
stdout | src/__tests__/calculation-history.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-40aba08c91bd27ef.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-40aba08c91bd27ef.db

 âœ“ src/__tests__/calculation-history.test.ts (31 tests) 24ms
stdout | ../tests/unit/JWTService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b48e50f9eeb161a7.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b48e50f9eeb161a7.db

 âœ“ ../tests/unit/JWTService.test.ts (25 tests) 74ms
stdout | src/__tests__/methodology-documentation.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-11fb0edf12781e7e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-11fb0edf12781e7e.db

stdout | src/__tests__/methodology-documentation.test.ts > User Documentation for Methodologies - T156 > Documentation Structure and Content > should have comprehensive methodology guide documentation
CWD: /home/chuwi_agent/workspace/zakapp/server
Docs Path: /home/chuwi_agent/workspace/zakapp/client/public/docs/methodology-guide.md
Exists: [33mtrue[39m

stdout | src/__tests__/methodology-documentation.test.ts > User Documentation for Methodologies - T156 > Documentation Validation Summary > should meet all T156 requirements
âœ… T156 Requirement: methodologyExplanations - Met
âœ… T156 Requirement: selectionGuidance - Met
âœ… T156 Requirement: comparisonCharts - Met
âœ… T156 Requirement: practicalExamples - Met
âœ… T156 Requirement: comprehensiveContent - Met
âœ… T156 Requirement: userFriendly - Met
âœ… T156 Requirement: accurate - Met
âœ… T156 Requirement: completeGuide - Met
ðŸŽ¯ T156 Completion Rate: 100%

 âœ“ src/__tests__/methodology-documentation.test.ts (23 tests) 20ms
stdout | src/__tests__/SyncService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7b5dba0e19927097.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7b5dba0e19927097.db

stdout | tests/contract/nisabYearRecords.delete.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/methodology-selection-guide.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-826b7ef5b5354ab3.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-826b7ef5b5354ab3.db

stdout | src/__tests__/methodology-selection-guide.test.ts > T158: Methodology Selection Guide > Summary and Validation > should meet all T158 requirements
âœ… T158 Requirement: decisionTree - Met
âœ… T158 Requirement: regionalRecommendations - Met
âœ… T158 Requirement: assetConsiderations - Met
âœ… T158 Requirement: quiz - Met
âœ… T158 Requirement: additionalResources - Met
âœ… T158 Requirement: clearAndHelpful - Met
âœ… T158 Requirement: logicalProcess - Met
âœ… T158 Requirement: beginnerAccessible - Met
âœ… T158 Requirement: scholarConsultation - Met

stdout | src/__tests__/methodology-selection-guide.test.ts > T158: Methodology Selection Guide

ðŸŽ¯ T158 Completion Summary:
ðŸ“„ Guide Length: 3891 words
ðŸ“‹ Major Sections: 14
âœ… Decision Tree: Included
ðŸŒ Regional Recommendations: 7 regions covered
ðŸ’¼ Asset Type Guidance: 5 categories covered
â“ Interactive Quiz: 5 questions with profile matching
ðŸŽ“ Educational Content: Comprehensive methodology explanations
ðŸ“š Additional Resources: Scholar consultation and tools
ðŸ”° Beginner Friendly: Clear language and step-by-step guidance
ðŸ‘¨â€ðŸ« Scholar Consultation: Encouraged throughout guide

ðŸ† T158 Status: COMPLETE - Comprehensive methodology selection guide created

 âœ“ src/__tests__/methodology-selection-guide.test.ts (25 tests) 20ms
stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Ensuring CouchDB user: user_test_user 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Ensure CouchDB user: user_test_user (Synced Credentials) 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_assets 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_assets 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_liabilities 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_liabilities 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_nisab_year_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_nisab_year_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_payment_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_payment_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_user_settings 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_user_settings 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should handle existing user by updating with revision
[SyncService] INFO: Ensuring CouchDB user: user_test_user 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should handle existing user by updating with revision
[SyncService] INFO: CouchDB user exists: user_test_user (rev: 1-old) 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should handle existing user by updating with revision
[SyncService] INFO: Ensure CouchDB user: user_test_user (Synced Credentials) 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should delete all user databases and the user document
[SyncService] INFO: Deleting CouchDB user and data for: user_test_user 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Deleting CouchDB user and data for: user_test_user 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_assets 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_liabilities 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_nisab_year_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_payment_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_user_settings 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: CouchDB user already gone: user_test_user 

stdout | tests/contract/nisabYearRecords.delete.test.ts
JWT_SECRET (jwt.ts): supersecret

 âœ“ src/__tests__/SyncService.test.ts (4 tests) 24ms
stdout | tests/contract/nisabYearRecords.delete.test.ts > DELETE /api/nisab-year-records/:id - Contract Tests > Successful Deletion > should delete DRAFT record
[NisabYearRecordService] INFO: Nisab Year Record deleted: cmldqi74j00020g0cvic4c9r6 

[0mDELETE /api/nisab-year-records/cmldqi74j00020g0cvic4c9r6 [32m200[0m 19.477 ms - 56[0m
stdout | tests/contract/nisabYearRecords.delete.test.ts > DELETE /api/nisab-year-records/:id - Contract Tests > Successful Deletion > should allow delete of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record deleted: cmldqi76400040g0c6cvwe86c 

[0mDELETE /api/nisab-year-records/cmldqi76400040g0c6cvwe86c [32m200[0m 17.883 ms - 56[0m
[0mDELETE /api/nisab-year-records/cmldqi77900060g0c6owsbewk [33m409[0m 7.737 ms - 137[0m
[0mDELETE /api/nisab-year-records/cmldqi78c00080g0c5h5duxtk [33m409[0m 5.159 ms - 137[0m
[0mDELETE /api/nisab-year-records/00000000-0000-0000-0000-000000000000 [33m404[0m 6.174 ms - 66[0m
[0mDELETE /api/nisab-year-records/some-id [33m401[0m 0.388 ms - 94[0m
[0mDELETE /api/nisab-year-records/cmldqi79h000a0g0cowu6jtt8 [33m404[0m 3.778 ms - 66[0m
stdout | src/__tests__/calculation-history-basic.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-884e706550ea1e44.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-884e706550ea1e44.db

 âœ“ tests/contract/nisabYearRecords.delete.test.ts (7 tests) 252ms
stdout | src/services/__tests__/AssetService.categoryNormalization.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-ff8de705d466ebb1.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-ff8de705d466ebb1.db

 âœ“ src/__tests__/calculation-history-basic.test.ts (3 tests) 45ms
stdout | src/services/__tests__/AssetService.categoryNormalization.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 âœ“ src/services/__tests__/AssetService.categoryNormalization.test.ts (2 tests) 34ms
stdout | src/__tests__/unit/CalendarConversionService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-400e89487fb866dc.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-400e89487fb866dc.db

stdout | src/__tests__/unit/AnalyticsService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b58c0daeb38cc1f5.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b58c0daeb38cc1f5.db

 âœ“ src/__tests__/unit/AnalyticsService.test.ts (26 tests) 35ms
stdout | src/__tests__/unit/ComparisonService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-369d48dff783e925.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-369d48dff783e925.db

 âœ“ src/__tests__/unit/ComparisonService.test.ts (23 tests) 21ms
stdout | src/__tests__/unit/ReminderService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-384244a3d3195b17.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-384244a3d3195b17.db

 âœ“ src/__tests__/unit/ReminderService.test.ts (32 tests) 20ms
stdout | src/__tests__/unit/AnnualSummaryService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-be696d52f697fb8f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-be696d52f697fb8f.db

 âœ“ src/__tests__/unit/AnnualSummaryService.test.ts (23 tests) 21ms
stdout | tests/unit/services/auditTrailService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c767caf7ce0a4e55.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c767caf7ce0a4e55.db

stdout | tests/unit/services/auditTrailService.test.ts > AuditTrailService > recordEvent > should record CREATED event for new Nisab Year Record
[AuditTrailService] INFO: Audit event recorded: CREATED for record record1 

 âœ“ tests/unit/services/auditTrailService.test.ts (4 tests) 26ms
stdout | tests/unit/services/nisabYearRecordService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-62c0ce1dbc6def54.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-62c0ce1dbc6def54.db

stdout | tests/unit/services/nisabYearRecordService.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/unit/services/nisabYearRecordService.test.ts > NisabYearRecordService > createRecord > should create a new DRAFT Nisab Year Record
[NisabYearRecordService] INFO: Nisab Year Record created: record1 for user user1 

 âœ“ tests/unit/services/nisabYearRecordService.test.ts (4 tests) 12ms
stdout | tests/unit/services/wealthAggregationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a5cbe8b1705923a6.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a5cbe8b1705923a6.db

 âœ“ src/__tests__/unit/CalendarConversionService.test.ts (20 tests) 44ms
 âœ“ tests/unit/services/wealthAggregationService.test.ts (6 tests) 13ms
stdout | src/services/__tests__/NisabService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-22ce53f1738b6116.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-22ce53f1738b6116.db

stdout | src/__tests__/unit/PaymentService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b8a2e8ba707d8a6d.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b8a2e8ba707d8a6d.db

stdout | src/__tests__/utils/schemaCheck.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a851f04e16179f06.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a851f04e16179f06.db

 âœ“ src/__tests__/unit/PaymentService.test.ts (6 tests) 12ms
 âœ“ src/__tests__/utils/schemaCheck.test.ts (5 tests) 20ms
 âœ“ src/services/__tests__/NisabService.test.ts (6 tests) 12ms
stdout | tests/unit/services/nisabCalculationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9243a9fc5550d83a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9243a9fc5550d83a.db

stdout | src/services/__tests__/AssetService.update.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b642ca14d1ae475b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b642ca14d1ae475b.db

stdout | tests/unit/services/nisabCalculationService.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/unit/services/nisabCalculationService.test.ts > NisabCalculationService > calculateNisabThreshold > should use fallback prices if API fetch fails
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

 âœ“ tests/unit/services/nisabCalculationService.test.ts (4 tests) 12ms
stdout | src/services/__tests__/AssetService.update.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 âœ“ src/services/__tests__/AssetService.update.test.ts (2 tests) 10ms
stdout | ../tests/unit/stableId.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9b7a054ec1bcd8ff.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9b7a054ec1bcd8ff.db

 âœ“ ../tests/unit/stableId.test.ts (3 tests) 8ms
stdout | src/services/__tests__/EncryptionService.decryption-tolerance.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-0b247725653e1803.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-0b247725653e1803.db

 âœ“ src/services/__tests__/EncryptionService.decryption-tolerance.test.ts (3 tests) 10ms
stdout | src/__tests__/utils/assetModifiers.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-43650ca14c445014.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-43650ca14c445014.db

stdout | src/services/__tests__/WealthAggregationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c10af05866188962.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c10af05866188962.db

 âœ“ src/__tests__/utils/assetModifiers.test.ts (8 tests) 6ms
 âœ“ src/services/__tests__/WealthAggregationService.test.ts (1 test) 4ms
stdout | src/__tests__/integration/assets.passive.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7de04ecce03df314.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7de04ecce03df314.db

 âœ“ src/__tests__/integration/assets.passive.test.ts (5 tests) 5ms

 Test Files  59 failed | 43 passed (102)
      Tests  149 failed | 666 passed | 34 skipped (849)
   Start at  12:42:29
   Duration  72.10s (transform 2.74s, setup 913ms, collect 80.76s, tests 97.19s, environment 26ms, prepare 9.76s)

