# ZakApp Easy Deployment Configuration
# Zero-configuration setup with automatic HTTPS
# Works with: localhost, IP addresses, and custom domains

services:
  # Reverse proxy with automatic HTTPS
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
      - "${FRONTEND_PORT_SSL:-3443}:443"
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_certs:/root/.local/share/caddy
    environment:
      - ZAKAPP_DOMAIN=${ZAKAPP_DOMAIN:-}
      - ZAKAPP_IP=${ZAKAPP_IP:-}
    networks:
      - zakapp-network
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend - Prebuilt Docker Hub image
  frontend:
    image: slimatic/zakapp-frontend:latest
    restart: unless-stopped
    expose:
      - "80"
    environment:
      - REACT_APP_API_BASE_URL=/api
      - REACT_APP_COUCHDB_URL=${REACT_APP_COUCHDB_URL:-/db}
      - NODE_ENV=production
    networks:
      - zakapp-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend - Prebuilt Docker Hub image
  backend:
    image: slimatic/zakapp-backend:latest
    restart: unless-stopped
    expose:
      - "3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=file:/app/server/prisma/data/prod.db?connection_limit=1
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - REFRESH_SECRET=${REFRESH_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - APP_SECRET=${APP_SECRET}
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - COUCHDB_JWT_SECRET=${COUCHDB_JWT_SECRET}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - APP_URL=${APP_URL}
    volumes:
      - backend_data:/app/server/prisma/data
    networks:
      - zakapp-network
    depends_on:
      couchdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Database migrations - runs once on startup
  migrations:
    image: slimatic/zakapp-backend:latest
    restart: "no"
    environment:
      - DATABASE_URL=file:/app/server/prisma/data/prod.db?connection_limit=1
    volumes:
      - backend_data:/app/server/prisma/data
    networks:
      - zakapp-network
    depends_on:
      - backend
    command: >
      sh -c "echo 'Running database migrations...' &&
             cd /app/server &&
             npx prisma migrate deploy ||
             (echo 'Migration failed - database may already be up to date' && exit 0)"

  # CouchDB for multi-device sync
  couchdb:
    image: apache/couchdb:3.5.1
    restart: unless-stopped
    expose:
      - "5984"
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - COUCHDB_HTTPD_ENABLE_CORS=true
      - COUCHDB_CORS_ORIGINS=${ALLOWED_ORIGINS}
      - COUCHDB_CORS_CREDENTIALS=true
      - COUCHDB_CORS_HEADERS=accept, authorization, content-type, origin, referer
      - COUCHDB_CORS_METHODS=GET, PUT, POST, HEAD, DELETE
    volumes:
      - couchdb_data:/opt/couchdb/data
    networks:
      - zakapp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  caddy_data:
  caddy_certs:
  backend_data:
  couchdb_data:

networks:
  zakapp-network:
    driver: bridge