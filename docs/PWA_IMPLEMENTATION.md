# Progressive Web App (PWA) Implementation

## Overview

ZakApp is now a fully functional Progressive Web App with offline capabilities, installability, and push notifications.

## Features Implemented

### ✅ Web App Manifest (`/client/public/manifest.json`)
- App name, short name, and description
- Theme color (#4f46e5 - Indigo)
- Background color (#ffffff - White)
- Display mode: standalone
- Icons for all platforms (72px - 512px)
- Maskable icons for adaptive icons
- iOS meta tags for Apple devices

### ✅ PWA Icons
- Standard icons: 72, 96, 128, 144, 152, 192, 384, 512px
- Maskable icons: 192, 512px (with 40% safe zone)
- Apple touch icon: 180px
- All icons generated in `/client/public/icons/`

### ✅ Service Worker Registration
- **File**: `/client/src/serviceWorkerRegistration.ts`
- Registers service worker in production
- Handles updates with callbacks
- Provides skip waiting functionality
- Logs status in development

### ✅ Service Worker (Auto-generated by CRA)
- **File**: `/client/build/service-worker.js` (production only)
- Precaches all build assets
- Cache-first strategy for static assets
- Network-first strategy for API calls
- Offline fallback for navigation

### ✅ Offline Support
- **Pages**:
  - `/client/src/pages/Offline.tsx` - React component
  - `/client/public/offline.html` - Static fallback
- Shows available offline features
- Guides users on what requires internet
- Provides refresh and go back actions

### ✅ Background Sync
- **File**: `/client/src/utils/backgroundSync.ts`
- Queues failed requests in IndexedDB
- Automatically syncs when connection restored
- Supports retry logic with max attempts
- Enhanced fetch wrapper (`fetchWithSync`)

### ✅ Push Notifications
- **Client**: `/client/src/utils/notifications.ts`
- **Server**: `/server/src/services/PushNotificationService.ts`
- Permission request flow
- VAPID-based subscription
- Zakat reminder notifications
- Asset update reminders
- Notification click handling

### ✅ Install Prompt
- **File**: `/client/src/components/pwa/InstallPrompt.tsx`
- Custom install UI (better than browser default)
- Shows after 3 seconds on first visit
- Dismissible for 7 days
- Tracks analytics events
- Features list (offline, fast, home screen)

### ✅ Update Notification
- **File**: `/client/src/components/pwa/UpdateNotification.tsx`
- Detects new service worker versions
- Shows update banner at top
- "Update Now" skips waiting
- Auto-reloads with new version
- Re-prompts after 1 hour if dismissed

## Usage

### Development
```bash
# Service worker is NOT registered in development
npm start

# To test PWA features, build and serve:
npm run build
npx serve -s build -l 3000

# Or use a local HTTPS server (required for some PWA features):
npx http-server build -p 3000 -S -C cert.pem -K key.pem
```

### Production
```bash
# Build with service worker
npm run build

# Service worker will be generated at build/service-worker.js
# Manifest is at build/manifest.json
```

### Testing PWA

1. **Install Prompt**:
   - Visit site on Chrome/Edge (desktop or Android)
   - Wait 3 seconds
   - Install prompt appears
   - Click "Install App"

2. **Offline Mode**:
   - Open DevTools → Network tab
   - Check "Offline" checkbox
   - Navigate pages → cached content works
   - Try to create asset → queued for sync

3. **Service Worker**:
   - Open DevTools → Application tab
   - Service Workers section shows registered SW
   - Can simulate update and skip waiting

4. **Manifest**:
   - DevTools → Application → Manifest
   - View parsed manifest data
   - Check installability

5. **Push Notifications** (requires HTTPS):
   - Click "Enable Notifications" in settings
   - Grant permission
   - Backend can send reminders

## Configuration

### Environment Variables (Server)

```env
# VAPID keys for push notifications
# Generate with: npx web-push generate-vapid-keys
VAPID_PUBLIC_KEY=YOUR_PUBLIC_KEY
VAPID_PRIVATE_KEY=YOUR_PRIVATE_KEY
VAPID_SUBJECT=mailto:admin@zakapp.com
```

### Generate VAPID Keys

```bash
cd server
npm install web-push --save
npx web-push generate-vapid-keys

# Add keys to server/.env
```

## Files Created/Modified

### Created:
- `client/src/serviceWorkerRegistration.ts` - SW registration
- `client/src/utils/backgroundSync.ts` - Offline sync
- `client/src/utils/notifications.ts` - Push notifications
- `client/src/components/pwa/InstallPrompt.tsx` - Install UI
- `client/src/components/pwa/UpdateNotification.tsx` - Update UI
- `client/src/pages/Offline.tsx` - Offline page (React)
- `client/public/offline.html` - Offline fallback (HTML)
- `client/public/icons/` - PWA icons directory
- `client/public/icons/README.md` - Icon documentation
- `client/public/apple-touch-icon.png` - iOS icon
- `server/src/services/PushNotificationService.ts` - Backend notifications

### Modified:
- `client/public/manifest.json` - Updated with ZakApp details
- `client/public/index.html` - Added iOS meta tags
- `client/src/index.tsx` - Register SW and background sync
- `client/src/App.tsx` - Added PWA components

## Browser Support

### Install Prompt
- ✅ Chrome 68+ (Desktop & Android)
- ✅ Edge 79+
- ✅ Opera 55+
- ⚠️ Safari (iOS 13+): Uses custom A2HS guide instead
- ❌ Firefox: No install prompt (still works as PWA)

### Service Worker
- ✅ Chrome 40+
- ✅ Firefox 44+
- ✅ Safari 11.1+
- ✅ Edge 17+

### Push Notifications
- ✅ Chrome 50+
- ✅ Firefox 44+
- ⚠️ Safari 16+ (macOS only)
- ✅ Edge 17+

## Lighthouse PWA Score

Run Lighthouse to validate PWA compliance:

```bash
npm run lighthouse -- --only-categories=pwa

# Expected scores:
# - Installable: ✅
# - PWA Optimized: ✅
# - Fast and reliable: ✅
# - Manifest: ✅
# - Service Worker: ✅
```

## Future Enhancements

### Phase 4 Complete ✅
- [x] Web app manifest
- [x] PWA icons
- [x] Service worker registration
- [x] Workbox caching (via CRA)
- [x] Offline fallback pages
- [x] Background sync
- [x] Push notifications
- [x] Install prompt
- [x] Update notification

### Future Improvements (Optional)
- [ ] Add more granular caching strategies
- [ ] Implement periodic background sync
- [ ] Add notification preferences UI
- [ ] Create custom service worker for advanced features
- [ ] Add iOS A2HS guide overlay
- [ ] Implement web share API
- [ ] Add screenshot for richer install prompt

## Troubleshooting

### Service Worker Not Registering
- Check browser console for errors
- Verify HTTPS (required except localhost)
- Clear browser cache and storage
- Check Application → Service Workers in DevTools

### Install Prompt Not Showing
- Only shows on HTTPS (except localhost)
- User must meet engagement criteria (varies by browser)
- Won't show if already installed
- Check for manifest errors in DevTools

### Push Notifications Not Working
- VAPID keys must be configured
- HTTPS required
- User must grant permission
- Check browser notification settings

### Offline Mode Issues
- Service worker must be registered and activated
- Clear cache and reload
- Check what's cached in DevTools → Application → Cache Storage

## Resources

- [MDN PWA Guide](https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps)
- [web.dev PWA](https://web.dev/progressive-web-apps/)
- [Workbox Documentation](https://developers.google.com/web/tools/workbox)
- [Web Push Protocol](https://developers.google.com/web/fundamentals/push-notifications)
- [Create React App PWA](https://create-react-app.dev/docs/making-a-progressive-web-app/)
