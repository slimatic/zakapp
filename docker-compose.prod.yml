version: '3.8'

# Production Deployment Configuration
# Usage: docker-compose -f docker-compose.prod.yml up -d --build

services:
  # 1. CouchDB (Required for Sync)
  couchdb:
    image: apache/couchdb:3.5.1
    container_name: zakapp-prod-couchdb
    restart: always
    environment:
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      # Dynamic CORS configuration
      - COUCHDB_ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:${FRONTEND_PORT:-3000}}
    volumes:
      - ./couchdb-data:/opt/couchdb/data
    ports:
      - "${COUCHDB_PORT:-5984}:${COUCHDB_INTERNAL_PORT:-5984}"
      - "${COUCHDB_HTTPS_PORT:-6984}:6984"

  # 2. Backend API (Production Build)
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.production
      target: backend-production
    container_name: zakapp-prod-backend
    restart: always
    depends_on:
      - couchdb
    environment:
      - NODE_ENV=production
      - PORT=${BACKEND_INTERNAL_PORT:-3001}
      - DATABASE_URL=file:/app/server/prisma/data/prod.db?connection_limit=1
      # CouchDB Connection
      - COUCHDB_URL=${COUCHDB_URL:-http://couchdb:5984}
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - COUCHDB_JWT_SECRET=${COUCHDB_JWT_SECRET}
      # Security & App
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - FEEDBACK_WEBHOOK_URL=${REACT_APP_FEEDBACK_WEBHOOK_URL:-}
      - GOLD_API_KEY=${GOLD_API_KEY}
      - APP_URL=${APP_URL:-http://localhost:${FRONTEND_PORT:-3000}}
    volumes:
      - backend_data:/app/server/prisma/data
      # Mount backups directory for persistence
      - ./backups:/app/server/backups
    ports:
      - "${BACKEND_PORT:-3001}:${BACKEND_INTERNAL_PORT:-3001}"
    healthcheck:
        test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${BACKEND_INTERNAL_PORT:-3001}/health"]
        interval: 30s
        timeout: 10s
        retries: 3
        start_period: 20s

  # 3. Frontend (Nginx serving React Production Build)
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.production
      target: frontend-production
    container_name: zakapp-prod-frontend
    restart: always
    depends_on:
      - backend
    ports:
      # Maps Host Port (default 3000) to Container Port 80 (Nginx)
      - "${FRONTEND_PORT:-3000}:80"
    environment:
      # These are injected into window.APP_CONFIG by nginx-entrypoint.sh at runtime
      - REACT_APP_API_BASE_URL=/api
      - REACT_APP_COUCHDB_URL=${REACT_APP_COUCHDB_URL:-http://localhost:5984}
      - REACT_APP_FEEDBACK_ENABLED=${REACT_APP_FEEDBACK_ENABLED:-true}
      - REACT_APP_FEEDBACK_WEBHOOK_URL=${REACT_APP_FEEDBACK_WEBHOOK_URL:-}

volumes:
  couchdb_data:
  backend_data:

networks:
  default:
    name: zakapp-prod
