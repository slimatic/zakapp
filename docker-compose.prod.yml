# Production Deployment Configuration
# Usage: docker-compose -f docker-compose.prod.yml up -d --build

services:
  # 1. CouchDB (Required for Sync)
  couchdb:
    image: apache/couchdb:3.5.1
    container_name: zakapp-prod-couchdb
    restart: always
    environment:
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      # CORS Configuration
      - COUCHDB_HTTPD_ENABLE_CORS=true
      - COUCHDB_CORS_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:${FRONTEND_PORT:-3000},https://app.zakapp.org}
      - COUCHDB_CORS_CREDENTIALS=true
      - COUCHDB_CORS_HEADERS=accept, authorization, content-type, origin, referer
      - COUCHDB_CORS_METHODS=GET, PUT, POST, HEAD, DELETE
    volumes:
      - ./couchdb-data:/opt/couchdb/data
      - ./docker/couchdb.ini:/opt/couchdb/etc/local.d/custom_cors.ini
    ports:
      - "${COUCHDB_PORT:-5984}:${COUCHDB_INTERNAL_PORT:-5984}"
      - "${COUCHDB_HTTPS_PORT:-6984}:6984"

  # 2. Backend API (Production Build)
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.production
      target: backend-production
    container_name: zakapp-prod-backend
    restart: always
    depends_on:
      - couchdb
    # Load ALL variables from .env file (same as dev compose)
    env_file:
      - .env
    # Explicit overrides for production-specific values
    environment:
      - NODE_ENV=production
      - PORT=${BACKEND_INTERNAL_PORT:-3001}
      - DATABASE_URL=file:/app/server/prisma/data/prod.db?connection_limit=1
      # CouchDB Connection (internal Docker network)
      - COUCHDB_URL=${COUCHDB_URL:-http://couchdb:5984}
    volumes:
      - backend_data:/app/server/prisma/data
      # Mount backups directory for persistence
      - ./backups:/app/server/backups
    ports:
      - "${BACKEND_PORT:-3001}:${BACKEND_INTERNAL_PORT:-3001}"
    healthcheck:
        test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${BACKEND_INTERNAL_PORT:-3001}/health"]
        interval: 30s
        timeout: 10s
        retries: 3
        start_period: 20s

  # 3. Frontend (Nginx serving React Production Build)
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.production
      target: frontend-production
    container_name: zakapp-prod-frontend
    restart: always
    depends_on:
      - backend
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf
    ports:
      # Maps Host Port (default 3000) to Container Port 80 (Nginx)
      - "${FRONTEND_PORT:-3000}:80"
    # Load ALL variables from .env file (same as dev compose)
    env_file:
      - .env
    # Explicit overrides for production-specific values
    environment:
      - REACT_APP_API_BASE_URL=/api

volumes:
  couchdb_data:
  backend_data:

networks:
  default:
    name: zakapp-prod
