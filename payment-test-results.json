
> zakapp@0.9.2 test
> npm run test:server && npm run test:client && npm run test:cli --testNamePattern=payment-records.contract.test.ts --reporter=json


> zakapp@0.9.2 test:server
> cd server && npm test


> zakapp-server@0.9.2 test
> vitest run


 RUN  v3.2.4 /home/chuwi_agent/workspace/zakapp/server

[globalSetup] Preparing test database schema...
Prisma schema loaded from prisma/schema.prisma
Datasource "db": SQLite database "base.db" at "file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/base.db"

The database is already in sync with the Prisma schema.

Running generate... (Use --skip-generate to skip the generators)
[2K[1A[2K[GRunning generate... - Prisma Client
[2K[1A[2K[Gâœ” Generated Prisma Client (v6.19.2) to ./node_modules/@prisma/client in 448ms

[globalSetup] Base test database schema created.
[globalSetup] Test database schema is ready.
stdout | ../tests/contract/payment-records.contract.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2c30f93a1580f819.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2c30f93a1580f819.db

stdout | ../tests/integration/asset-management-enhancements.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d6117f78ef01f923.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d6117f78ef01f923.db

stdout | ../tests/integration/asset-management.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-06134f80555f76c2.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-06134f80555f76c2.db

stdout | ../tests/integration/errorHandling.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e88ee4cdc957ff0f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e88ee4cdc957ff0f.db

stdout | ../tests/integration/finalization.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-8adb168162d19dab.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-8adb168162d19dab.db

stdout | ../tests/integration/hawlDetectionAssets.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-97b4eaafc027b693.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-97b4eaafc027b693.db

stdout | ../tests/integration/hawlInterruption.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-564cfb8abf52678d.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-564cfb8abf52678d.db

stdout | ../tests/integration/nisabAchievement.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-bdd320359bd7bf1b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-bdd320359bd7bf1b.db

stdout | ../tests/integration/liveWealth.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e808a0c08efe05b8.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e808a0c08efe05b8.db

stdout | ../tests/integration/unlockEditRefinalize.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-aeb6408754024f59.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-aeb6408754024f59.db

stdout | ../tests/integration/statusTransitions.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d6a4fc34fa5880c4.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d6a4fc34fa5880c4.db

stdout | ../tests/contract/payment-records.contract.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/integration/user-registration.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-74887f54125c0bdf.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-74887f54125c0bdf.db

stdout | ../tests/performance/api-performance.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-da554b85463660bd.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-da554b85463660bd.db

stdout | ../tests/unit/data-migration.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3063fa0f77bc068f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3063fa0f77bc068f.db

stdout | ../tests/unit/zakat-engine.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7705ac390c11d1a4.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-7705ac390c11d1a4.db

stdout | ../tests/unit/components/AuditTrailView.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a29601361c860a37.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a29601361c860a37.db

stdout | ../tests/unit/components/FinalizationModal.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-49e0399a7bc1020e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-49e0399a7bc1020e.db

stdout | ../tests/unit/components/HawlProgressIndicator.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-43098acf970d8e0a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-43098acf970d8e0a.db

stdout | ../tests/unit/components/NisabComparisonWidget.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-21007482c91bbde3.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-21007482c91bbde3.db

stdout | ../tests/unit/components/UnlockReasonDialog.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e8ffb206041204c6.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e8ffb206041204c6.db

stdout | ../tests/unit/security/payment-security-audit.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-cefa7890e3d7cd6b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-cefa7890e3d7cd6b.db

stdout | ../tests/unit/services/auditTrailService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6d2cd3c384120443.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6d2cd3c384120443.db

stdout | ../tests/unit/services/hawlTrackingService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c3431cf5f0c360e8.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c3431cf5f0c360e8.db

stdout | ../tests/contract/payment-records.contract.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/unit/services/nisabCalculationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-61ab8a43eb08ee09.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-61ab8a43eb08ee09.db

stdout | ../tests/unit/services/nisabYearRecordService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-96899ae1b799d901.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-96899ae1b799d901.db

stdout | ../tests/unit/services/wealthAggregationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-086c4dfce232afbb.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-086c4dfce232afbb.db

stdout | ../tests/contract/assets-delete.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-dfbebb3660d94334.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-dfbebb3660d94334.db

[0mPOST /api/auth/register [32m201[0m 478.920 ms - -[0m
stdout | ../tests/contract/assets-get.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6405842d2be7697a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6405842d2be7697a.db

[0mPOST /api/auth/login [32m200[0m 416.493 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 18.393 ms - 617[0m
stdout | ../tests/contract/assets-delete.test.ts > Contract Test: DELETE /api/assets/:id
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 499.950 ms - -[0m
stdout | ../tests/contract/assets-get.test.ts > Contract Test: GET /api/assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 804.291 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 13.490 ms - 556[0m
[0mPOST /api/auth/register [32m201[0m 449.310 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 409.282 ms - -[0m
[0mPOST /api/zakat/payments [33m400[0m 4.492 ms - 162[0m
stdout | ../tests/contract/assets-delete.test.ts > Contract Test: DELETE /api/assets/:id
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 425.452 ms - -[0m
stdout | ../tests/contract/assets-get.test.ts > Contract Test: GET /api/assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 406.478 ms - -[0m
[0mPOST /api/zakat/payments [33m400[0m 1.233 ms - 166[0m
[0mPOST /api/auth/register [32m201[0m 462.830 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 380.145 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 408.280 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 399.997 ms - -[0m
[0mPOST /api/assets [32m201[0m 27.889 ms - 524[0m
[0mDELETE /api/assets/cmldqefsq00040gen6lo5jmvt [33m401[0m 0.795 ms - 94[0m
[0mPOST /api/assets [32m201[0m 9.694 ms - 530[0m
[0mDELETE /api/assets/cmldqefts00060genhldqqj0g [32m200[0m 15.343 ms - 811[0m
[0mDELETE /api/assets/12345678-1234-4123-a123-123456789012 [33m404[0m 3.858 ms - 150[0m
[0mDELETE /api/assets/cmldqefsq00040gen6lo5jmvt [33m403[0m 0.482 ms - 89[0m
[0mDELETE /api/assets/invalid-uuid [33m400[0m 0.977 ms - 237[0m
[0mPOST /api/assets [32m201[0m 11.922 ms - 537[0m
[0mDELETE /api/assets/cmldqefvt00080gen9t7jqohd [32m200[0m 11.248 ms - 818[0m
[0mGET /api/assets/cmldqefvt00080gen9t7jqohd [33m404[0m 3.416 ms - 150[0m
[0mPOST /api/assets [32m201[0m 11.807 ms - 530[0m
[0mDELETE /api/assets/cmldqefx3000a0gengvo0s95b [32m200[0m 12.675 ms - 811[0m
[0mPOST /api/assets [32m201[0m 18.392 ms - 529[0m
[0mDELETE /api/assets/cmldqefy0000c0genq7ia80us [32m200[0m 10.701 ms - 810[0m
[0mPOST /api/assets [32m201[0m 15.415 ms - 530[0m
[0mDELETE /api/assets/cmldqefyz000e0gen65sytfro?force=true [32m200[0m 14.222 ms - 765[0m
[0mPOST /api/assets [32m201[0m 11.816 ms - 532[0m
[0mDELETE /api/assets/cmldqeg05000g0genmgxrcp0z [32m200[0m 13.015 ms - 813[0m
[0mPOST /api/assets [32m201[0m 15.523 ms - 535[0m
[0mPOST /api/auth/login [32m200[0m 355.194 ms - -[0m
[0mDELETE /api/assets/cmldqeg10000i0gen3rsc9sk9 [32m200[0m 18.633 ms - 816[0m
[0mGET /api/assets [33m401[0m 0.782 ms - 94[0m
[0mPOST /api/auth/login [32m200[0m 409.784 ms - -[0m
[0mDELETE /api/assets/cmldqeg10000i0gen3rsc9sk9 [33m404[0m 25.797 ms - 150[0m
 âœ“ ../tests/contract/assets-delete.test.ts (12 tests | 1 skipped) 4257ms
[0mPOST /api/zakat/payments [33m401[0m 0.528 ms - 94[0m
[0mGET /api/assets [33m401[0m 1.129 ms - 91[0m
[0mGET /api/assets [33m401[0m 1.736 ms - 91[0m
 â¯ ../tests/contract/assets-get.test.ts (7 tests | 4 failed) 4147ms
   âœ“ Contract Test: GET /api/assets > GET /api/assets > should require authentication 10ms
   Ã— Contract Test: GET /api/assets > GET /api/assets > should return user assets with standardized response format 1ms
     â†’ App or auth token not available
   Ã— Contract Test: GET /api/assets > GET /api/assets > should return encrypted asset data with proper structure 1ms
     â†’ App or auth token not available
   Ã— Contract Test: GET /api/assets > GET /api/assets > should handle empty asset list correctly 5ms
     â†’ expected true to be false // Object.is equality
   âœ“ Contract Test: GET /api/assets > GET /api/assets > should reject invalid JWT tokens 6ms
   âœ“ Contract Test: GET /api/assets > GET /api/assets > should reject expired JWT tokens 9ms
   Ã— Contract Test: GET /api/assets > GET /api/assets > should respect rate limiting 1ms
     â†’ expected true to be false // Object.is equality
stdout | ../tests/contract/assets-post.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6a1a258f08c6d1e4.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6a1a258f08c6d1e4.db

stdout | ../tests/contract/assets-put.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f74b073052135115.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f74b073052135115.db

[0mPOST /api/auth/register [32m201[0m 414.034 ms - -[0m
 â¯ ../tests/contract/assets-put.test.ts (12 tests | 12 skipped) 22ms
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should require authentication
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should update asset with valid data and return standardized response
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should handle asset not found
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should handle unauthorized access to other users assets
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate asset value when provided
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate currency format when provided
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate description length when provided
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate notes length when provided
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should not allow changing asset type
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should handle partial updates
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should handle empty update request
   â†“ Contract Test: PUT /api/assets/:id > PUT /api/assets/:id > should validate UUID format for asset ID
[0mPOST /api/auth/login [32m200[0m 405.218 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 14.851 ms - 579[0m
[0mPOST /api/zakat/payments [32m201[0m 10.597 ms - 579[0m
[0mPOST /api/zakat/payments [32m201[0m 13.821 ms - 579[0m
[0mGET /api/zakat/payments [32m200[0m 12.139 ms - -[0m
stdout | ../tests/contract/auth-login.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2b4c5c40cd9a192e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2b4c5c40cd9a192e.db

stdout | ../tests/contract/assets-post.test.ts > Contract Test: POST /api/assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 478.236 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 770.234 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 13.138 ms - 579[0m
[0mPOST /api/zakat/payments [32m201[0m 19.946 ms - 579[0m
[0mPOST /api/zakat/payments [32m201[0m 18.132 ms - 579[0m
[0mGET /api/zakat/payments?year=2024 [32m200[0m 10.184 ms - -[0m
stdout | ../tests/contract/auth-login.test.ts > Contract Test: POST /api/auth/login
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 371.580 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 346.350 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 11.115 ms - 579[0m
[0mPOST /api/zakat/payments [32m201[0m 8.415 ms - 579[0m
[0mPOST /api/zakat/payments [32m201[0m 9.009 ms - 579[0m
[0mGET /api/zakat/payments?page=1&limit=2 [32m200[0m 3.084 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 392.865 ms - -[0m
stdout | ../tests/contract/assets-post.test.ts > Contract Test: POST /api/assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 367.501 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 10.618 ms - 579[0m
[0mPOST /api/zakat/payments [32m201[0m 9.996 ms - 579[0m
[0mPOST /api/zakat/payments [32m201[0m 7.929 ms - 579[0m
[0mGET /api/zakat/payments [33m401[0m 0.303 ms - 94[0m
[0mPOST /api/auth/register [32m201[0m 487.518 ms - -[0m
stdout | ../tests/contract/auth-login.test.ts > Contract Test: POST /api/auth/login
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 410.862 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 411.196 ms - -[0m
 â¯ ../tests/contract/assets-post.test.ts (8 tests | 8 skipped) 4088ms
   â†“ Contract Test: POST /api/assets > POST /api/assets > should require authentication
   â†“ Contract Test: POST /api/assets > POST /api/assets > should create asset with valid data and return standardized response
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate required fields
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate asset type enum
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate currency format (ISO 4217)
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate minimum asset value
   â†“ Contract Test: POST /api/assets > POST /api/assets > should validate description length limit
   â†“ Contract Test: POST /api/assets > POST /api/assets > should handle all valid asset types
[0mPOST /api/auth/login [32m200[0m 341.191 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 11.410 ms - 586[0m
[0mPUT /api/zakat/payments/cmldqejmb001n0g0det0hzql3 [32m200[0m 20.445 ms - 638[0m
[0mPOST /api/auth/register [32m201[0m 409.362 ms - -[0m
stdout | ../tests/contract/auth-refresh.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-dece873b626f32f3.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-dece873b626f32f3.db

[0mPOST /api/auth/register [32m201[0m 704.856 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 703.760 ms - -[0m
[0mPOST /api/auth/login [33m401[0m 3.377 ms - 103[0m
[0mPOST /api/auth/login [33m400[0m 1.640 ms - 198[0m
[0mPOST /api/auth/login [33m400[0m 0.983 ms - 155[0m
[0mPOST /api/auth/login [33m400[0m 8.342 ms - 186[0m
[0mPOST /api/auth/login [33m401[0m 5.007 ms - 103[0m
 âœ“ ../tests/contract/auth-login.test.ts (5 tests) 4429ms
   âœ“ Contract Test: POST /api/auth/login > POST /api/auth/login > should accept valid login credentials and return standardized response  1153ms
[0mPOST /api/auth/login [32m200[0m 586.167 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4094a0cd8c23ba1d.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4094a0cd8c23ba1d.db

[0mPOST /api/zakat/payments [32m201[0m 12.452 ms - 586[0m
[0mPUT /api/zakat/payments/non-existent-id [33m404[0m 2.971 ms - 161[0m
stdout | ../tests/contract/auth-refresh.test.ts > Contract Test: POST /api/auth/refresh
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 454.834 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 409.434 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/zakat/payments [32m201[0m 18.794 ms - 586[0m
[0mPUT /api/zakat/payments/cmldqeldf001x0g0davdsa9lq [33m401[0m 0.614 ms - 94[0m
[0mPOST /api/auth/register [32m201[0m 400.910 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 337.684 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 12.874 ms - 555[0m
[0mDELETE /api/zakat/payments/cmldqelz200220g0d4b8su0qg [32m200[0m 10.973 ms - 143[0m
[0mGET /api/zakat/payments/cmldqelz200220g0d4b8su0qg [33m404[0m 2.950 ms - 183[0m
[0mPOST /api/auth/register [32m201[0m 444.676 ms - -[0m
stdout | ../tests/contract/auth-refresh.test.ts > Contract Test: POST /api/auth/refresh
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 549.137 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 10.422 ms - 555[0m
[0mDELETE /api/zakat/payments/non-existent-id [33m404[0m 2.935 ms - 161[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should register user with valid data and return standardized response
Database cleaned in beforeEach

[0mPOST /api/auth/register [32m201[0m 488.931 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 680.119 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 352.747 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 8.709 ms - 555[0m
[0mDELETE /api/zakat/payments/cmldqenh0002c0g0dy14m35l1 [33m401[0m 0.309 ms - 94[0m
[0mPOST /api/auth/login [32m200[0m 391.612 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 422.913 ms - -[0m
 â¯ ../tests/contract/auth-refresh.test.ts (13 tests | 13 failed) 4276ms
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should refresh tokens with valid refresh token and return standardized response 2ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should require refresh token in request body 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle invalid refresh token format 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle expired refresh token 1ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle revoked refresh token 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle non-existent refresh token 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle deactivated user account 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should revoke old refresh token after successful refresh 1ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should include user info in refresh response 3ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should validate token rotation security 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle concurrent refresh attempts 1ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should handle refresh rate limiting 0ms
     â†’ resetAuthState is not a function
   Ã— Contract Test: POST /api/auth/refresh > POST /api/auth/refresh > should create audit log entry for token refresh 0ms
     â†’ resetAuthState is not a function
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate required fields
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 2.646 ms - 243[0m
[0mPOST /api/auth/register [33m400[0m 3.443 ms - 382[0m
[0mPOST /api/auth/register [33m400[0m 2.070 ms - 183[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate email format
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 1.427 ms - 197[0m
[0mPOST /api/auth/register [33m400[0m 1.186 ms - 192[0m
[0mPOST /api/auth/register [33m400[0m 1.127 ms - 203[0m
[0mPOST /api/auth/register [33m400[0m 1.079 ms - 202[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate password strength requirements
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 2.962 ms - 312[0m
[0mPOST /api/auth/register [33m400[0m 2.193 ms - 227[0m
[0mPOST /api/auth/register [33m400[0m 0.955 ms - 227[0m
[0mPOST /api/auth/register [33m400[0m 3.183 ms - 230[0m
[0mPOST /api/auth/register [33m400[0m 3.528 ms - 231[0m
[0mPOST /api/auth/register [33m400[0m 1.075 ms - 231[0m
[0mPOST /api/auth/register [33m400[0m 1.142 ms - 228[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate password confirmation match
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 2.200 ms - 206[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate name fields format
Database cleaned in beforeEach

[0mPOST /api/auth/register [33m400[0m 3.914 ms - 183[0m
[0mPOST /api/auth/register [33m400[0m 1.002 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should handle duplicate email registration
Database cleaned in beforeEach

[0mPOST /api/auth/register [32m201[0m 409.446 ms - -[0m
stdout | ../tests/contract/calendar.contract.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2d93ea01e034b225.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2d93ea01e034b225.db

[0mPOST /api/auth/register [32m201[0m 395.976 ms - -[0m
[0mPOST /api/auth/register [33m409[0m 4.158 ms - 105[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should normalize email to lowercase
Database cleaned in beforeEach

[0mPOST /api/auth/login [32m200[0m 387.358 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 14.749 ms - 590[0m
[0mPOST /api/zakat/payments [32m201[0m 9.305 ms - 556[0m
[0mPOST /api/auth/register [32m201[0m 438.197 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should validate optional fields when provided
Database cleaned in beforeEach

[0mPOST /api/auth/register [32m201[0m 403.225 ms - -[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 388.129 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should create user audit log entry
Database cleaned in beforeEach

[0mPOST /api/auth/login [32m200[0m 427.891 ms - -[0m
[0mPOST /api/zakat/payments [32m201[0m 14.344 ms - 590[0m
[0mPOST /api/zakat/payments [32m201[0m 9.968 ms - 556[0m
[0mGET /api/receipts/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwYXltZW50SWQiOiJjbWxkcWVvdDAwMDJxMGcwZHF6b215MWthIiwidXNlcklkIjoiY21sZHFlb2ZhMDAyazBnMGQ1YmxkMjN4YiIsImlhdCI6MTc3MDU1NDQ1NCwiZXhwIjoxODAyMTEyMDU0fQ.uCn1X0fTYYmQK77Y4JaecXt4UzvVO-n1S22-CVV9jM8 [33m404[0m 0.942 ms - 383[0m
 â¯ ../tests/contract/payment-records.contract.test.ts (17 tests | 2 failed) 16233ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should create new payment record with valid data  967ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should create payment record with minimal data  1365ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should return 400 for invalid amount  882ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should return 400 for missing required fields  856ms
   âœ“ Payment Records Contract Tests > POST /api/zakat/payments > should return 401 for unauthorized request  813ms
   âœ“ Payment Records Contract Tests > GET /api/zakat/payments > should return paginated list of payments  903ms
   âœ“ Payment Records Contract Tests > GET /api/zakat/payments > should filter payments by year  1362ms
   âœ“ Payment Records Contract Tests > GET /api/zakat/payments > should support pagination  773ms
   âœ“ Payment Records Contract Tests > GET /api/zakat/payments > should return 401 for unauthorized request  806ms
   âœ“ Payment Records Contract Tests > PUT /api/zakat/payments/:id > should update payment record  797ms
   âœ“ Payment Records Contract Tests > PUT /api/zakat/payments/:id > should return 404 for non-existent payment  1337ms
   âœ“ Payment Records Contract Tests > PUT /api/zakat/payments/:id > should return 401 for unauthorized request  922ms
   Ã— Payment Records Contract Tests > DELETE /api/zakat/payments/:id > should soft delete payment record 796ms
     â†’ expected undefined to be false // Object.is equality
   âœ“ Payment Records Contract Tests > DELETE /api/zakat/payments/:id > should return 404 for non-existent payment  1044ms
   âœ“ Payment Records Contract Tests > DELETE /api/zakat/payments/:id > should return 401 for unauthorized request  874ms
   âœ“ Payment Records Contract Tests > Receipt URL Generation > should generate valid receipt URL  840ms
   Ã— Payment Records Contract Tests > Receipt URL Generation > should allow access to receipt via generated URL 895ms
     â†’ expected 200 "OK", got 404 "Not Found"
[0mPOST /api/auth/register [32m201[0m 748.756 ms - -[0m
stdout | ../tests/contract/auth-register.test.ts > Contract Test: POST /api/auth/register > POST /api/auth/register > should handle registration rate limiting
Database cleaned in beforeEach

stdout | ../tests/contract/methodology-config.contract.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-32233cbe4b24626a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-32233cbe4b24626a.db

[0mPOST /api/auth/register [32m201[0m 418.021 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 454.092 ms - -[0m
stdout | ../tests/contract/methodology-config.contract.test.ts > Methodology Configuration Contract Tests
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 416.665 ms - -[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 421.054 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 773.007 ms - -[0m
[0mPOST /api/auth/register [33m429[0m 0.461 ms - 140[0m
 âœ“ ../tests/contract/auth-register.test.ts (11 tests) 8210ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should register user with valid data and return standardized response  491ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should handle duplicate email registration  415ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should normalize email to lowercase  446ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should validate optional fields when provided  393ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should create user audit log entry  754ms
   âœ“ Contract Test: POST /api/auth/register > POST /api/auth/register > should handle registration rate limiting  2528ms
[0mPOST /api/auth/login [32m200[0m 642.392 ms - -[0m
[0mPOST /api/calendar/convert [32m200[0m 10.645 ms - 210[0m
[0mPOST /api/calendar/convert [32m200[0m 7.053 ms - 210[0m
[0mPOST /api/calendar/convert [33m400[0m 4.381 ms - 111[0m
[0mPOST /api/calendar/convert [33m400[0m 10.726 ms - 93[0m
[0mPOST /api/calendar/convert [33m400[0m 1.542 ms - 114[0m
[0mPOST /api/calendar/convert [33m401[0m 0.741 ms - 94[0m
[0mPOST /api/calendar/zakat-year [32m200[0m 1.518 ms - 284[0m
[0mPOST /api/calendar/zakat-year [32m200[0m 2.463 ms - 150[0m
[0mPOST /api/calendar/zakat-year [33m400[0m 2.126 ms - 107[0m
[0mPOST /api/calendar/zakat-year [33m400[0m 0.943 ms - 101[0m
[0mPOST /api/calendar/zakat-year [33m401[0m 0.630 ms - 94[0m
[0mGET /api/calendar/preference [32m200[0m 9.219 ms - 43[0m
[0mGET /api/calendar/preference [33m401[0m 0.476 ms - 94[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests > PUT /api/calendar/preference > should update calendar preference to HIJRI
Update Calendar/Methodology Request: {
  userId: [32m'cmldqeqqv00000gkhvqlqb1c5'[39m,
  body: { preferredCalendar: [32m'HIJRI'[39m }
}

[0mPUT /api/calendar/preference [32m200[0m 18.542 ms - 98[0m
stdout | ../tests/contract/nisabYearRecords.delete.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a9167ed2afd2f876.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a9167ed2afd2f876.db

[0mGET /api/calendar/preference [32m200[0m 9.144 ms - 39[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests > PUT /api/calendar/preference > should update calendar preference to GREGORIAN
Update Calendar/Methodology Request: {
  userId: [32m'cmldqeqqv00000gkhvqlqb1c5'[39m,
  body: { preferredCalendar: [32m'GREGORIAN'[39m }
}

[0mPUT /api/calendar/preference [32m200[0m 8.835 ms - 102[0m
[0mPUT /api/calendar/preference [33m400[0m 2.007 ms - 101[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests > PUT /api/calendar/preference > should reject invalid calendar preference
Update Calendar/Methodology Request: {
  userId: [32m'cmldqeqqv00000gkhvqlqb1c5'[39m,
  body: { preferredCalendar: [32m'INVALID'[39m }
}

[0mPUT /api/calendar/preference [33m400[0m 1.944 ms - 146[0m
stdout | ../tests/contract/calendar.contract.test.ts > Calendar API Contract Tests > PUT /api/calendar/preference > should reject missing calendarPreference
Update Calendar/Methodology Request: { userId: [32m'cmldqeqqv00000gkhvqlqb1c5'[39m, body: {} }

[0mPUT /api/calendar/preference [33m401[0m 0.513 ms - 94[0m
 âœ“ ../tests/contract/calendar.contract.test.ts (18 tests) 4622ms
stdout | ../tests/contract/nisabYearRecords.finalize.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e04d5cecf49778dc.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e04d5cecf49778dc.db

stdout | ../tests/contract/methodology-config.contract.test.ts > Methodology Configuration Contract Tests
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.delete.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 442.435 ms - -[0m
stdout | ../tests/contract/nisabYearRecords.finalize.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 593.094 ms - -[0m
[0mGET /api/methodologies [32m200[0m 18.048 ms - -[0m
[0mGET /api/methodologies [33m401[0m 0.778 ms - 94[0m
[0mGET /api/methodologies/STANDARD [32m200[0m 6.277 ms - -[0m
[0mGET /api/methodologies/UNKNOWN [33m404[0m 5.550 ms - 87[0m
[0mPUT /api/methodologies/STANDARD [33m400[0m 7.786 ms - 94[0m
[0mGET /api/methodologies/UNKNOWN [33m404[0m 5.348 ms - 87[0m
[0mPOST /api/methodologies/custom [32m201[0m 20.052 ms - 178[0m
[0mPUT /api/methodologies/cmldqesxy00040gl8v9a3ygl9 [32m200[0m 17.656 ms - 180[0m
[0mPUT /api/methodologies/STANDARD [33m400[0m 6.029 ms - 172[0m
[0mPUT /api/methodologies/INVALID_ID [33m404[0m 13.044 ms - 97[0m
[0mPOST /api/methodologies/custom [32m201[0m 20.386 ms - 235[0m
[0mPOST /api/methodologies/custom [33m400[0m 6.919 ms - 287[0m
[0mPOST /api/methodologies/custom [32m201[0m 25.835 ms - 178[0m
[0mDELETE /api/methodologies/cmldqet1q00080gl8zo9pvxcv [32m200[0m 11.040 ms - 68[0m
[0mGET /api/methodologies/cmldqet1q00080gl8zo9pvxcv [33m404[0m 5.035 ms - 105[0m
[0mDELETE /api/methodologies/STANDARD [33m400[0m 0.994 ms - 94[0m
 âœ“ ../tests/contract/methodology-config.contract.test.ts (13 tests) 4655ms
stdout | ../tests/contract/nisabYearRecords.get.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-024bd1fbf3eedbf8.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-024bd1fbf3eedbf8.db

stdout | ../tests/contract/nisabYearRecords.delete.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mDELETE /api/nisab-year-records/cmldqeu2200020gm02t9dl2ek [33m401[0m 4.351 ms - 91[0m
[0mDELETE /api/nisab-year-records/cmldqeu2f00040gm060b6rolc [33m401[0m 0.949 ms - 91[0m
[0mDELETE /api/nisab-year-records/nonexistent-id [33m401[0m 0.516 ms - 91[0m
[0mDELETE /api/nisab-year-records/cmldqeu2200020gm02t9dl2ek [33m401[0m 0.469 ms - 94[0m
[0mDELETE /api/nisab-year-records/cmldqeu2200020gm02t9dl2ek [33m401[0m 0.478 ms - 91[0m
 â¯ ../tests/contract/nisabYearRecords.delete.test.ts (5 tests | 4 failed) 145ms
   Ã— DELETE /api/nisab-year-records/:id > should delete a DRAFT record 37ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— DELETE /api/nisab-year-records/:id > should not delete FINALIZED records 10ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— DELETE /api/nisab-year-records/:id > should return 404 for non-existent record 14ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— DELETE /api/nisab-year-records/:id > should return 401 for unauthenticated request 9ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   âœ“ DELETE /api/nisab-year-records/:id > should not return deleted record in subsequent GET 8ms
stdout | ../tests/contract/nisabYearRecords.get.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.getById.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3ac3b1695efa4d36.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3ac3b1695efa4d36.db

stdout | ../tests/contract/nisabYearRecords.finalize.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/nisab-year-records/cmldqeusi00020gmjo4ch6ah8/finalize [33m401[0m 22.737 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqeusw00040gmj9ez6q2u5/finalize [33m401[0m 1.345 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqeusw00040gmj9ez6q2u5/finalize [33m401[0m 3.925 ms - 91[0m
[0mPOST /api/nisab-year-records/nonexistent-id/finalize [33m401[0m 0.799 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqeusi00020gmjo4ch6ah8/finalize [33m401[0m 4.598 ms - 94[0m
[0mPOST /api/nisab-year-records/cmldqeusi00020gmjo4ch6ah8/finalize [33m401[0m 0.667 ms - 91[0m
 â¯ ../tests/contract/nisabYearRecords.finalize.test.ts (6 tests | 5 failed) 265ms
   Ã— POST /api/nisab-year-records/:id/finalize > should finalize a DRAFT record when Hawl is complete 96ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/finalize > should not finalize when Hawl is incomplete 23ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/finalize > should allow override with acknowledgePremature flag 14ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/finalize > should return 404 for non-existent record 15ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/finalize > should return 401 for unauthenticated request 25ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   âœ“ POST /api/nisab-year-records/:id/finalize > should create audit trail entry for finalization 7ms
stdout | ../tests/contract/nisabYearRecords.post.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b9c5d39f8f8b2290.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b9c5d39f8f8b2290.db

stdout | ../tests/contract/nisabYearRecords.getById.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.post.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.get.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mGET /api/nisab-year-records [32m200[0m 49.608 ms - 820[0m
[0mGET /api/nisab-year-records?status=DRAFT [32m200[0m 34.362 ms - 820[0m
[0mGET /api/nisab-year-records?year=2025 [32m200[0m 3.878 ms - 820[0m
[0mGET /api/nisab-year-records [33m401[0m 0.460 ms - 94[0m
[0mGET /api/nisab-year-records?status=FINALIZED&year=1900 [32m200[0m 5.747 ms - 86[0m
 â¯ ../tests/contract/nisabYearRecords.get.test.ts (5 tests | 5 failed) 354ms
   Ã— GET /api/nisab-year-records > should return 200 with all records for authenticated user 160ms
     â†’ expected false to be true // Object.is equality
   Ã— GET /api/nisab-year-records > should filter records by status=DRAFT 73ms
     â†’ expected { records: [ { â€¦(28) } ], â€¦(4) } to deeply equal ArrayContaining{â€¦}
   Ã— GET /api/nisab-year-records > should filter records by year parameter 10ms
     â†’ actual value must be number or bigint, received "undefined"
   Ã— GET /api/nisab-year-records > should return 401 for unauthenticated request 5ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   Ã— GET /api/nisab-year-records > should return empty array when no records match filter 11ms
     â†’ expected { records: [], total: +0, â€¦(3) } to deeply equal []
stdout | ../tests/contract/nisabYearRecords.put.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-12d7215a14da873f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-12d7215a14da873f.db

stdout | ../tests/contract/nisabYearRecords.getById.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mGET /api/nisab-year-records/cmldqexqr00020gobqa5w4a3x [33m401[0m 7.429 ms - 91[0m
[0mGET /api/nisab-year-records/cmldqexqr00020gobqa5w4a3x [33m401[0m 0.894 ms - 91[0m
[0mGET /api/nisab-year-records/cmldqexqr00020gobqa5w4a3x [33m401[0m 0.502 ms - 91[0m
[0mGET /api/nisab-year-records/nonexistent-id [33m401[0m 0.497 ms - 91[0m
[0mGET /api/nisab-year-records/cmldqexqr00020gobqa5w4a3x [33m401[0m 0.411 ms - 94[0m
[0mGET /api/nisab-year-records/cmldqexqr00020gobqa5w4a3x [33m401[0m 0.378 ms - 116[0m
 â¯ ../tests/contract/nisabYearRecords.getById.test.ts (6 tests | 6 failed) 286ms
   Ã— GET /api/nisab-year-records/:id > should return 200 with record details 129ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— GET /api/nisab-year-records/:id > should include audit trail in response 21ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— GET /api/nisab-year-records/:id > should include live tracking fields for DRAFT records 29ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— GET /api/nisab-year-records/:id > should return 404 for non-existent record 12ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— GET /api/nisab-year-records/:id > should return 401 for unauthenticated request 8ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   Ã— GET /api/nisab-year-records/:id > should not return records of other users 18ms
     â†’ expected 401 to be 404 // Object.is equality
stdout | ../tests/contract/nisabYearRecords.post.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/nisab-year-records [33m401[0m 13.849 ms - 91[0m
[0mPOST /api/nisab-year-records [33m401[0m 4.162 ms - 91[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.746 ms - 91[0m
[0mPOST /api/nisab-year-records [33m401[0m 3.579 ms - 91[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.947 ms - 94[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.751 ms - 91[0m
 â¯ ../tests/contract/nisabYearRecords.post.test.ts (6 tests | 6 failed) 185ms
   Ã— POST /api/nisab-year-records > should create a new DRAFT record with valid data 81ms
     â†’ expected 401 to be 201 // Object.is equality
   Ã— POST /api/nisab-year-records > should reject request without required hawlStartDate 14ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records > should reject request without required nisabBasis 7ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records > should reject invalid nisabBasis value 15ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records > should return 401 for unauthenticated request 20ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   Ã— POST /api/nisab-year-records > should calculate nisabThresholdAtStart if not provided 5ms
     â†’ expected 401 to be 201 // Object.is equality
stdout | ../tests/contract/nisabYearRecords.put.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.unlock.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-8cddeac8f5b3725e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-8cddeac8f5b3725e.db

stdout | ../tests/integration/assetRefresh.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c8b390847db4518e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c8b390847db4518e.db

stdout | ../tests/contract/nisabYearRecords.unlock.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/integration/assetRefresh.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | ../tests/contract/nisabYearRecords.put.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPUT /api/nisab-year-records/cmldqf0f100020gpveswbhf2x [33m401[0m 33.122 ms - 91[0m
[0mPUT /api/nisab-year-records/cmldqf0f100020gpveswbhf2x [33m401[0m 1.288 ms - 91[0m
[0mPUT /api/nisab-year-records/cmldqf0f100020gpveswbhf2x [33m401[0m 0.865 ms - 91[0m
[0mPUT /api/nisab-year-records/cmldqf0f100020gpveswbhf2x [33m401[0m 0.771 ms - 91[0m
[0mPUT /api/nisab-year-records/nonexistent-id [33m401[0m 0.745 ms - 91[0m
[0mPUT /api/nisab-year-records/cmldqf0f100020gpveswbhf2x [33m401[0m 0.663 ms - 94[0m
 â¯ ../tests/contract/nisabYearRecords.put.test.ts (6 tests | 6 failed) 312ms
   Ã— PUT /api/nisab-year-records/:id > should update record fields for DRAFT status 137ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should transition from DRAFT to FINALIZED 25ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should require unlock reason when transitioning to UNLOCKED 30ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should reject invalid status transitions 21ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should return 404 for non-existent record 16ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— PUT /api/nisab-year-records/:id > should return 401 for unauthenticated request 19ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
stdout | ../tests/unit/EncryptionService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e573fd3c27d7965e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e573fd3c27d7965e.db

stdout | ../tests/contract/nisabYearRecords.unlock.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 â¯ ../tests/unit/EncryptionService.test.ts (29 tests | 5 failed) 730ms
   âœ“ Implementation Task T023: EncryptionService > Core Encryption/Decryption > should encrypt and decrypt data successfully 5ms
   âœ“ Implementation Task T023: EncryptionService > Core Encryption/Decryption > should generate different encrypted values for the same plaintext 1ms
   Ã— Implementation Task T023: EncryptionService > Core Encryption/Decryption > should throw error for empty plaintext 23ms
     â†’ promise resolved "'yJdPYHjL4qafg0DC::sW1H/MixvK1Pezp7rhYâ€¦'" instead of rejecting
   Ã— Implementation Task T023: EncryptionService > Core Encryption/Decryption > should throw error for empty key 1ms
     â†’ You must provide a Promise to expect() when using .rejects, not 'object'.
   âœ“ Implementation Task T023: EncryptionService > Core Encryption/Decryption > should throw error for invalid encrypted data format 5ms
   âœ“ Implementation Task T023: EncryptionService > Object Encryption/Decryption > should encrypt and decrypt objects successfully 5ms
   âœ“ Implementation Task T023: EncryptionService > Object Encryption/Decryption > should handle complex nested objects 1ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should generate secure random keys 2ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should derive keys from passwords using PBKDF2 291ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should generate different keys for different salts  324ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should generate cryptographically secure salts 1ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should reject empty password for key derivation 0ms
   âœ“ Implementation Task T023: EncryptionService > Key Management > should reject empty salt for key derivation 0ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should create consistent SHA-256 hashes 3ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should create different hashes for different data 0ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should verify hashes correctly 1ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should handle empty data in hash verification 0ms
   âœ“ Implementation Task T023: EncryptionService > Hashing and Verification > should throw error for empty data hashing 7ms
   âœ“ Implementation Task T023: EncryptionService > Islamic Compliance Features > should encrypt asset data with integrity checks 1ms
   Ã— Implementation Task T023: EncryptionService > Islamic Compliance Features > should validate asset data integrity 13ms
     â†’ promise resolved "{ type: 'gold', value: 50000, â€¦(2) }" instead of rejecting
   âœ“ Implementation Task T023: EncryptionService > Islamic Compliance Features > should include timestamp in encrypted asset data 1ms
   âœ“ Implementation Task T023: EncryptionService > Security Features > should detect encrypted data format 1ms
   âœ“ Implementation Task T023: EncryptionService > Security Features > should normalize keys correctly 4ms
   Ã— Implementation Task T023: EncryptionService > Security Features > should validate encryption configuration 16ms
     â†’ expected false to be true // Object.is equality
   âœ“ Implementation Task T023: EncryptionService > Security Features > should handle key length variations 6ms
   Ã— Implementation Task T023: EncryptionService > Error Handling > should provide meaningful error messages 1ms
     â†’ promise resolved "'vRYY7lqNpAg/1xcs::UFPeT+QW6ccl4HyZFX7â€¦'" instead of rejecting
   âœ“ Implementation Task T023: EncryptionService > Error Handling > should handle malformed encrypted data gracefully 1ms
   âœ“ Implementation Task T023: EncryptionService > Performance and Scalability > should handle large data encryption efficiently 1ms
   âœ“ Implementation Task T023: EncryptionService > Performance and Scalability > should handle multiple concurrent encryptions 7ms
[0mPOST /api/nisab-year-records/cmldqf1sg00020gqntqgijpvs/unlock [33m401[0m 39.782 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqf1sg00020gqntqgijpvs/unlock [33m401[0m 1.602 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqf1sg00020gqntqgijpvs/unlock [33m401[0m 0.968 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqf1sg00020gqntqgijpvs/unlock [33m401[0m 3.768 ms - 91[0m
[0mPOST /api/nisab-year-records/nonexistent-id/unlock [33m401[0m 0.841 ms - 91[0m
[0mPOST /api/nisab-year-records/cmldqf1sg00020gqntqgijpvs/unlock [33m401[0m 7.387 ms - 94[0m
[0mPOST /api/nisab-year-records/cmldqf1sg00020gqntqgijpvs/unlock [33m401[0m 4.853 ms - 91[0m
 â¯ ../tests/contract/nisabYearRecords.unlock.test.ts (7 tests | 5 failed) 293ms
   Ã— POST /api/nisab-year-records/:id/unlock > should unlock a FINALIZED record with valid reason 115ms
     â†’ expected 401 to be 200 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/unlock > should reject unlock reason shorter than 10 characters 14ms
     â†’ expected 401 to be 400 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/unlock > should reject unlock without reason 24ms
     â†’ expected 401 to be 400 // Object.is equality
   âœ“ POST /api/nisab-year-records/:id/unlock > should create audit trail entry with unlock reason 21ms
   Ã— POST /api/nisab-year-records/:id/unlock > should return 404 for non-existent record 21ms
     â†’ expected 401 to be 404 // Object.is equality
   Ã— POST /api/nisab-year-records/:id/unlock > should return 401 for unauthenticated request 19ms
     â†’ expected { success: false, error: { â€¦(2) } } to have property "error" with value 'UNAUTHORIZED'
   âœ“ POST /api/nisab-year-records/:id/unlock > should return encrypted unlock reason in audit trail 10ms
stdout | ../tests/unit/JWTService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-57a6b3c4ecd05a62.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-57a6b3c4ecd05a62.db

stdout | ../tests/integration/assetRefresh.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 âœ“ ../tests/unit/JWTService.test.ts (25 tests) 62ms
 â¯ ../tests/integration/assetRefresh.test.ts (8 tests | 8 skipped) 13ms
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return current assets for DRAFT record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for UNLOCKED record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 404 for non-existent record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 403 when accessing another user's record
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should handle assets deleted after record creation
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
   â†“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication
stdout | ../tests/unit/ValidationMiddleware.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-88b0c8cf786d531d.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-88b0c8cf786d531d.db

stdout | ../tests/unit/encryption.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-fe6e62353610c9ca.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-fe6e62353610c9ca.db

stdout | ../tests/unit/islamic-calculation.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e0d44df762348598.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e0d44df762348598.db

 âœ“ ../tests/unit/ValidationMiddleware.test.ts (20 tests) 87ms
 â¯ ../tests/unit/encryption.test.ts (29 tests | 2 failed | 1 skipped) 181ms
   âœ“ EncryptionService > Constructor and Initialization > should have encryption key configured 7ms
   âœ“ EncryptionService > Constructor and Initialization > should throw error with missing encryption key 1ms
   âœ“ EncryptionService > Constructor and Initialization > should throw error with invalid encryption key length 0ms
   â†“ EncryptionService > Constructor and Initialization > should create singleton instance
   âœ“ EncryptionService > Basic Encryption/Decryption > should encrypt and decrypt text data 4ms
   âœ“ EncryptionService > Basic Encryption/Decryption > should encrypt and decrypt JSON objects 1ms
   âœ“ EncryptionService > Basic Encryption/Decryption > should encrypt and decrypt arrays 1ms
   Ã— EncryptionService > Basic Encryption/Decryption > should handle empty strings 17ms
     â†’ expected '{"encryptedData":"","iv":"5c9a207d860â€¦' to be '' // Object.is equality
   âœ“ EncryptionService > Basic Encryption/Decryption > should handle null and undefined values in objects 4ms
   âœ“ EncryptionService > Security Properties > should generate different IV for each encryption 1ms
   âœ“ EncryptionService > Security Properties > should produce different ciphertext for identical inputs 4ms
   âœ“ EncryptionService > Security Properties > should handle sensitive financial data correctly 4ms
   âœ“ EncryptionService > Security Properties > should use AES-256-GCM algorithm 2ms
   âœ“ EncryptionService > Error Handling > should throw error for invalid encrypted data format 9ms
   âœ“ EncryptionService > Error Handling > should throw error for invalid IV format 6ms
   âœ“ EncryptionService > Error Handling > should throw error for missing encrypted data 0ms
   Ã— EncryptionService > Error Handling > should throw error for missing IV 4ms
     â†’ expected [Function] to throw an error
   âœ“ EncryptionService > Error Handling > should handle JSON parsing errors gracefully 1ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle very long strings 1ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle unicode characters 0ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle special characters and symbols 0ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle complex nested objects 0ms
   âœ“ EncryptionService > Data Types and Edge Cases > should handle numeric precision correctly 0ms
   âœ“ EncryptionService > Performance and Memory > should encrypt/decrypt within reasonable time limits 13ms
   âœ“ EncryptionService > Performance and Memory > should not leak memory with repeated operations 82ms
   âœ“ EncryptionService > Islamic Compliance Data Protection > should properly encrypt Zakat calculation data 2ms
   âœ“ EncryptionService > Islamic Compliance Data Protection > should encrypt user profile data securely 1ms
   âœ“ EncryptionService > Backwards Compatibility > should maintain consistent encryption format 1ms
   âœ“ EncryptionService > Backwards Compatibility > should decrypt data encrypted with same algorithm 1ms
 â¯ ../tests/unit/islamic-calculation.test.ts (30 tests | 26 failed | 4 skipped) 51ms
   â†“ IslamicCalculationService > Nisab Threshold Calculations > should calculate correct gold nisab threshold
   â†“ IslamicCalculationService > Nisab Threshold Calculations > should calculate correct silver nisab threshold
   â†“ IslamicCalculationService > Nisab Threshold Calculations > should use lower of gold and silver nisab for cash calculations
   â†“ IslamicCalculationService > Nisab Threshold Calculations > should handle different currency conversions
   Ã— IslamicCalculationService > Zakat Rate Calculations > should apply 2.5% rate for cash and cash equivalents 18ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should apply 2.5% rate for gold 3ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should apply 2.5% rate for silver 1ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should apply 2.5% rate for business assets 3ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should not apply zakat to property for personal use 1ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Zakat Rate Calculations > should handle cryptocurrency as cash equivalent 2ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Hanafi Methodology > should use specific nisab calculations for Hanafi school 1ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Hanafi Methodology > should apply Hanafi rules for mixed assets 7ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Shafi Methodology > should use Shafi-specific rules for calculations 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Maliki Methodology > should apply Maliki school interpretations 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Methodology-Specific Calculations > Hanbali Methodology > should follow Hanbali jurisprudence rules 4ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Lunar Calendar Considerations > should calculate correct lunar year completion 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Lunar Calendar Considerations > should handle incomplete lunar year 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Lunar Calendar Considerations > should adjust for Hijri calendar differences 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Complex Asset Calculations > should handle mixed asset portfolio calculation 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Complex Asset Calculations > should exclude non-zakatable business assets 2ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Complex Asset Calculations > should handle debt deductions correctly 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should handle zero or negative asset values 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should handle assets below nisab threshold 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should validate input data types 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should handle very large numbers correctly 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Edge Cases and Error Handling > should maintain precision with decimal calculations 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Historical Accuracy Validation > should match traditional Islamic scholarship calculations 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Historical Accuracy Validation > should validate against contemporary Islamic finance standards 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Performance and Optimization > should complete calculations within reasonable time 0ms
     â†’ IslamicCalculationService is not a constructor
   Ã— IslamicCalculationService > Performance and Optimization > should cache nisab calculations for performance 0ms
     â†’ IslamicCalculationService is not a constructor
stdout | ../tests/unit/stableId.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9217d25a75f226ba.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-9217d25a75f226ba.db

stdout | ../tests/unit/zakatService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-5708eac337f61d39.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-5708eac337f61d39.db

 âœ“ ../tests/unit/stableId.test.ts (3 tests) 7ms
stdout | src/__tests__/MetalPriceScraperService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-0ede8e652c0a7c7e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-0ede8e652c0a7c7e.db

stdout | src/__tests__/SyncService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b955679c52eb8b7b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b955679c52eb8b7b.db

 â¯ src/__tests__/MetalPriceScraperService.test.ts (7 tests | 2 failed) 83ms
   âœ“ MetalPriceScraperService > scrapeGoldPrice > should extract gold price from page title 29ms
   âœ“ MetalPriceScraperService > scrapeGoldPrice > should extract gold price from body as fallback 5ms
   âœ“ MetalPriceScraperService > scrapeGoldPrice > should throw error if price cannot be found 10ms
   Ã— MetalPriceScraperService > scrapeSilverPrice > should extract silver price from gram format in title 18ms
     â†’ Could not find silver price on https://www.livepriceofgold.com/silver-price/us.html. Check if page structure changed.
   Ã— MetalPriceScraperService > scrapeSilverPrice > should convert ounce price if gram price missing 12ms
     â†’ Could not find silver price on https://www.livepriceofgold.com/silver-price/us.html. Check if page structure changed.
   âœ“ MetalPriceScraperService > scrapeSilverPrice > should ignore high values (gold price) in body and throw or find correct silver price 3ms
   âœ“ MetalPriceScraperService > scrapeSilverPrice > should throw error if only high value (gold) is found 6ms
stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Ensuring CouchDB user: user_test_user 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Ensure CouchDB user: user_test_user (Synced Credentials) 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_assets 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_assets 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_liabilities 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_liabilities 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_nisab_year_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_nisab_year_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_payment_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_payment_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Creating database: zakapp_test_user_user_settings 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should create user and databases if they do not exist
[SyncService] INFO: Created database: zakapp_test_user_user_settings 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should handle existing user by updating with revision
[SyncService] INFO: Ensuring CouchDB user: user_test_user 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should handle existing user by updating with revision
[SyncService] INFO: CouchDB user exists: user_test_user (rev: 1-old) 

stdout | src/__tests__/SyncService.test.ts > SyncService > ensureUserAndDatabases > should handle existing user by updating with revision
[SyncService] INFO: Ensure CouchDB user: user_test_user (Synced Credentials) 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should delete all user databases and the user document
[SyncService] INFO: Deleting CouchDB user and data for: user_test_user 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Deleting CouchDB user and data for: user_test_user 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_assets 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_liabilities 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_nisab_year_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_payment_records 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: Database already gone: zakapp_test_user_user_settings 

stdout | src/__tests__/SyncService.test.ts > SyncService > deleteUser > should handle already deleted databases gracefully
[SyncService] INFO: CouchDB user already gone: user_test_user 

 âœ“ src/__tests__/SyncService.test.ts (4 tests) 56ms
stdout | ../tests/unit/zakatService.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 â¯ ../tests/unit/zakatService.test.ts (27 tests | 7 failed) 57ms
   âœ“ Comprehensive ZakatService Methodology Tests > Nisab Calculations by Method > Hanafi method uses silver nisab exclusively 3ms
   âœ“ Comprehensive ZakatService Methodology Tests > Nisab Calculations by Method > Shafi'i method uses dual minimum nisab 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Nisab Calculations by Method > Standard method uses minimum with specific basis tracking 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Nisab Calculations by Method > Custom method allows configurable nisab approach 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Nisab Boundary Conditions > should handle assets exactly at nisab threshold 2ms
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Nisab Boundary Conditions > should handle assets just below nisab threshold 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Nisab Boundary Conditions > should handle assets just above nisab threshold 1ms
   Ã— Comprehensive ZakatService Methodology Tests > Edge Case Tests > Debt Deduction Tests > should apply comprehensive debt deduction for Hanafi method 17ms
     â†’ expected 'conservative' to be 'comprehensive' // Object.is equality
   Ã— Comprehensive ZakatService Methodology Tests > Edge Case Tests > Debt Deduction Tests > should apply conservative debt deduction for Shafi'i method 2ms
     â†’ expected 'comprehensive' to be 'conservative' // Object.is equality
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Debt Deduction Tests > should handle zero debt scenario 1ms
   Ã— Comprehensive ZakatService Methodology Tests > Edge Case Tests > Business Asset Inclusion Tests > should include business assets comprehensively in Hanafi method 5ms
     â†’ expected [ 'Hanafi methodology applied' ] to include 'Comprehensive business asset inclusion'
   âœ“ Comprehensive ZakatService Methodology Tests > Edge Case Tests > Business Asset Inclusion Tests > should categorize business assets detailed for Shafi'i method 2ms
   âœ“ Comprehensive ZakatService Methodology Tests > Cross-Method Validation and Consistency > should produce logically consistent results across all methods 2ms
   âœ“ Comprehensive ZakatService Methodology Tests > Cross-Method Validation and Consistency > should demonstrate Hanafi vs Standard nisab differences 0ms
   Ã— Comprehensive ZakatService Methodology Tests > Cross-Method Validation and Consistency > should validate method-specific source citations 2ms
     â†’ expected [ Array(1) ] to include 'Al-Hidayah by al-Marghinani'
   âœ“ Comprehensive ZakatService Methodology Tests > Cross-Method Validation and Consistency > should ensure all methods handle same asset categories 3ms
   Ã— Comprehensive ZakatService Methodology Tests > Method-Specific Rule Validation > should apply Hanafi-specific rules correctly 2ms
     â†’ expected [ 'Hanafi methodology applied' ] to include 'Comprehensive business asset inclusion'
   Ã— Comprehensive ZakatService Methodology Tests > Method-Specific Rule Validation > should apply Shafi'i-specific rules correctly 1ms
     â†’ expected 'silver' to be 'dual_minimum' // Object.is equality
   Ã— Comprehensive ZakatService Methodology Tests > Method-Specific Rule Validation > should apply Standard method (AAOIFI) rules correctly 1ms
     â†’ expected [ Array(1) ] to include 'AAOIFI FAS 9'
   âœ“ Comprehensive ZakatService Methodology Tests > Custom Method Configuration Tests > should handle custom nisab values 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Custom Method Configuration Tests > should validate custom method configuration requirements 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Performance and Error Handling Tests > should handle large asset portfolios efficiently 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Performance and Error Handling Tests > should handle invalid method gracefully 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Performance and Error Handling Tests > should handle empty asset list 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Performance and Error Handling Tests > should handle extreme price scenarios 0ms
   âœ“ Comprehensive ZakatService Methodology Tests > Integration and Comprehensive Scenarios > should handle complete zakat calculation scenario 1ms
   âœ“ Comprehensive ZakatService Methodology Tests > Integration and Comprehensive Scenarios > should provide consistent calculation breakdown structure 2ms
stdout | src/__tests__/authController.isVerified.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2fdf061dcf64e831.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2fdf061dcf64e831.db

stdout | src/__tests__/calculation-history-basic.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e939bf751c505aa0.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e939bf751c505aa0.db

 âœ“ src/__tests__/calculation-history-basic.test.ts (3 tests) 54ms
stdout | src/__tests__/calculation-history.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c6b11589850d597b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c6b11589850d597b.db

 âœ“ src/__tests__/calculation-history.test.ts (31 tests) 74ms
stdout | src/__tests__/calendarService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a3f30f2dc2778a02.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a3f30f2dc2778a02.db

 â¯ src/__tests__/calendarService.test.ts (37 tests | 1 failed) 121ms
   âœ“ CalendarService > gregorianToHijri conversion > should convert known Gregorian dates to Hijri dates accurately 14ms
   âœ“ CalendarService > gregorianToHijri conversion > should convert January 1, 2024 to a valid Hijri date 7ms
   âœ“ CalendarService > gregorianToHijri conversion > should convert October 9, 2025 (current date) to valid Hijri 0ms
   âœ“ CalendarService > gregorianToHijri conversion > should handle year boundary conversions correctly 2ms
   âœ“ CalendarService > gregorianToHijri conversion > should handle month boundary conversions correctly 4ms
   âœ“ CalendarService > gregorianToHijri conversion > should return valid month names 2ms
   Ã— CalendarService > getCurrentIslamicDate > should return current Hijri date 34ms
     â†’ expected undefined to be truthy
   âœ“ CalendarService > formatHijriDate > should format Hijri date correctly 0ms
   âœ“ CalendarService > formatHijriDate > should format all month names correctly 1ms
   âœ“ CalendarService > formatHijriDate > should handle different day values 0ms
   âœ“ CalendarService > isHijriLeapYear > should correctly identify leap years in 30-year cycle 11ms
   âœ“ CalendarService > isHijriLeapYear > should work for years beyond first cycle 0ms
   âœ“ CalendarService > isHijriLeapYear > should handle year 0 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should return 30 days for odd months 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should return 29 days for even months (except month 12 in leap years) 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should return 29 days for month 12 in leap years 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should return 30 days for month 12 in non-leap years 0ms
   âœ“ CalendarService > getDaysInHijriMonth > should handle all 12 months correctly 10ms
   âœ“ CalendarService > getLunarYearAdjustment > should return correct lunar year adjustment factor 0ms
   âœ“ CalendarService > getLunarYearAdjustment > should be less than 1 (lunar year is shorter) 0ms
   âœ“ CalendarService > getCalendarInfo > should return complete calendar calculation information 1ms
   âœ“ CalendarService > getCalendarInfo > should include valid Hijri date components 0ms
   âœ“ CalendarService > getCalendarInfo > should return lunar adjustment factor by default 0ms
   âœ“ CalendarService > calculateZakatYearPeriod > should calculate lunar year period correctly 0ms
   âœ“ CalendarService > calculateZakatYearPeriod > should calculate solar year period correctly 10ms
   âœ“ CalendarService > calculateZakatYearPeriod > should handle leap years correctly for solar calendar 0ms
   âœ“ CalendarService > calculateZakatYearPeriod > should calculate different end dates for lunar vs solar 0ms
   âœ“ CalendarService > Edge cases and error handling > should handle very old dates 0ms
   âœ“ CalendarService > Edge cases and error handling > should handle future dates 0ms
   âœ“ CalendarService > Edge cases and error handling > should handle Islamic epoch date 0ms
   âœ“ CalendarService > should handle midnight dates 0ms
   âœ“ CalendarService > should handle end of day dates 0ms
   âœ“ CalendarService > Zakat calculation integration > should provide correct adjustment factor for zakat calculations 0ms
   âœ“ CalendarService > Zakat calculation integration > should calculate next zakat date correctly 8ms
   âœ“ CalendarService > Performance and consistency > should return consistent results for same date 1ms
   âœ“ CalendarService > Performance and consistency > should handle rapid sequential calls 1ms
   âœ“ CalendarService > Performance and consistency > should complete conversion in reasonable time 0ms
stdout | src/__tests__/methodology-documentation.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-0d584e9915eaf222.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-0d584e9915eaf222.db

stdout | src/__tests__/methodology-documentation.test.ts > User Documentation for Methodologies - T156 > Documentation Structure and Content > should have comprehensive methodology guide documentation
CWD: /home/chuwi_agent/workspace/zakapp/server
Docs Path: /home/chuwi_agent/workspace/zakapp/client/public/docs/methodology-guide.md
Exists: [33mtrue[39m

stdout | src/__tests__/methodology-documentation.test.ts > User Documentation for Methodologies - T156 > Documentation Validation Summary > should meet all T156 requirements
âœ… T156 Requirement: methodologyExplanations - Met
âœ… T156 Requirement: selectionGuidance - Met
âœ… T156 Requirement: comparisonCharts - Met
âœ… T156 Requirement: practicalExamples - Met
âœ… T156 Requirement: comprehensiveContent - Met
âœ… T156 Requirement: userFriendly - Met
âœ… T156 Requirement: accurate - Met
âœ… T156 Requirement: completeGuide - Met
ðŸŽ¯ T156 Completion Rate: 100%

 âœ“ src/__tests__/methodology-documentation.test.ts (23 tests) 62ms
stdout | src/__tests__/authController.isVerified.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/methodology-selection-guide.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e741b5909c4e947e.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e741b5909c4e947e.db

stdout | src/__tests__/methodology-selection-guide.test.ts > T158: Methodology Selection Guide > Summary and Validation > should meet all T158 requirements
âœ… T158 Requirement: decisionTree - Met
âœ… T158 Requirement: regionalRecommendations - Met
âœ… T158 Requirement: assetConsiderations - Met
âœ… T158 Requirement: quiz - Met
âœ… T158 Requirement: additionalResources - Met
âœ… T158 Requirement: clearAndHelpful - Met
âœ… T158 Requirement: logicalProcess - Met
âœ… T158 Requirement: beginnerAccessible - Met
âœ… T158 Requirement: scholarConsultation - Met

stdout | src/__tests__/methodology-selection-guide.test.ts > T158: Methodology Selection Guide

ðŸŽ¯ T158 Completion Summary:
ðŸ“„ Guide Length: 3891 words
ðŸ“‹ Major Sections: 14
âœ… Decision Tree: Included
ðŸŒ Regional Recommendations: 7 regions covered
ðŸ’¼ Asset Type Guidance: 5 categories covered
â“ Interactive Quiz: 5 questions with profile matching
ðŸŽ“ Educational Content: Comprehensive methodology explanations
ðŸ“š Additional Resources: Scholar consultation and tools
ðŸ”° Beginner Friendly: Clear language and step-by-step guidance
ðŸ‘¨â€ðŸ« Scholar Consultation: Encouraged throughout guide

ðŸ† T158 Status: COMPLETE - Comprehensive methodology selection guide created

 âœ“ src/__tests__/methodology-selection-guide.test.ts (25 tests) 55ms
stdout | src/__tests__/performance-testing.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-263b607e0abe21ca.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-263b607e0abe21ca.db

stdout | tests/contract/nisabYearRecords.delete.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-585523b36613c6cd.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-585523b36613c6cd.db

 âœ“ src/__tests__/performance-testing.test.ts (22 tests) 1161ms
   âœ“ Performance Testing and Optimization - T155 > API Performance > should validate API response times  427ms
stdout | tests/contract/nisabYearRecords.delete.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.finalize.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-56d486803d21afa0.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-56d486803d21afa0.db

stdout | src/__tests__/authController.isVerified.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 603.603 ms - -[0m
stdout | tests/contract/nisabYearRecords.finalize.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 919.914 ms - -[0m
[0mGET /api/auth/me [32m200[0m 11.052 ms - 554[0m
[0mPOST /api/auth/login [33m401[0m 3.482 ms - 103[0m
stdout | src/__tests__/authController.isVerified.test.ts > AuthController isVerified Response > Admin verification flow > should update isVerified status when admin verifies user
Skipping admin test - no admin user available

 âœ“ src/__tests__/authController.isVerified.test.ts (4 tests) 1657ms
   âœ“ AuthController isVerified Response > POST /auth/register > should return isVerified field in response  664ms
   âœ“ AuthController isVerified Response > POST /auth/login > should return isVerified field in response  932ms
stdout | tests/contract/nisabYearRecords.get.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3a85dc33cd5b5f3b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-3a85dc33cd5b5f3b.db

stdout | tests/contract/nisabYearRecords.delete.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.delete.test.ts
JWT_SECRET (jwt.ts): supersecret

stdout | tests/contract/nisabYearRecords.delete.test.ts > DELETE /api/nisab-year-records/:id - Contract Tests > Successful Deletion > should delete DRAFT record
[NisabYearRecordService] INFO: Nisab Year Record deleted: cmldqf9iu00020g1zviiu5w5o 

[0mDELETE /api/nisab-year-records/cmldqf9iu00020g1zviiu5w5o [32m200[0m 20.132 ms - 56[0m
stdout | tests/contract/nisabYearRecords.delete.test.ts > DELETE /api/nisab-year-records/:id - Contract Tests > Successful Deletion > should allow delete of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record deleted: cmldqf9kh00040g1zahn9qkz3 

[0mDELETE /api/nisab-year-records/cmldqf9kh00040g1zahn9qkz3 [32m200[0m 12.148 ms - 56[0m
[0mDELETE /api/nisab-year-records/cmldqf9l700060g1zfc3rkgmu [33m409[0m 4.669 ms - 137[0m
[0mDELETE /api/nisab-year-records/cmldqf9m300080g1zuba5zw8a [33m409[0m 2.911 ms - 137[0m
[0mDELETE /api/nisab-year-records/00000000-0000-0000-0000-000000000000 [33m404[0m 5.121 ms - 66[0m
[0mDELETE /api/nisab-year-records/some-id [33m401[0m 0.411 ms - 94[0m
[0mDELETE /api/nisab-year-records/cmldqf9n7000a0g1zhp6zj3ob [33m404[0m 4.431 ms - 66[0m
 âœ“ tests/contract/nisabYearRecords.delete.test.ts (7 tests) 231ms
stdout | tests/contract/nisabYearRecords.get.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.getById.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-8a9ede75b6e9b5cc.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-8a9ede75b6e9b5cc.db

stdout | tests/contract/nisabYearRecords.finalize.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.finalize.test.ts
JWT_SECRET (jwt.ts): supersecret

stdout | tests/contract/nisabYearRecords.finalize.test.ts > POST /api/nisab-year-records/:id/finalize - Contract Tests > Successful Finalization > should finalize DRAFT record when Hawl is complete
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfaah00020g2qcnx47frc 

stdout | tests/contract/nisabYearRecords.finalize.test.ts > POST /api/nisab-year-records/:id/finalize - Contract Tests > Successful Finalization > should finalize DRAFT record when Hawl is complete
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfaah00020g2qcnx47frc with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfaah00020g2qcnx47frc/finalize [32m200[0m 42.809 ms - -[0m
[0mPOST /api/nisab-year-records/cmldqfacy00060g2qlwlz6dgt/finalize [33m409[0m 7.889 ms - 115[0m
stdout | tests/contract/nisabYearRecords.finalize.test.ts > POST /api/nisab-year-records/:id/finalize - Contract Tests > Successful Finalization > should allow finalization with override flag even when Hawl early
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfacy00060g2qlwlz6dgt 

stdout | tests/contract/nisabYearRecords.finalize.test.ts > POST /api/nisab-year-records/:id/finalize - Contract Tests > Successful Finalization > should allow finalization with override flag even when Hawl early
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfacy00060g2qlwlz6dgt with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfacy00060g2qlwlz6dgt/finalize [32m200[0m 35.299 ms - -[0m
[0mPOST /api/nisab-year-records/cmldqfaf7000a0g2q1nuj4d0r/finalize [33m409[0m 6.244 ms - 115[0m
[0mPOST /api/nisab-year-records/cmldqfag9000c0g2quogne1pz/finalize [33m409[0m 8.375 ms - 115[0m
[0mPOST /api/nisab-year-records/cmldqfah1000e0g2qrdsh9d3d/finalize [33m409[0m 3.764 ms - 96[0m
[0mPOST /api/nisab-year-records/00000000-0000-0000-0000-000000000000/finalize [33m404[0m 2.675 ms - 66[0m
[0mPOST /api/nisab-year-records/some-id/finalize [33m401[0m 0.399 ms - 94[0m
 âœ“ tests/contract/nisabYearRecords.finalize.test.ts (7 tests) 302ms
stdout | tests/contract/nisabYearRecords.getById.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.post.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-fc9b3855d301172a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-fc9b3855d301172a.db

stdout | tests/contract/nisabYearRecords.get.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.get.test.ts
JWT_SECRET (jwt.ts): supersecret

[0mGET /api/nisab-year-records [32m200[0m 19.986 ms - 86[0m
stdout | tests/contract/nisabYearRecords.post.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mGET /api/nisab-year-records [32m200[0m 9.580 ms - -[0m
[0mGET /api/nisab-year-records?status=DRAFT [32m200[0m 7.040 ms - -[0m
[0mGET /api/nisab-year-records?status=FINALIZED [32m200[0m 4.064 ms - -[0m
[0mGET /api/nisab-year-records?year=2025 [32m200[0m 4.381 ms - -[0m
[0mGET /api/nisab-year-records?status=ALL [32m200[0m 3.761 ms - -[0m
[0mGET /api/nisab-year-records [33m401[0m 0.411 ms - 94[0m
[0mGET /api/nisab-year-records [33m401[0m 0.620 ms - 91[0m
[0mGET /api/nisab-year-records [32m200[0m 2.863 ms - 86[0m
[0mGET /api/nisab-year-records/cmldqfbgi000f0g3jys3fno94 [32m200[0m 13.208 ms - -[0m
 âœ“ tests/contract/nisabYearRecords.get.test.ts (10 tests) 326ms
stdout | tests/contract/nisabYearRecords.put.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6d9badf5afad1699.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6d9badf5afad1699.db

stdout | tests/contract/nisabYearRecords.getById.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.getById.test.ts
JWT_SECRET (jwt.ts): supersecret

[0mGET /api/nisab-year-records/cmldqfbut00020g4fxxpnohnl [32m200[0m 30.599 ms - -[0m
[0mGET /api/nisab-year-records/cmldqfbut00020g4fxxpnohnl [32m200[0m 5.028 ms - -[0m
[0mGET /api/nisab-year-records/00000000-0000-0000-0000-000000000000 [33m404[0m 6.312 ms - 66[0m
[0mGET /api/nisab-year-records/cmldqfbut00020g4fxxpnohnl [33m401[0m 0.363 ms - 94[0m
[0mGET /api/nisab-year-records/cmldqfbut00020g4fxxpnohnl [33m404[0m 3.823 ms - 66[0m
[0mGET /api/nisab-year-records/cmldqfbut00020g4fxxpnohnl [32m200[0m 6.741 ms - -[0m
[0mGET /api/nisab-year-records/cmldqfbut00020g4fxxpnohnl [32m200[0m 4.243 ms - -[0m
 â¯ tests/contract/nisabYearRecords.getById.test.ts (7 tests | 1 failed) 192ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Successful Retrieval > should return 200 with complete record data 62ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Successful Retrieval > should include live tracking for DRAFT records 14ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 404 for non-existent record ID 11ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 401 without auth token 5ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 404 when accessing another user's record 31ms
   âœ“ GET /api/nisab-year-records/:id - Contract Tests > Response Schema Validation > should return correct response structure 13ms
   Ã— GET /api/nisab-year-records/:id - Contract Tests > Response Schema Validation > should decrypt sensitive fields for display 14ms
     â†’ expected 'number' to be 'string' // Object.is equality
stdout | tests/contract/nisabYearRecords.unlock.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-322d42250067fb2a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-322d42250067fb2a.db

stdout | tests/contract/nisabYearRecords.put.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.post.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create DRAFT record with required fields
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create DRAFT record with required fields
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfcp200010g574r42hns1 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create DRAFT record with required fields
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfcp200010g574r42hns1 for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 42.322 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create record with silver nisab basis
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create record with silver nisab basis
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfcr100040g571bwfq8qk 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create record with silver nisab basis
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfcr100040g571bwfq8qk for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 27.958 ms - 797[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate nisabThresholdAtStart if not provided
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.unlock.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate nisabThresholdAtStart if not provided
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfcs300070g57bav8r1kv 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate nisabThresholdAtStart if not provided
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfcs300070g57bav8r1kv for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 30.748 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept user-provided nisabThresholdAtStart
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept user-provided nisabThresholdAtStart
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfctg000a0g57tufu4f00 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept user-provided nisabThresholdAtStart
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfctg000a0g57tufu4f00 for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 23.333 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept optional userNotes field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept optional userNotes field
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfcum000d0g57u501xy6r 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept optional userNotes field
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfcum000d0g57u501xy6r for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 18.897 ms - 825[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate hawlCompletionDate (354 days after start)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate hawlCompletionDate (354 days after start)
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfcvl000g0g57m4tjn1bt 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate hawlCompletionDate (354 days after start)
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfcvl000g0g57m4tjn1bt for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 19.340 ms - 795[0m
[0mPOST /api/nisab-year-records [33m400[0m 2.702 ms - 82[0m
[0mPOST /api/nisab-year-records [33m400[0m 1.144 ms - 90[0m
[0mPOST /api/nisab-year-records [33m400[0m 1.187 ms - 90[0m
[0mPOST /api/nisab-year-records [33m400[0m 1.435 ms - 91[0m
[0mPOST /api/nisab-year-records [33m400[0m 0.846 ms - 97[0m
[0mPOST /api/nisab-year-records [33m401[0m 1.467 ms - 94[0m
[0mPOST /api/nisab-year-records [33m401[0m 0.825 ms - 91[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should create record with authenticated user ID
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should create record with authenticated user ID
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfcxt000j0g574yz0f3tt 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should create record with authenticated user ID
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfcxt000j0g574yz0f3tt for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 25.085 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should return correct response structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should return correct response structure
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfcyo000m0g5747azzvj7 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should return correct response structure
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfcyo000m0g5747azzvj7 for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 18.224 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should include Hijri dates in response
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should include Hijri dates in response
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfczi000p0g57xjdo7brc 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should include Hijri dates in response
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfczi000p0g57xjdo7brc for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 20.494 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should encrypt sensitive fields in database
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should encrypt sensitive fields in database
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfd0c000s0g57rrqcl7wh 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should encrypt sensitive fields in database
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfd0c000s0g57rrqcl7wh for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 19.343 ms - 795[0m
stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should set correct initial status to DRAFT
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should set correct initial status to DRAFT
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfd16000v0g57cldjfkdp 

stdout | tests/contract/nisabYearRecords.post.test.ts > POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should set correct initial status to DRAFT
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfd16000v0g57cldjfkdp for user cmldqfcnj00000g57f79rw8eu 

[0mPOST /api/nisab-year-records [32m201[0m 19.553 ms - 795[0m
 â¯ tests/contract/nisabYearRecords.post.test.ts (18 tests | 2 failed) 533ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create DRAFT record with required fields 85ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should create record with silver nisab basis 53ms
   Ã— POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate nisabThresholdAtStart if not provided 50ms
     â†’ expected 0 to be greater than 0
   Ã— POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept user-provided nisabThresholdAtStart 44ms
     â†’ expected +0 to be 5687.2 // Object.is equality
   âœ“ POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should accept optional userNotes field 29ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Successful Record Creation > should calculate hawlCompletionDate (354 days after start) 34ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when hawlStartDate is missing 7ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when nisabBasis is missing 7ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when nisabBasis is invalid 7ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when hawlStartDate is invalid format 8ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Request Validation > should return 400 when nisabThresholdAtStart is negative 5ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should return 401 without auth token 8ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should return 401 with invalid token 7ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Authentication & Authorization > should create record with authenticated user ID 34ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should return correct response structure 28ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Response Schema Validation > should include Hijri dates in response 30ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should encrypt sensitive fields in database 30ms
   âœ“ POST /api/nisab-year-records - Contract Tests > Business Logic Validation > should set correct initial status to DRAFT 30ms
stdout | tests/integration/assetRefresh.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b03736b4558d007a.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b03736b4558d007a.db

stdout | tests/contract/nisabYearRecords.put.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.put.test.ts
JWT_SECRET (jwt.ts): supersecret

stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update userNotes on DRAFT record
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqfdmi00020g5z74f8yhbp 

stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update userNotes on DRAFT record
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqfdmi00020g5z74f8yhbp 

[0mPUT /api/nisab-year-records/cmldqfdmi00020g5z74f8yhbp [32m200[0m 40.169 ms - -[0m
stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update totalLiabilities on DRAFT record
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqfdou00060g5zdegnpbt5 

stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update totalLiabilities on DRAFT record
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqfdou00060g5zdegnpbt5 

[0mPUT /api/nisab-year-records/cmldqfdou00060g5zdegnpbt5 [32m200[0m 20.450 ms - -[0m
stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqfdq1000a0g5zs7ft53fm 

stdout | tests/contract/nisabYearRecords.put.test.ts > PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqfdq1000a0g5zs7ft53fm 

[0mPUT /api/nisab-year-records/cmldqfdq1000a0g5zs7ft53fm [32m200[0m 20.366 ms - -[0m
[0mPUT /api/nisab-year-records/cmldqfdre000e0g5zohe1vspo [33m409[0m 8.403 ms - 94[0m
[0mPUT /api/nisab-year-records/00000000-0000-0000-0000-000000000000 [33m404[0m 4.464 ms - 66[0m
[0mPUT /api/nisab-year-records/some-id [33m401[0m 1.638 ms - 94[0m
 â¯ tests/contract/nisabYearRecords.put.test.ts (6 tests | 1 failed) 254ms
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update userNotes on DRAFT record 85ms
   Ã— PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update totalLiabilities on DRAFT record 43ms
     â†’ expected '0' to be '1500' // Object.is equality
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Update Records > should update UNLOCKED record 49ms
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Update Restriction Validation > should reject updates to FINALIZED records 25ms
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 404 for non-existent record 8ms
   âœ“ PUT /api/nisab-year-records/:id - Contract Tests > Error Cases > should return 401 without auth token 5ms
stdout | tests/integration/assetRefresh.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/contract/nisabYearRecords.unlock.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/finalization.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4a057f7ced55375f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-4a057f7ced55375f.db

stdout | tests/contract/nisabYearRecords.unlock.test.ts
JWT_SECRET (jwt.ts): supersecret

stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Successful Unlock > should unlock FINALIZED record with valid reason
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfe3s00020g6njidzss8s 

stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Successful Unlock > should unlock FINALIZED record with valid reason
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfe3s00020g6njidzss8s with reason: Need to correct tota... 

[0mPOST /api/nisab-year-records/cmldqfe3s00020g6njidzss8s/unlock [32m200[0m 44.669 ms - -[0m
stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Successful Unlock > should create audit trail entry with unlock reason
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfe6b00060g6ng0p4fuly 

stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Successful Unlock > should create audit trail entry with unlock reason
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfe6b00060g6ng0p4fuly with reason: Discovered uncounted... 

[0mPOST /api/nisab-year-records/cmldqfe6b00060g6ng0p4fuly/unlock [32m200[0m 22.755 ms - -[0m
[0mPOST /api/nisab-year-records/cmldqfe7o000a0g6ntdgnycl4/unlock [33m400[0m 1.850 ms - 81[0m
[0mPOST /api/nisab-year-records/cmldqfe89000c0g6n0rj8cxga/unlock [33m400[0m 1.004 ms - 100[0m
[0mPOST /api/nisab-year-records/cmldqfe90000e0g6ntzow1olw/unlock [33m409[0m 21.105 ms - 90[0m
[0mPOST /api/nisab-year-records/cmldqfea8000g0g6nf6v8lgmu/unlock [33m409[0m 3.712 ms - 93[0m
[0mPOST /api/nisab-year-records/00000000-0000-0000-0000-000000000000/unlock [33m404[0m 4.330 ms - 66[0m
[0mPOST /api/nisab-year-records/some-id/unlock [33m401[0m 0.550 ms - 94[0m
[0mPOST /api/nisab-year-records/cmldqfebf000i0g6nm2sqa4bw/unlock [33m404[0m 5.483 ms - 66[0m
stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Response Schema Validation > should return correct response structure
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfeco000l0g6np039d40r 

stdout | tests/contract/nisabYearRecords.unlock.test.ts > POST /api/nisab-year-records/:id/unlock - Contract Tests > Response Schema Validation > should return correct response structure
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfeco000l0g6np039d40r with reason: Correction needed fo... 

[0mPOST /api/nisab-year-records/cmldqfeco000l0g6np039d40r/unlock [32m200[0m 20.554 ms - -[0m
 âœ“ tests/contract/nisabYearRecords.unlock.test.ts (10 tests) 391ms
stdout | tests/integration/hawlDetection.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-35013eee20e2fb34.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-35013eee20e2fb34.db

stdout | tests/integration/finalization.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/assetRefresh.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetection.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 404.837 ms - -[0m
stdout | tests/integration/finalization.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 375.758 ms - -[0m
[0mPOST /api/assets [32m201[0m 17.614 ms - 503[0m
[0mPOST /api/assets [32m201[0m 26.876 ms - 508[0m
[0mPOST /api/assets [32m201[0m 14.043 ms - 510[0m
[0mGET /api/nisab-year-records/cmldqffxc00080g7kqt3tkv4d/assets/refresh [32m200[0m 18.143 ms - 662[0m
[0mPOST /api/auth/register [32m201[0m 395.723 ms - -[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfg9c00030g8c434lyrs3 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfg9c00030g8c434lyrs3 for user cmldqfg7p00000g8cxe0ffy16 

[0mPOST /api/nisab-year-records [32m201[0m 34.602 ms - 805[0m
[0mPOST /api/auth/register [32m201[0m 377.859 ms - -[0m
stdout | tests/integration/hawlDetection.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfg9c00030g8c434lyrs3 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfg9c00030g8c434lyrs3 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfg9c00030g8c434lyrs3/finalize [32m200[0m 27.520 ms - 821[0m
[0mPUT /api/nisab-year-records/cmldqfg9c00030g8c434lyrs3 [33m409[0m 8.594 ms - 94[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT finalize before Hawl completion date without override
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT finalize before Hawl completion date without override
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfgbs00080g8cb7ywowjb 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT finalize before Hawl completion date without override
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfgbs00080g8cb7ywowjb for user cmldqfg7p00000g8cxe0ffy16 

[0mPOST /api/nisab-year-records [32m201[0m 26.123 ms - 803[0m
[0mPOST /api/nisab-year-records/cmldqfgbs00080g8cb7ywowjb/finalize [33m409[0m 4.835 ms - 115[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should allow early finalization with override flag
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should allow early finalization with override flag
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfgda000b0g8c7dxpc3zc 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should allow early finalization with override flag
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfgda000b0g8c7dxpc3zc for user cmldqfg7p00000g8cxe0ffy16 

[0mPOST /api/nisab-year-records [32m201[0m 24.847 ms - 805[0m
[0mPOST /api/nisab-year-records/cmldqfgda000b0g8c7dxpc3zc/finalize [33m409[0m 4.152 ms - 115[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfge6000e0g8c97xb7h4q 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfge6000e0g8c97xb7h4q for user cmldqfg7p00000g8cxe0ffy16 

[0mPOST /api/nisab-year-records [32m201[0m 16.880 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfge6000e0g8c97xb7h4q 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should record FINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfge6000e0g8c97xb7h4q with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfge6000e0g8c97xb7h4q/finalize [32m200[0m 21.373 ms - 821[0m
[0mGET /api/nisab-year-records/cmldqfge6000e0g8c97xb7h4q/audit-trail [33m404[0m 2.480 ms - 199[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfgfn000j0g8c6059j3o9 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfgfn000j0g8c6059j3o9 for user cmldqfg7p00000g8cxe0ffy16 

[0mPOST /api/nisab-year-records [32m201[0m 15.611 ms - 803[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqffjv00000g7k966v3sj6 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqffjv00000g7k966v3sj6 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfgfn000j0g8c6059j3o9 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqffjv00000g7k966v3sj6 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should prevent deletion of FINALIZED record
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfgfn000j0g8c6059j3o9 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfgfn000j0g8c6059j3o9/finalize [32m200[0m 28.008 ms - 821[0m
[0mDELETE /api/nisab-year-records/cmldqfgfn000j0g8c6059j3o9 [33m409[0m 3.592 ms - 137[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfghb000o0g8ca0geblcm 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfghb000o0g8ca0geblcm for user cmldqfg7p00000g8cxe0ffy16 

[0mPOST /api/nisab-year-records [32m201[0m 22.119 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfghb000o0g8ca0geblcm 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should lock all financial values on finalization
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfghb000o0g8ca0geblcm with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfghb000o0g8ca0geblcm/finalize [32m200[0m 16.623 ms - 821[0m
[0mGET /api/nisab-year-records/cmldqfghb000o0g8ca0geblcm [32m200[0m 2.722 ms - 821[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfgim000t0g8czhk664ra 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfgim000t0g8czhk664ra for user cmldqfg7p00000g8cxe0ffy16 

[0mPOST /api/nisab-year-records [32m201[0m 19.553 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfgim000t0g8czhk664ra 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfgim000t0g8czhk664ra with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfgim000t0g8czhk664ra/finalize [32m200[0m 15.608 ms - 821[0m
[0mPOST /api/nisab-year-records/cmldqfgim000t0g8czhk664ra/finalize [33m409[0m 2.598 ms - 96[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfgju000y0g8cqelrus4w 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfgju000y0g8cqelrus4w for user cmldqfg7p00000g8cxe0ffy16 

[0mPOST /api/nisab-year-records [32m201[0m 17.634 ms - 805[0m
stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfgju000y0g8cqelrus4w 

stdout | tests/integration/finalization.test.ts > Integration: Finalization Workflow > should include finalizedAt timestamp
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfgju000y0g8cqelrus4w with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfgju000y0g8cqelrus4w/finalize [32m200[0m 16.189 ms - 821[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

 â¯ tests/integration/finalization.test.ts (8 tests | 7 failed) 861ms
   Ã— Integration: Finalization Workflow > should finalize DRAFT record after Hawl completion date 95ms
     â†’ expected 409 to be 403 // Object.is equality
   Ã— Integration: Finalization Workflow > should NOT finalize before Hawl completion date without override 46ms
     â†’ expected 409 to be 400 // Object.is equality
   Ã— Integration: Finalization Workflow > should allow early finalization with override flag 41ms
     â†’ expected 409 to be 200 // Object.is equality
   Ã— Integration: Finalization Workflow > should record FINALIZED event in audit trail 55ms
     â†’ expected 404 to be 200 // Object.is equality
   Ã— Integration: Finalization Workflow > should prevent deletion of FINALIZED record 55ms
     â†’ expected 409 to be 403 // Object.is equality
   Ã— Integration: Finalization Workflow > should lock all financial values on finalization 50ms
     â†’ expected +0 to be 11000 // Object.is equality
   Ã— Integration: Finalization Workflow > should NOT allow re-finalization of already FINALIZED record 47ms
     â†’ expected 409 to be 400 // Object.is equality
   âœ“ Integration: Finalization Workflow > should include finalizedAt timestamp 41ms
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 421.291 ms - -[0m
[0mGET /api/nisab-year-records/cmldqfgm5000f0g7kxlg3h4p4/assets/refresh [33m400[0m 2.739 ms - 96[0m
[0mPOST /api/auth/register [32m201[0m 417.404 ms - -[0m
[0mPOST /api/assets [32m201[0m 17.874 ms - 506[0m
[0mGET /api/nisab-year-records/status [32m200[0m 6.674 ms - 16[0m
[0mPOST /api/assets [32m201[0m 13.484 ms - 504[0m
[0mGET /api/nisab-year-records/status [32m200[0m 6.643 ms - 16[0m
[0mPOST /api/assets [32m201[0m 10.078 ms - 498[0m
[0mGET /api/nisab-year-records/status [32m200[0m 4.574 ms - 16[0m
stdout | tests/integration/hawlDetectionAssets.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-1a96c030de88557c.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-1a96c030de88557c.db

[0mPOST /api/assets [32m201[0m 13.361 ms - 502[0m
[0mGET /api/nisab-year-records/status [32m200[0m 3.792 ms - 16[0m
[0mPOST /api/assets [32m201[0m 14.912 ms - 496[0m
[0mGET /api/nisab-year-records/status [32m200[0m 5.146 ms - 16[0m
[0mGET /api/nisab-year-records/undefined [33m404[0m 5.663 ms - 66[0m
[0mPOST /api/assets [32m201[0m 13.398 ms - 498[0m
[0mGET /api/nisab-year-records/status [32m200[0m 4.095 ms - 16[0m
[0mPOST /api/assets [32m201[0m 11.965 ms - 495[0m
[0mGET /api/nisab-year-records/status [32m200[0m 3.120 ms - 16[0m
[0mGET /api/nisab-year-records/undefined [33m404[0m 3.526 ms - 66[0m
 â¯ tests/integration/hawlDetection.test.ts (6 tests | 6 failed) 737ms
   Ã— Integration: Nisab Achievement Detection > should detect Nisab achievement and create DRAFT record 74ms
     â†’ expected false to be true // Object.is equality
   Ã— Integration: Nisab Achievement Detection > should not create duplicate Hawl if active DRAFT exists 44ms
     â†’ expected false to be true // Object.is equality
   Ã— Integration: Nisab Achievement Detection > should use gold-based Nisab if gold threshold is lower 35ms
     â†’ expected false to be true // Object.is equality
   Ã— Integration: Nisab Achievement Detection > should lock Nisab threshold value at Hawl start 45ms
     â†’ expected undefined to be defined
   Ã— Integration: Nisab Achievement Detection > should calculate Hawl completion date as 354 days from start 33ms
     â†’ expected NaN to be 354 // Object.is equality
   Ã— Integration: Nisab Achievement Detection > should include Hijri date equivalents 38ms
     â†’ .toMatch() expects to receive a string, but got undefined
[0mPOST /api/auth/register [32m201[0m 390.786 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionJob.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-317e71fc6430bdf9.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-317e71fc6430bdf9.db

[0mPOST /api/auth/login [32m200[0m 348.416 ms - -[0m
[0mGET /api/nisab-year-records/cmldqfh7s000k0g7kw4rrydle/assets/refresh [33m400[0m 5.037 ms - 96[0m
stdout | tests/integration/hawlDetectionJob.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 375.608 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 353.368 ms - -[0m
[0mGET /api/nisab-year-records/clxxxxxxxxxxxxxxxxxxxxxxxx/assets/refresh [33m404[0m 5.185 ms - 66[0m
[0mPOST /api/auth/register [32m201[0m 334.992 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 322.157 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 350.193 ms - -[0m
stdout | tests/integration/hawlDetectionJob.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionJob.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 379.366 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 344.303 ms - -[0m
[0mGET /api/nisab-year-records/cmldqfivw000v0g7kqxkc8rxj/assets/refresh [33m403[0m 2.947 ms - 101[0m
[0mPOST /api/auth/login [32m200[0m 326.108 ms - -[0m
[0mPOST /api/assets [32m201[0m 20.814 ms - 506[0m
[0mPOST /api/assets [32m201[0m 30.984 ms - 500[0m
[0mPOST /api/auth/register [32m201[0m 345.624 ms - -[0m
[0mPOST /api/assets [32m201[0m 47.499 ms - 503[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

[0mPOST /api/auth/register [32m201[0m 409.347 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfiug00000ga0q9z3jaqb, wealth: 10500, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

[0mPOST /api/assets [32m201[0m 20.131 ms - 496[0m
stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[hawlDetectionJob] INFO: Starting Hawl detection & reconciliation job 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[hawlDetectionJob] INFO: Processing 1 users 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[AuditTrailService] INFO: Audit event recorded: NISAB_ACHIEVED for record cmldqfj8300060garfdek6roc 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should reconcile wealth drift in DRAFT records
[hawlDetectionJob] INFO: SAFETY NET: Started missed Hawl for user cmldqfj5e00000garkvei74x2 
[hawlDetectionJob] INFO: Hawl detection job complete: 1 users, 1 reconciled, 1 achievements, 0 interruptions, 0 completions, 0 errors, 32ms 

[0mPOST /api/assets [32m201[0m 11.683 ms - 495[0m
stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should detect missed Nisab achievement (Safety Net)
[hawlDetectionJob] INFO: Starting Hawl detection & reconciliation job 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should detect missed Nisab achievement (Safety Net)
[hawlDetectionJob] INFO: Processing 1 users 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should detect missed Nisab achievement (Safety Net)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionJob.test.ts > Integration: Hawl Detection & Reconciliation Job > should detect missed Nisab achievement (Safety Net)
[hawlDetectionJob] INFO: SAFETY NET: Detected missed Nisab achievement for user cmldqfj5e00000garkvei74x2 
[hawlDetectionJob] INFO: Hawl detection job complete: 1 users, 0 reconciled, 1 achievements, 0 interruptions, 0 completions, 0 errors, 9ms 

 âœ“ tests/integration/hawlDetectionJob.test.ts (2 tests) 568ms
[0mPOST /api/auth/login [32m200[0m 350.781 ms - -[0m
[0mPOST /api/assets [32m201[0m 15.357 ms - 498[0m
[0mPOST /api/assets [32m201[0m 20.018 ms - 500[0m
[0mGET /api/nisab-year-records/cmldqfjgy00140g7kfzbe7opi/assets/refresh [32m200[0m 4.620 ms - 263[0m
stdout | tests/integration/hawlInterruption.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6954194522e3dca0.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6954194522e3dca0.db

[0mPOST /api/auth/register [32m201[0m 354.034 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfiug00000ga0q9z3jaqb 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfiug00000ga0q9z3jaqb 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfiug00000ga0q9z3jaqb 

[0mPOST /api/auth/register [32m201[0m 354.715 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 391.145 ms - -[0m
[0mPOST /api/assets [32m201[0m 12.505 ms - 506[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfji4000d0ga0hy0yreep, wealth: 7500.5, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfj5f000w0g7kuam6xdi9 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfj5f000w0g7kuam6xdi9 

stdout | tests/integration/hawlInterruption.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 364.503 ms - -[0m
[0mPOST /api/assets [32m201[0m 9.756 ms - 495[0m
[0mPOST /api/assets [32m201[0m 11.155 ms - 505[0m
[0mPOST /api/assets [32m201[0m 9.709 ms - 503[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 14.341 ms - 495[0m
[0mGET /api/nisab-year-records/cmldqfk3p001h0g7k6pkkguw0/assets/refresh [32m200[0m 4.888 ms - 638[0m
[0mPOST /api/auth/register [32m201[0m 379.569 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfji4000d0ga0hy0yreep 

[0mPOST /api/auth/register [32m201[0m 355.603 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 338.137 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 8.833 ms - 495[0m
[0mPOST /api/assets [32m201[0m 8.674 ms - 515[0m
[0mPOST /api/assets [32m201[0m 10.405 ms - 495[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfk5r000m0ga0vwmxuibr, wealth: 8000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfjrc00150g7kj4fv9xgj 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfjrc00150g7kj4fv9xgj 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfjrc00150g7kj4fv9xgj 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfjrc00150g7kj4fv9xgj 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 378.823 ms - -[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 11.997 ms - 494[0m
[0mPOST /api/assets [32m201[0m 11.100 ms - 506[0m
[0mGET /api/nisab-year-records/cmldqfkpz001q0g7knbaaba6z/assets/refresh [32m200[0m 4.936 ms - 453[0m
stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqfkpz001q0g7knbaaba6z 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqfkpz001q0g7knbaaba6z 

[0mPUT /api/nisab-year-records/cmldqfkpz001q0g7knbaaba6z [32m200[0m 19.997 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 346.713 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfk5r000m0ga0vwmxuibr 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfk5r000m0ga0vwmxuibr 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfk5r000m0ga0vwmxuibr 

[0mPOST /api/auth/register [32m201[0m 346.283 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 355.058 ms - -[0m
[0mPOST /api/assets [32m201[0m 10.132 ms - 499[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfkri000z0ga02eshbng2, wealth: 10000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

stdout | tests/integration/hawlInterruption.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfkds001i0g7ksaza5pyj 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfkds001i0g7ksaza5pyj 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/assetRefresh.test.ts > Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 360.801 ms - -[0m
[0mGET /api/nisab-year-records/some-id/assets/refresh [33m401[0m 0.410 ms - 94[0m
 âœ“ tests/integration/assetRefresh.test.ts (9 tests) 7883ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return current assets for DRAFT record  952ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for FINALIZED record  840ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 400 for UNLOCKED record  778ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 404 for non-existent record  760ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should return 403 when accessing another user's record  1404ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should handle assets deleted after record creation  772ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should only return zakatable assets  809ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should allow updating record with refreshed assets and persist zakatable wealth correctly  837ms
   âœ“ Asset Refresh Workflow Integration Test > GET /api/nisab-year-records/:id/assets/refresh > should require authentication  730ms
[0mPOST /api/auth/register [32m201[0m 341.460 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 379.579 ms - -[0m
[0mPOST /api/assets [32m201[0m 17.573 ms - 506[0m
[0mPOST /api/assets [32m201[0m 10.536 ms - 495[0m
[0mGET /api/nisab-year-records/status [32m200[0m 7.278 ms - 16[0m
[0mGET /api/assets [32m200[0m 5.526 ms - 678[0m
[0mPOST /api/assets [32m201[0m 9.264 ms - 498[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfkri000z0ga02eshbng2 

stdout | tests/integration/invalidOperations.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-419abce4153896dd.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-419abce4153896dd.db

[0mPOST /api/assets [32m201[0m 14.725 ms - 497[0m
[0mPOST /api/assets [32m201[0m 12.660 ms - 497[0m
[0mGET /api/nisab-year-records/status [32m200[0m 3.784 ms - 16[0m
[0mPOST /api/assets [32m201[0m 9.013 ms - 495[0m
[0mGET /api/nisab-year-records/status [32m200[0m 3.364 ms - 16[0m
[0mGET /api/assets [32m200[0m 2.833 ms - 678[0m
[0mPOST /api/assets [32m201[0m 12.177 ms - 498[0m
[0mGET /api/nisab-year-records/status [32m200[0m 3.524 ms - 16[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

 â¯ tests/integration/hawlInterruption.test.ts (6 tests | 6 failed) 645ms
   Ã— Integration: Hawl Interruption > should detect Hawl interruption when wealth drops below Nisab 30ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Integration: Hawl Interruption > should archive interrupted DRAFT record 47ms
     â†’ Cannot read properties of undefined (reading '0')
   Ã— Integration: Hawl Interruption > should allow new Hawl to start after interruption if wealth rises again 24ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Integration: Hawl Interruption > should not interrupt if wealth temporarily fluctuates but stays above Nisab 55ms
     â†’ expected false to be true // Object.is equality
   Ã— Integration: Hawl Interruption > should record interruption in audit trail 33ms
     â†’ Cannot read properties of undefined (reading '0')
   Ã— Integration: Hawl Interruption > should clear Hawl completion date on interruption 26ms
     â†’ expected undefined to be defined
[0mPOST /api/auth/login [32m200[0m 357.759 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets
[HawlTrackingService] INFO: Nisab detection complete: 0 DRAFT records created 

stdout | tests/integration/liveTracking.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e2983e7820b50421.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-e2983e7820b50421.db

[0mPOST /api/auth/register [32m201[0m 370.543 ms - -[0m
stdout | tests/integration/invalidOperations.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/login [32m200[0m 362.869 ms - -[0m
[0mPOST /api/assets [32m201[0m 13.038 ms - 504[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with assets below Nisab
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with assets below Nisab
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with assets below Nisab
[HawlTrackingService] INFO: Nisab detection complete: 0 DRAFT records created 

stdout | tests/integration/liveTracking.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 347.082 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfly7001d0ga0hhmp465r 

[0mPOST /api/auth/login [32m200[0m 334.891 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 10.494 ms - 505[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfmka001k0ga0f23lrjyj, wealth: 10000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

[0mPOST /api/auth/register [32m201[0m 347.390 ms - -[0m
stdout | tests/integration/invalidOperations.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfmka001k0ga0f23lrjyj 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/login [32m200[0m 339.478 ms - -[0m
[0mPOST /api/assets [32m201[0m 13.832 ms - 496[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfn5p001t0ga0h17ksfpb, wealth: 10000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved
[HawlTrackingService] INFO: Nisab detection complete: 0 DRAFT records created 

stdout | tests/integration/liveTracking.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 384.588 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 360.215 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 357.611 ms - -[0m
[0mGET /api/nisab-year-records [33m401[0m 0.781 ms - 94[0m
[0mGET /api/nisab-year-records [33m401[0m 1.114 ms - 91[0m
[0mGET /api/nisab-year-records [33m401[0m 1.589 ms - 91[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from accessing another user's records
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from accessing another user's records
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfnw400060gcd9yjbo46e 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from accessing another user's records
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfnw400060gcd9yjbo46e for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 28.176 ms - 805[0m
[0mPOST /api/auth/register [32m201[0m 409.854 ms - -[0m
[0mGET /api/nisab-year-records/cmldqfnw400060gcd9yjbo46e [33m404[0m 6.971 ms - 66[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from modifying another user's records
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 18.637 ms - 503[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from modifying another user's records
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfnxg00090gcdbtybevbg 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from modifying another user's records
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfnxg00090gcdbtybevbg for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 21.908 ms - 803[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfn5p001t0ga0h17ksfpb 

[0mPUT /api/nisab-year-records/cmldqfnxg00090gcdbtybevbg [33m404[0m 6.972 ms - 66[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from deleting another user's records
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfny400050gcxv8fhzmj2 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfny400050gcxv8fhzmj2 for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/nisab-year-records [32m201[0m 28.809 ms - 797[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from deleting another user's records
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfnyh000c0gcdz6m1evps 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from deleting another user's records
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfnyh000c0gcdz6m1evps for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 20.310 ms - 803[0m
[0mGET /api/nisab-year-records/status [32m200[0m 8.440 ms - 222[0m
[0mDELETE /api/nisab-year-records/cmldqfnyh000c0gcdz6m1evps [33m404[0m 4.030 ms - 66[0m
[0mPOST /api/nisab-year-records [33m400[0m 0.957 ms - 82[0m
[0mPOST /api/nisab-year-records [33m400[0m 0.905 ms - 90[0m
[0mGET /api/nisab-year-records/cmldqfny400050gcxv8fhzmj2 [32m200[0m 9.756 ms - -[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid Hawl completion date (not 354 days)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid Hawl completion date (not 354 days)
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfnzl000f0gcdblv9vx6p 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid Hawl completion date (not 354 days)
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfnzl000f0gcdblv9vx6p for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 23.741 ms - 806[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject negative wealth values
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 30.410 ms - 503[0m
[0mGET /api/nisab-year-records/cmldqfny400050gcxv8fhzmj2 [32m200[0m 5.142 ms - -[0m
[0mPOST /api/assets [33m400[0m 1.402 ms - 191[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject negative wealth values
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfo0k000i0gcdnizrxhy8 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject negative wealth values
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfo0k000i0gcdnizrxhy8 for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 36.949 ms - 805[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject Zakat amount not equal to 2.5% of zakatable wealth
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/assets [32m201[0m 22.271 ms - 506[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject Zakat amount not equal to 2.5% of zakatable wealth
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfo1z000l0gcdzthnobrv 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Validation Errors > should reject Zakat amount not equal to 2.5% of zakatable wealth
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfo1z000l0gcdzthnobrv for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 32.281 ms - 805[0m
[0mPOST /api/auth/login [32m200[0m 362.649 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mGET /api/nisab-year-records/cmldqfny400050gcxv8fhzmj2 [32m200[0m 9.958 ms - -[0m
[0mGET /api/nisab-year-records/nonexistent_id_12345 [33m404[0m 4.917 ms - 66[0m
[0mPOST /api/nisab-year-records/fake_id/finalize [33m404[0m 4.684 ms - 66[0m
[0mPOST /api/assets [32m201[0m 14.893 ms - 506[0m
[0mPOST /api/nisab-year-records/fake_id/unlock [33m400[0m 1.585 ms - 81[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject finalization before Hawl completion without override
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mGET /api/nisab-year-records/cmldqfny400050gcxv8fhzmj2 [32m200[0m 9.464 ms - -[0m
[0mPOST /api/assets [32m201[0m 13.927 ms - 505[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject finalization before Hawl completion without override
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfo3m000o0gcd46jflxzw 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject finalization before Hawl completion without override
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfo3m000o0gcd46jflxzw for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 25.101 ms - 805[0m
[0mPOST /api/assets [32m201[0m 12.564 ms - 501[0m
[0mGET /api/nisab-year-records/cmldqfny400050gcxv8fhzmj2 [32m200[0m 7.608 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

[0mPOST /api/nisab-year-records/cmldqfo3m000o0gcd46jflxzw/finalize [33m409[0m 7.053 ms - 115[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfnrt00220ga0qem2a15l, wealth: 7000, Nisab: 5686.2 

[0mPOST /api/assets [32m201[0m 15.032 ms - 515[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

[0mGET /api/nisab-year-records/cmldqfny400050gcxv8fhzmj2 [32m200[0m 8.875 ms - -[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfo4w000r0gcd2akrzfoy 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfo4w000r0gcd2akrzfoy for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 33.424 ms - 805[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfo4w000r0gcd2akrzfoy 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfo4w000r0gcd2akrzfoy with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfo4w000r0gcd2akrzfoy/finalize [32m200[0m 32.008 ms - 821[0m
[0mPOST /api/nisab-year-records/cmldqfo4w000r0gcd2akrzfoy/unlock [33m400[0m 1.447 ms - 81[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfo6z000w0gcd75amnuio 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfo6z000w0gcd75amnuio for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 32.650 ms - 803[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfo6z000w0gcd75amnuio 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfo6z000w0gcd75amnuio with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfo6z000w0gcd75amnuio/finalize [32m200[0m 26.386 ms - 821[0m
[0mPOST /api/nisab-year-records/cmldqfo6z000w0gcd75amnuio/unlock [33m400[0m 4.681 ms - 81[0m
stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Edge Cases > should handle very large wealth values
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Edge Cases > should handle very large wealth values
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfo9e00110gcdmy67k59z 

stdout | tests/integration/invalidOperations.test.ts > Integration: Invalid Operations and Error Handling > Edge Cases > should handle very large wealth values
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfo9e00110gcdmy67k59z for user cmldqfnk800000gcd9e1nm843 

[0mPOST /api/nisab-year-records [32m201[0m 29.723 ms - 831[0m
[0mPOST /api/nisab-year-records [33m400[0m 5.991 ms - 145[0m
[0mPOST /api/nisab-year-records [31m500[0m 7.868 ms - 49[0m
 â¯ tests/integration/invalidOperations.test.ts (20 tests | 11 failed) 1358ms
   âœ“ Integration: Invalid Operations and Error Handling > Authentication Errors > should reject requests without auth token 6ms
   âœ“ Integration: Invalid Operations and Error Handling > Authentication Errors > should reject requests with invalid token 4ms
   âœ“ Integration: Invalid Operations and Error Handling > Authentication Errors > should reject requests with expired token 5ms
   Ã— Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from accessing another user's records 48ms
     â†’ expected 404 to be 403 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from modifying another user's records 39ms
     â†’ expected 404 to be 403 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Authorization Errors > should prevent user from deleting another user's records 31ms
     â†’ expected 404 to be 403 // Object.is equality
   âœ“ Integration: Invalid Operations and Error Handling > Validation Errors > should reject creation with missing required fields 4ms
   âœ“ Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid nisabBasis value 4ms
   Ã— Integration: Invalid Operations and Error Handling > Validation Errors > should reject invalid Hawl completion date (not 354 days) 29ms
     â†’ expected 201 to be 400 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Validation Errors > should reject negative wealth values 42ms
     â†’ expected 201 to be 400 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Validation Errors > should reject Zakat amount not equal to 2.5% of zakatable wealth 45ms
     â†’ expected 201 to be 400 // Object.is equality
   âœ“ Integration: Invalid Operations and Error Handling > Not Found Errors > should return 404 for non-existent record 14ms
   Ã— Integration: Invalid Operations and Error Handling > Not Found Errors > should return 400 when finalizing non-existent record 9ms
     â†’ expected 404 to be 400 // Object.is equality
   âœ“ Integration: Invalid Operations and Error Handling > Not Found Errors > should return 400 when unlocking non-existent record 5ms
   Ã— Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject finalization before Hawl completion without override 43ms
     â†’ expected 409 to be 400 // Object.is equality
   Ã— Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock without reason 79ms
     â†’ expected 'unlockReason is required' to contain 'reason'
   Ã— Integration: Invalid Operations and Error Handling > Business Logic Errors > should reject unlock with reason too short 84ms
     â†’ expected 'unlockReason is required' to contain '10 characters'
   âœ“ Integration: Invalid Operations and Error Handling > Edge Cases > should handle very large wealth values 38ms
   Ã— Integration: Invalid Operations and Error Handling > Edge Cases > should handle concurrent edits to same record 12ms
     â†’ Cannot read properties of undefined (reading 'id')
   âœ“ Integration: Invalid Operations and Error Handling > Edge Cases > should handle malformed JSON in request body 12ms
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/assets [32m201[0m 231.082 ms - 497[0m
[0mPOST /api/assets [32m201[0m 221.342 ms - 497[0m
[0mPOST /api/assets [32m201[0m 226.012 ms - 497[0m
[0mPOST /api/assets [32m201[0m 187.726 ms - 498[0m
[0mPOST /api/assets [32m201[0m 234.921 ms - 497[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/assets [32m201[0m 253.021 ms - 497[0m
[0mPOST /api/assets [32m201[0m 213.981 ms - 498[0m
[0mPOST /api/assets [32m201[0m 211.151 ms - 498[0m
[0mPOST /api/assets [32m201[0m 275.639 ms - 497[0m
[0mPOST /api/assets [32m201[0m 220.155 ms - 498[0m
[0mPOST /api/assets [32m201[0m 223.341 ms - 498[0m
[0mPOST /api/assets [32m201[0m 300.488 ms - 497[0m
[0mPOST /api/assets [32m201[0m 302.910 ms - 497[0m
[0mPOST /api/assets [32m201[0m 180.609 ms - 498[0m
[0mPOST /api/assets [32m201[0m 163.403 ms - 498[0m
[0mPOST /api/assets [32m201[0m 193.291 ms - 498[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/assets [32m201[0m 182.366 ms - 498[0m
[0mPOST /api/assets [32m201[0m 220.489 ms - 498[0m
[0mPOST /api/assets [32m201[0m 186.481 ms - 498[0m
[0mPOST /api/assets [32m201[0m 174.850 ms - 498[0m
[0mPOST /api/assets [32m201[0m 332.801 ms - 497[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/auth/register [32m201[0m 395.337 ms - -[0m
[0mPOST /api/assets [32m201[0m 219.331 ms - 498[0m
[0mPOST /api/assets [32m201[0m 199.473 ms - 498[0m
[0mPOST /api/assets [32m201[0m 218.338 ms - 498[0m
[0mPOST /api/assets [32m201[0m 209.312 ms - 498[0m
[0mPOST /api/assets [32m201[0m 227.547 ms - 498[0m
[0mPOST /api/assets [32m201[0m 221.054 ms - 498[0m
[0mPOST /api/assets [32m201[0m 225.666 ms - 498[0m
[0mPOST /api/assets [32m201[0m 382.864 ms - 498[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/assets [32m201[0m 414.528 ms - 497[0m
[0mPOST /api/assets [32m201[0m 412.323 ms - 498[0m
[0mPOST /api/assets [32m201[0m 418.716 ms - 498[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-af14906472984a4b.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-af14906472984a4b.db

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnrt00220ga0qem2a15l 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnrt00220ga0qem2a15l 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/auth/login [32m200[0m 353.433 ms - -[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/assets [32m201[0m 15.717 ms - 502[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

[0mPOST /api/assets [32m201[0m 13.295 ms - 503[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfogp002d0ga07vzkur0y, wealth: 7000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation)
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/statusTransitions.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfogp002d0ga07vzkur0y 

[0mPOST /api/auth/register [32m201[0m 367.042 ms - -[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfogp002d0ga07vzkur0y 

[0mPOST /api/auth/login [32m200[0m 327.699 ms - -[0m
[0mPOST /api/assets [32m201[0m 8.134 ms - 502[0m
stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[HawlTrackingService] INFO: Created DRAFT record for user cmldqfp6i002o0ga0qx0c7pyf, wealth: 10000, Nisab: 5686.2 

stdout | tests/integration/hawlDetectionAssets.test.ts > Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure
[HawlTrackingService] INFO: Nisab detection complete: 1 DRAFT records created 

 âœ“ tests/integration/hawlDetectionAssets.test.ts (11 tests) 9008ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create DRAFT record with assetBreakdown populated when Nisab achieved  898ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should include correct asset details in snapshot  827ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should only include zakatable assets in snapshot  816ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should encrypt assetBreakdown field  776ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with no assets  743ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle user with assets below Nisab  814ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should create snapshot at exact moment of detection  768ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should not create duplicate records if Nisab already achieved  782ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should handle assets with zero value  862ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > Asset Snapshot Creation > should preserve asset order by addedAt date  952ms
   âœ“ Automatic Asset Inclusion in Hawl Detection > JSON Structure Validation > should match exact assetBreakdown JSON structure  762ms
stdout | tests/integration/unlockEdit.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-231145d539ac2ff4.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-231145d539ac2ff4.db

stdout | tests/integration/statusTransitions.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/unlockEdit.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 366.940 ms - -[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfqdv00030geksjruzbro 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfqdv00030geksjruzbro for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 24.407 ms - 805[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfqdv00030geksjruzbro 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfqdv00030geksjruzbro with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfqdv00030geksjruzbro/finalize [32m200[0m 22.936 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfqfc00080gek0kh9hz0h 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfqfc00080gek0kh9hz0h for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 19.670 ms - 803[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfqfc00080gek0kh9hz0h 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfqfc00080gek0kh9hz0h with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfqfc00080gek0kh9hz0h/finalize [32m200[0m 14.951 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfqfc00080gek0kh9hz0h 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfqfc00080gek0kh9hz0h with reason: Valid reason for unl... 

[0mPOST /api/nisab-year-records/cmldqfqfc00080gek0kh9hz0h/unlock [32m200[0m 14.461 ms - 820[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfqgx000f0gektd35u1rc 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfqgx000f0gektd35u1rc for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 16.585 ms - 803[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfqgx000f0gektd35u1rc 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfqgx000f0gektd35u1rc with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfqgx000f0gektd35u1rc/finalize [32m200[0m 16.288 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfqgx000f0gektd35u1rc 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfqgx000f0gektd35u1rc with reason: Unlocking for necess... 

[0mPOST /api/nisab-year-records/cmldqfqgx000f0gektd35u1rc/unlock [32m200[0m 16.984 ms - 820[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfqgx000f0gektd35u1rc 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization)
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfqgx000f0gektd35u1rc with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfqgx000f0gektd35u1rc/finalize [32m200[0m 15.840 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow DRAFT â†’ UNLOCKED transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow DRAFT â†’ UNLOCKED transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfqj4000o0gekai2qiuxc 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow DRAFT â†’ UNLOCKED transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfqj4000o0gekai2qiuxc for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 17.646 ms - 803[0m
[0mPOST /api/nisab-year-records/cmldqfqj4000o0gekai2qiuxc/unlock [33m409[0m 8.828 ms - 90[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfqjz000r0gekybjhgpnk 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfqjz000r0gekybjhgpnk for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 17.952 ms - 803[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfqjz000r0gekybjhgpnk 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfqjz000r0gekybjhgpnk with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfqjz000r0gekybjhgpnk/finalize [32m200[0m 15.348 ms - 821[0m
[0mPUT /api/nisab-year-records/cmldqfqjz000r0gekybjhgpnk [33m400[0m 0.973 ms - 113[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfql5000w0gekjzc2z9h2 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfql5000w0gekjzc2z9h2 for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 18.692 ms - 805[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfql5000w0gekjzc2z9h2 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfql5000w0gekjzc2z9h2 with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfql5000w0gekjzc2z9h2/finalize [32m200[0m 16.789 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfql5000w0gekjzc2z9h2 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfql5000w0gekjzc2z9h2 with reason: Unlocking for correc... 

[0mPOST /api/nisab-year-records/cmldqfql5000w0gekjzc2z9h2/unlock [32m200[0m 15.998 ms - 820[0m
[0mPUT /api/nisab-year-records/cmldqfql5000w0gekjzc2z9h2 [33m400[0m 0.860 ms - 113[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow direct status field updates
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow direct status field updates
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfqmw00130gek0sv7yixr 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > Invalid Transitions > should NOT allow direct status field updates
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfqmw00130gek0sv7yixr for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 15.356 ms - 805[0m
[0mPUT /api/nisab-year-records/cmldqfqmw00130gek0sv7yixr [33m400[0m 0.677 ms - 113[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfqni00160gekaeozvqob 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfqni00160gekaeozvqob for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 17.924 ms - 805[0m
[0mGET /api/nisab-year-records/cmldqfqni00160gekaeozvqob [32m200[0m 4.548 ms - 1013[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfqni00160gekaeozvqob 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfqni00160gekaeozvqob with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfqni00160gekaeozvqob/finalize [32m200[0m 31.604 ms - 821[0m
[0mGET /api/nisab-year-records/cmldqfqni00160gekaeozvqob [32m200[0m 2.142 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfqni00160gekaeozvqob 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfqni00160gekaeozvqob with reason: Correction needed af... 

[0mPOST /api/nisab-year-records/cmldqfqni00160gekaeozvqob/unlock [32m200[0m 13.906 ms - 820[0m
[0mGET /api/nisab-year-records/cmldqfqni00160gekaeozvqob [32m200[0m 2.220 ms - 820[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfqpv001d0gekrt6d9v7o 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfqpv001d0gekrt6d9v7o for user cmldqfqce00000gekrrfpsn9o 

[0mPOST /api/nisab-year-records [32m201[0m 20.873 ms - 805[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfqpv001d0gekrt6d9v7o 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfqpv001d0gekrt6d9v7o with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfqpv001d0gekrt6d9v7o/finalize [32m200[0m 15.992 ms - 821[0m
stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfqpv001d0gekrt6d9v7o 

stdout | tests/integration/statusTransitions.test.ts > Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfqpv001d0gekrt6d9v7o with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfqpv001d0gekrt6d9v7o/finalize [32m200[0m 34.395 ms - 821[0m
 â¯ tests/integration/statusTransitions.test.ts (9 tests | 1 failed) 900ms
   âœ“ Integration: Status Transition Validation > Valid Transitions > should allow DRAFT â†’ FINALIZED transition 57ms
   âœ“ Integration: Status Transition Validation > Valid Transitions > should allow FINALIZED â†’ UNLOCKED transition 59ms
   âœ“ Integration: Status Transition Validation > Valid Transitions > should allow UNLOCKED â†’ FINALIZED transition (re-finalization) 77ms
   âœ“ Integration: Status Transition Validation > Invalid Transitions > should NOT allow DRAFT â†’ UNLOCKED transition 32ms
   âœ“ Integration: Status Transition Validation > Invalid Transitions > should NOT allow FINALIZED â†’ DRAFT transition 42ms
   âœ“ Integration: Status Transition Validation > Invalid Transitions > should NOT allow UNLOCKED â†’ DRAFT transition 63ms
   âœ“ Integration: Status Transition Validation > Invalid Transitions > should NOT allow direct status field updates 20ms
   âœ“ Integration: Status Transition Validation > State Transition Constraints > should maintain status integrity across multiple operations 84ms
   Ã— Integration: Status Transition Validation > State Transition Constraints > should prevent concurrent status changes 63ms
     â†’ expected 0 to be greater than or equal to 1
stdout | tests/performance/wealthAggregation.performance.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-906177cd94b2637d.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-906177cd94b2637d.db

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should calculate wealth for 500 assets in < 100ms

âœ“ Wealth calculation: 7ms for 500 assets

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should maintain consistent performance across 10 runs

âœ“ Average: 5.50ms
  Min: 5ms, Max: 6ms

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)

ðŸ“Š Performance scaling:

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)
  50 assets: 2ms (target: <50ms)

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)
  100 assets: 2ms (target: <75ms)

stdout | tests/integration/unlockEdit.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)
  250 assets: 3ms (target: <90ms)

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should handle incremental load (50, 100, 250, 500 assets)
  500 assets: 5ms (target: <100ms)

stdout | tests/performance/wealthAggregation.performance.test.ts > WealthAggregationService Performance > should efficiently query with userId + isActive index

âœ“ Indexed query: 7ms (excellent performance)

 âœ“ tests/performance/wealthAggregation.performance.test.ts (4 tests) 344ms
stdout | tests/unit/EncryptionServiceAltSeparator.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c0d1b6db32993bef.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c0d1b6db32993bef.db

 â¯ tests/unit/EncryptionServiceAltSeparator.test.ts (2 tests | 1 failed) 12ms
   âœ“ EncryptionService alternative separator handling > should decrypt encrypted payloads where separator has been replaced with `.=`, and isEncrypted should detect it 4ms
   Ã— EncryptionService alternative separator handling > PaymentRecordService should decrypt fields that use ".=" separator 7ms
     â†’ expected NaN to be close to 12.34, received difference is NaN, but expected 0.005
[0mPOST /api/auth/register [32m201[0m 372.338 ms - -[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfrkf00030gfeamv272ym 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfrkf00030gfeamv272ym for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 25.894 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
CREATE RESPONSE STATUS: [33m201[39m
CREATE RESPONSE BODY: {
  "success": true,
  "data": {
    "id": "cmldqfrkf00030gfeamv272ym",
    "userId": "cmldqfriz00000gfex7uk4vb9",
    "hawlStartDate": "2025-02-08T12:41:45.028Z",
    "hawlStartDateHijri": "1444-06-08",
    "hawlCompletionDate": "2026-01-29T12:41:45.028Z",
    "hawlCompletionDateHijri": "1445-06-08",
    "nisabThresholdAtStart": 0,
    "nisabBasis": "GOLD",
    "totalWealth": 10000,
    "totalLiabilities": 0,
    "zakatableWealth": 10000,
    "zakatAmount": 250,
    "methodologyUsed": "standard",
    "assetBreakdown": "G2/6Ap7kfwnWZcd4:jhA=:mNUHUcWmsGXkzHwWlA/HHw==",
    "calculationDetails": "{}",
    "status": "DRAFT",
    "finalizedAt": null,
    "userNotes": null,
    "calculationDate": "2026-02-08T12:41:45.038Z",
    "gregorianYear": 2026,
    "gregorianMonth": 2,
    "gregorianDay": 8,
    "hijriYear": 1444,
    "hijriMonth": 6,
    "hijriDay": 8,
    "isPrimary": false,
    "createdAt": "2026-02-08T12:41:45.040Z",
    "updatedAt": "2026-02-08T12:41:45.040Z"
  }
}

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfrkf00030gfeamv272ym 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfrkf00030gfeamv272ym with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfrkf00030gfeamv272ym/finalize [32m200[0m 22.615 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfrkf00030gfeamv272ym 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfrkf00030gfeamv272ym with reason: Need to correct asse... 

[0mPOST /api/nisab-year-records/cmldqfrkf00030gfeamv272ym/unlock [32m200[0m 15.291 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfrmr000a0gfetgtfyuaz 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfrmr000a0gfetgtfyuaz for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 19.610 ms - 803[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfrmr000a0gfetgtfyuaz 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfrmr000a0gfetgtfyuaz with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfrmr000a0gfetgtfyuaz/finalize [32m200[0m 14.682 ms - 821[0m
[0mPOST /api/nisab-year-records/cmldqfrmr000a0gfetgtfyuaz/unlock [33m400[0m 0.933 ms - 100[0m
stdout | src/__tests__/integration/admin-system.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a9c0bdc04c3d2ff8.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-a9c0bdc04c3d2ff8.db

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfrpc000f0gfe5ww6qkft 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfrpc000f0gfe5ww6qkft for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 18.363 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfrpc000f0gfe5ww6qkft 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfrpc000f0gfe5ww6qkft with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfrpc000f0gfe5ww6qkft/finalize [32m200[0m 20.008 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfrpc000f0gfe5ww6qkft 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfrpc000f0gfe5ww6qkft with reason: Correcting asset val... 

[0mPOST /api/nisab-year-records/cmldqfrpc000f0gfe5ww6qkft/unlock [32m200[0m 17.567 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqfrpc000f0gfe5ww6qkft 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqfrpc000f0gfe5ww6qkft 

[0mPUT /api/nisab-year-records/cmldqfrpc000f0gfe5ww6qkft [32m200[0m 21.807 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfrsd000o0gfei0fap2wd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfrsd000o0gfei0fap2wd for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 22.643 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfrsd000o0gfei0fap2wd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfrsd000o0gfei0fap2wd with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfrsd000o0gfei0fap2wd/finalize [32m200[0m 21.951 ms - 823[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfrsd000o0gfei0fap2wd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfrsd000o0gfei0fap2wd with reason: Discovered missing l... 

[0mPOST /api/nisab-year-records/cmldqfrsd000o0gfei0fap2wd/unlock [32m200[0m 17.011 ms - 822[0m
[0mGET /api/nisab-year-records/cmldqfrsd000o0gfei0fap2wd/audit [32m200[0m 8.392 ms - -[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfrv8000v0gfeddqmzpkd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfrv8000v0gfeddqmzpkd for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 17.383 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfrv8000v0gfeddqmzpkd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfrv8000v0gfeddqmzpkd with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfrv8000v0gfeddqmzpkd/finalize [32m200[0m 17.309 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfrv8000v0gfeddqmzpkd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfrv8000v0gfeddqmzpkd with reason: Correcting calculati... 

[0mPOST /api/nisab-year-records/cmldqfrv8000v0gfeddqmzpkd/unlock [32m200[0m 15.661 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqfrv8000v0gfeddqmzpkd 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqfrv8000v0gfeddqmzpkd 

[0mPUT /api/nisab-year-records/cmldqfrv8000v0gfeddqmzpkd [32m200[0m 17.165 ms - 820[0m
[0mGET /api/nisab-year-records/cmldqfrv8000v0gfeddqmzpkd/audit [32m200[0m 4.805 ms - -[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfry000140gfem6msey8d 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfry000140gfem6msey8d for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 16.252 ms - 803[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfry000140gfem6msey8d 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfry000140gfem6msey8d with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfry000140gfem6msey8d/finalize [32m200[0m 15.998 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfry000140gfem6msey8d 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfry000140gfem6msey8d with reason: Correcting valuation... 

[0mPOST /api/nisab-year-records/cmldqfry000140gfem6msey8d/unlock [32m200[0m 13.854 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqfry000140gfem6msey8d 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqfry000140gfem6msey8d 

[0mPUT /api/nisab-year-records/cmldqfry000140gfem6msey8d [32m200[0m 28.471 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfry000140gfem6msey8d 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfry000140gfem6msey8d with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfry000140gfem6msey8d/finalize [32m200[0m 29.175 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfs1u001f0gfenkmzdrcs 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfs1u001f0gfenkmzdrcs for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 18.634 ms - 803[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfs1u001f0gfenkmzdrcs 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfs1u001f0gfenkmzdrcs with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfs1u001f0gfenkmzdrcs/finalize [32m200[0m 18.173 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfs1u001f0gfenkmzdrcs 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfs1u001f0gfenkmzdrcs with reason: Fixing data entry mi... 

[0mPOST /api/nisab-year-records/cmldqfs1u001f0gfenkmzdrcs/unlock [32m200[0m 15.067 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: EDITED for record cmldqfs1u001f0gfenkmzdrcs 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record updated: cmldqfs1u001f0gfenkmzdrcs 

[0mPUT /api/nisab-year-records/cmldqfs1u001f0gfenkmzdrcs [32m200[0m 15.713 ms - 820[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfs1u001f0gfenkmzdrcs 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfs1u001f0gfenkmzdrcs with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfs1u001f0gfenkmzdrcs/finalize [32m200[0m 18.656 ms - 821[0m
[0mGET /api/nisab-year-records/cmldqfs1u001f0gfenkmzdrcs/audit [32m200[0m 9.122 ms - -[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should NOT allow unlocking DRAFT record
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | src/__tests__/integration/admin-system.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should NOT allow unlocking DRAFT record
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfs5a001q0gfe1ojx5d3w 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should NOT allow unlocking DRAFT record
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfs5a001q0gfe1ojx5d3w for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 21.116 ms - 804[0m
[0mPOST /api/nisab-year-records/cmldqfs5a001q0gfe1ojx5d3w/unlock [33m409[0m 6.226 ms - 90[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[AuditTrailService] INFO: Audit event recorded: CREATED for record cmldqfs6j001t0gfeskb4pk3v 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[NisabYearRecordService] INFO: Nisab Year Record created: cmldqfs6j001t0gfeskb4pk3v for user cmldqfriz00000gfex7uk4vb9 

[0mPOST /api/nisab-year-records [32m201[0m 15.472 ms - 805[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[AuditTrailService] INFO: Audit event recorded: FINALIZED for record cmldqfs6j001t0gfeskb4pk3v 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[NisabYearRecordService] INFO: Nisab Year Record finalized: cmldqfs6j001t0gfeskb4pk3v with Zakat 0 

[0mPOST /api/nisab-year-records/cmldqfs6j001t0gfeskb4pk3v/finalize [32m200[0m 16.377 ms - 821[0m
stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[AuditTrailService] INFO: Audit event recorded: UNLOCKED for record cmldqfs6j001t0gfeskb4pk3v 

stdout | tests/integration/unlockEdit.test.ts > Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail
[NisabYearRecordService] INFO: Nisab Year Record unlocked: cmldqfs6j001t0gfeskb4pk3v with reason: Correcting error due... 

[0mPOST /api/nisab-year-records/cmldqfs6j001t0gfeskb4pk3v/unlock [32m200[0m 14.938 ms - 820[0m
[0mGET /api/nisab-year-records/cmldqfs6j001t0gfeskb4pk3v/audit [32m200[0m 4.485 ms - -[0m
 â¯ tests/integration/unlockEdit.test.ts (9 tests | 1 failed) 1296ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should unlock FINALIZED record with valid reason 90ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should require unlock reason with minimum 10 characters 93ms
   Ã— Integration: Unlock-Edit-Refinalize Workflow > should allow editing of UNLOCKED record 110ms
     â†’ expected +0 to be 12000 // Object.is equality
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should record UNLOCKED event in audit trail with reason 103ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should record EDITED events with changes summary 98ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should allow re-finalization after edit 138ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should record REFINALIZED event in audit trail 124ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should NOT allow unlocking DRAFT record 47ms
   âœ“ Integration: Unlock-Edit-Refinalize Workflow > should encrypt unlock reason in audit trail 77ms
[0mPOST /api/assets [31m500[0m 5218.303 ms - 567[0m
[0mPOST /api/assets [31m500[0m 5223.800 ms - 567[0m
[0mPOST /api/assets [31m500[0m 5197.100 ms - 567[0m
[0mPOST /api/assets [32m201[0m 5361.354 ms - 498[0m
[0mPOST /api/assets [32m201[0m 5366.631 ms - 498[0m
[0mPOST /api/assets [32m201[0m 5378.506 ms - 498[0m
stdout | src/__tests__/integration/analytics-api.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-df1354f4ef32d1c8.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-df1354f4ef32d1c8.db

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should provide asset breakdown by category
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mGET /api/nisab-year-records/cmldqfny400050gcxv8fhzmj2 [32m200[0m 617.235 ms - -[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | src/__tests__/integration/analytics-api.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/admin-system.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 350.769 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 306.454 ms - -[0m
[0mGET /api/admin/system/status [32m200[0m 29.181 ms - 304[0m
[0mGET /api/admin/system/status/schema [32m200[0m 3.608 ms - 214[0m
stdout | src/__tests__/integration/analytics-api.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/auth/register [32m201[0m 317.885 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 351.722 ms - -[0m
[0mGET /api/analytics/summary [32m200[0m 29.930 ms - 841[0m
[0mGET /api/analytics/summary?year=2024 [32m200[0m 18.647 ms - 841[0m
[0mGET /api/analytics/summary?includeTrends=true [32m200[0m 22.038 ms - -[0m
[0mGET /api/analytics/metrics [32m200[0m 35.306 ms - -[0m
[0mGET /api/analytics/metrics?metricTypes=wealth_trend,zakat_trend [32m200[0m 19.504 ms - 763[0m
[0mGET /api/analytics/trends [32m200[0m 18.716 ms - 780[0m
[0mGET /api/analytics/trends?period=6months [32m200[0m 18.750 ms - 779[0m
[0mPOST /api/auth/login [32m200[0m 324.344 ms - -[0m
[0mGET /api/analytics/comparison [32m200[0m 16.247 ms - 421[0m
[0mGET /api/admin/system/status [33m403[0m 1.985 ms - 95[0m
 â¯ src/__tests__/integration/admin-system.test.ts (3 tests | 1 failed) 1412ms
   âœ“ Admin System API > GET /api/admin/system/status returns system status 36ms
   Ã— Admin System API > GET /api/admin/system/status/schema returns detailed schema info 14ms
     â†’ expected false to be true // Object.is equality
   âœ“ Admin System API > GET /api/admin/system/status requires admin privileges  654ms
[0mGET /api/analytics/comparison?period1=2025&period2=2026 [32m200[0m 10.911 ms - 416[0m
[0mPOST /api/analytics/cache/clear [32m200[0m 10.030 ms - 65[0m
 âœ“ src/__tests__/integration/analytics-api.test.ts (10 tests) 617ms
stdout | src/__tests__/integration/assets.api.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f905f444485d4750.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-f905f444485d4750.db

stdout | src/__tests__/integration/assets.eligibility.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b7788961cc5f342d.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b7788961cc5f342d.db

stdout | src/__tests__/integration/assets.eligibility.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/assets.api.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/assets.api.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/__tests__/integration/assets.eligibility.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

[0mPOST /api/assets [31m500[0m 10251.469 ms - 567[0m
[0mPOST /api/assets [31m500[0m 10349.192 ms - 567[0m
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

[0mPOST /api/auth/register [32m201[0m 360.626 ms - -[0m
[0mPOST /api/auth/register [32m201[0m 357.861 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 299.541 ms - -[0m
[0mPOST /api/auth/login [32m200[0m 300.103 ms - -[0m
[0mPOST /api/assets [32m201[0m 12.589 ms - 513[0m
 âœ“ src/__tests__/integration/assets.api.test.ts (1 test) 714ms
   âœ“ Integration: Auth and Assets API > should register, login, and create an asset successfully  712ms
[0mPOST /api/assets [32m201[0m 16.538 ms - 505[0m
[0mGET /api/assets [32m200[0m 5.876 ms - 693[0m
[0mPUT /api/assets/cmldqfwpe00040gjn2l64rl0m [32m200[0m 15.022 ms - 506[0m
[0mGET /api/assets [32m200[0m 4.607 ms - 691[0m
 âœ“ src/__tests__/integration/assets.eligibility.test.ts (1 test) 751ms
   âœ“ Integration: Asset eligibility and passive modifier > creates a passive asset, then disables eligibility and verifies summary excludes it  750ms
stdout | src/__tests__/integration/assets.passive.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-000d8da29c313bc0.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-000d8da29c313bc0.db

 âœ“ src/__tests__/integration/assets.passive.test.ts (5 tests) 5ms
stdout | src/__tests__/integration/encryption-admin.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d05083a059459299.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d05083a059459299.db

stdout | src/__tests__/unit/AnalyticsService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-bd9b620a84cb3f98.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-bd9b620a84cb3f98.db

 âœ“ src/__tests__/unit/AnalyticsService.test.ts (26 tests) 24ms
stdout | src/__tests__/unit/AnnualSummaryService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-cbcad92f47ac4236.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-cbcad92f47ac4236.db

stdout | src/__tests__/integration/encryption-admin.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 âœ“ src/__tests__/unit/AnnualSummaryService.test.ts (23 tests) 19ms
stdout | src/__tests__/unit/CalendarConversionService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b18541766abcddca.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-b18541766abcddca.db

stdout | src/__tests__/integration/encryption-admin.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 âœ“ src/__tests__/unit/CalendarConversionService.test.ts (20 tests) 26ms
stdout | src/__tests__/unit/ComparisonService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-adcc7b41227cb164.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-adcc7b41227cb164.db

 âœ“ src/__tests__/unit/ComparisonService.test.ts (23 tests) 21ms
[0mPOST /api/auth/register [32m201[0m 369.308 ms - -[0m
stdout | src/__tests__/unit/PaymentService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-0ba5576db7e81c61.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-0ba5576db7e81c61.db

 âœ“ src/__tests__/unit/PaymentService.test.ts (6 tests) 9ms
[0mPOST /api/auth/login [32m200[0m 327.905 ms - -[0m
[0mPOST /api/admin/encryption/scan [32m200[0m 8.856 ms - 28[0m
[0mGET /api/admin/encryption/issues [32m200[0m 2.435 ms - 28[0m
 â¯ src/__tests__/integration/encryption-admin.test.ts (2 tests | 2 failed) 792ms
   Ã— Admin Encryption Remediation API > scan creates remediation for prev-key encrypted payment 17ms
     â†’ expected 0 to be greater than or equal to 1
   Ã— Admin Encryption Remediation API > retry with correct previous key resolves remediation and re-encrypts 8ms
     â†’ expected undefined to be truthy
stdout | src/__tests__/unit/ReminderService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-fdd1d17de1d11352.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-fdd1d17de1d11352.db

 âœ“ src/__tests__/unit/ReminderService.test.ts (32 tests) 19ms
stdout | src/__tests__/utils/assetModifiers.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-ca901f8847f1078f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-ca901f8847f1078f.db

 âœ“ src/__tests__/utils/assetModifiers.test.ts (8 tests) 5ms
stdout | src/__tests__/utils/schemaCheck.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6333a9ef8d64bf84.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-6333a9ef8d64bf84.db

 âœ“ src/__tests__/utils/schemaCheck.test.ts (5 tests) 9ms
stdout | src/services/__tests__/AssetService.categoryNormalization.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c13f360e2bec4b61.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-c13f360e2bec4b61.db

stdout | src/services/__tests__/AssetService.categoryNormalization.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | src/services/__tests__/AssetService.update.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d8bc0d95a5fde9bb.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-d8bc0d95a5fde9bb.db

 âœ“ src/services/__tests__/AssetService.categoryNormalization.test.ts (2 tests) 28ms
stdout | src/services/__tests__/AssetService.update.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

 âœ“ src/services/__tests__/AssetService.update.test.ts (2 tests) 8ms
stdout | src/services/__tests__/EncryptionService.decryption-tolerance.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-15a47527cd351e28.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-15a47527cd351e28.db

 âœ“ src/services/__tests__/EncryptionService.decryption-tolerance.test.ts (3 tests) 6ms
stdout | src/services/__tests__/NisabService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2b0cee65a731f0ef.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-2b0cee65a731f0ef.db

[0mPOST /api/assets [31m500[0m 15267.225 ms - 567[0m
[0mPOST /api/assets [31m500[0m 15368.748 ms - 567[0m
stdout | src/services/__tests__/WealthAggregationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-904b179d30b2758f.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-904b179d30b2758f.db

 âœ“ src/services/__tests__/WealthAggregationService.test.ts (1 test) 5ms
 âœ“ src/services/__tests__/NisabService.test.ts (6 tests) 11ms
[0mGET /api/nisab-year-records/cmldqfny400050gcxv8fhzmj2 [32m200[0m 10096.616 ms - -[0m
[0mPOST /api/assets [32m201[0m 15605.943 ms - 498[0m
[0mPOST /api/assets [32m201[0m 15605.044 ms - 498[0m
[0mPOST /api/assets [32m201[0m 15607.598 ms - 498[0m
stdout | tests/unit/services/auditTrailService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-38ac581a57738718.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-38ac581a57738718.db

stdout | tests/unit/services/auditTrailService.test.ts > AuditTrailService > recordEvent > should record CREATED event for new Nisab Year Record
[AuditTrailService] INFO: Audit event recorded: CREATED for record record1 

 âœ“ tests/unit/services/auditTrailService.test.ts (4 tests) 18ms
stdout | tests/unit/services/hawlTrackingService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-ace54326d94cb49c.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-ace54326d94cb49c.db

stdout | tests/unit/services/hawlTrackingService.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > detectNisabAchievement > should process users and create DRAFT records if Nisab reached
[HawlTrackingService] INFO: Starting Nisab achievement detection for all users 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > detectNisabAchievement > should process users and create DRAFT records if Nisab reached
[HawlTrackingService] INFO: Nisab detection complete: 0 DRAFT records created 

stdout | tests/unit/services/nisabCalculationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-772c85b9a0565b60.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-772c85b9a0565b60.db

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > handleWealthChange > should start Hawl if wealth >= Nisab and no active Hawl
[HawlTrackingService] INFO: Handling wealth change for user user1 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > handleWealthChange > should interrupt Hawl if wealth < Nisab and active Hawl exists
[HawlTrackingService] INFO: Handling wealth change for user user1 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > handleWealthChange > should do nothing if wealth < Nisab and no active Hawl
[HawlTrackingService] INFO: Handling wealth change for user user1 

stdout | tests/unit/services/hawlTrackingService.test.ts > HawlTrackingService > handleWealthChange > should do nothing if wealth >= Nisab and active Hawl exists
[HawlTrackingService] INFO: Handling wealth change for user user1 

 â¯ tests/unit/services/hawlTrackingService.test.ts (9 tests | 3 failed) 40ms
   âœ“ HawlTrackingService > calculateHawlCompletionDate > should add 354 days to start date for lunar year 5ms
   âœ“ HawlTrackingService > toHijriDate > should convert Gregorian date to Hijri format 2ms
   Ã— HawlTrackingService > detectNisabAchievement > should process users and create DRAFT records if Nisab reached 14ms
     â†’ expected +0 to be 1 // Object.is equality
   âœ“ HawlTrackingService > isHawlComplete > should return true if 354 days have passed 1ms
   âœ“ HawlTrackingService > isHawlComplete > should return false if 354 days have not passed 1ms
   Ã— HawlTrackingService > handleWealthChange > should start Hawl if wealth >= Nisab and no active Hawl 6ms
     â†’ expected "spy" to be called at least once
   Ã— HawlTrackingService > handleWealthChange > should interrupt Hawl if wealth < Nisab and active Hawl exists 5ms
     â†’ expected "spy" to be called with arguments: [ { where: { id: 'record1' } } ][90m

Number of calls: [1m0[22m
[39m
   âœ“ HawlTrackingService > handleWealthChange > should do nothing if wealth < Nisab and no active Hawl 2ms
   âœ“ HawlTrackingService > handleWealthChange > should do nothing if wealth >= Nisab and active Hawl exists 3ms
stdout | tests/unit/services/nisabCalculationService.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/unit/services/nisabCalculationService.test.ts > NisabCalculationService > calculateNisabThreshold > should use fallback prices if API fetch fails
[NisabCalculationService] INFO: Using fallback gold price: $65/gram 
[NisabCalculationService] INFO: Using fallback silver price: $0.75/gram 

 âœ“ tests/unit/services/nisabCalculationService.test.ts (4 tests) 9ms
stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/integration/liveTracking.test.ts > Integration: Live Wealth Tracking
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 
[HawlTrackingService] INFO: Handling wealth change for user cmldqfnvs00000gcx11lzgl6x 

stdout | tests/unit/services/nisabYearRecordService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-36525a8e92380992.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-36525a8e92380992.db

stdout | tests/unit/services/nisabYearRecordService.test.ts
[APP] INFO: GOLD_API_KEY not configured. Using fallback precious metal prices (Gold: $65/g, Silver: $0.75/g) 

stdout | tests/unit/services/wealthAggregationService.test.ts
Copied base database (761856 bytes) to /home/chuwi_agent/workspace/zakapp/server/prisma/test/test-81ad8fc5cf756479.db
Test database created successfully (761856 bytes)
Test DATABASE_URL: file:/home/chuwi_agent/workspace/zakapp/server/prisma/test/test-81ad8fc5cf756479.db

stdout | tests/unit/services/nisabYearRecordService.test.ts > NisabYearRecordService > createRecord > should create a new DRAFT Nisab Year Record
[NisabYearRecordService] INFO: Nisab Year Record created: record1 for user user1 

 âœ“ tests/unit/services/nisabYearRecordService.test.ts (4 tests) 12ms
 âœ“ tests/unit/services/wealthAggregationService.test.ts (6 tests) 11ms
[0mPOST /api/assets [31m500[0m 20380.399 ms - 567[0m
 â¯ tests/integration/liveTracking.test.ts (8 tests | 6 failed) 21379ms
   âœ“ Integration: Live Wealth Tracking > should update DRAFT record when asset is added 67ms
   Ã— Integration: Live Wealth Tracking > should update DRAFT record when asset value is modified 11ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Integration: Live Wealth Tracking > should update DRAFT record when asset is deleted 37ms
     â†’ Cannot read properties of undefined (reading 'id')
   Ã— Integration: Live Wealth Tracking > should recalculate Zakat amount when wealth changes 61ms
     â†’ expected NaN to be close to NaN, received difference is NaN, but expected 0.005
   âœ“ Integration: Live Wealth Tracking > should handle non-zakatable assets correctly 54ms
   Ã— Integration: Live Wealth Tracking > should meet performance requirement (<100ms for aggregation) 5005ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Integration: Live Wealth Tracking > should provide asset breakdown by category 632ms
     â†’ expected undefined to be defined
   Ã— Integration: Live Wealth Tracking > should update updatedAt timestamp on recalculation 5001ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

 Test Files  58 failed | 44 passed (102)
      Tests  148 failed | 667 passed | 34 skipped (849)
   Start at  12:40:29
   Duration  91.61s (transform 4.35s, setup 1.26s, collect 102.68s, tests 113.08s, environment 29ms, prepare 12.86s)

