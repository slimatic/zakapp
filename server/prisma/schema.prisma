// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  username       String?  @unique // Optional username for login
  passwordHash   String   // bcrypt hash
  profile        String?  // Encrypted JSON blob (name, location, methodology preference)
  settings       String?  // Encrypted JSON blob (currency, language, calendar type, reminders)
  isActive       Boolean  @default(true)
  userType       String   @default("USER") // USER, ADMIN_USER
  createdAt      DateTime @default(now())
  lastLoginAt    DateTime?
  updatedAt      DateTime @updatedAt

  // Zakat Preferences (Feature 004)
  preferredCalendar     String?   @default("gregorian") // 'hijri' or 'gregorian'
  preferredMethodology  String?   @default("standard")  // 'standard', 'hanafi', 'shafi', 'custom'
  lastZakatDate         DateTime? // Last Zakat payment date for calculating next due date

  // Resource Limits (SaaS)
  maxAssets        Int?      // Optional override for max assets
  maxNisabRecords  Int?      // Optional override for max nisab records
  maxPayments      Int?      // Optional override for max payments
  maxLiabilities   Int?      // Optional override for max liabilities

  // Relationships
  assets           Asset[]
  liabilities      Liability[]
  calculations     ZakatCalculation[]
  payments         ZakatPayment[]
  snapshots        AssetSnapshot[]
  sessions         UserSession[]
  
  // Tracking & Analytics Relationships
  yearlySnapshots  YearlySnapshot[]  @relation("UserYearlySnapshots")
  paymentRecords   PaymentRecord[]   @relation("UserPaymentRecords")
  analyticsMetrics AnalyticsMetric[] @relation("UserAnalyticsMetrics")
  annualSummaries  AnnualSummary[]   @relation("UserAnnualSummaries")
  reminderEvents   ReminderEvent[]   @relation("UserReminderEvents")

  // Nisab Year Record Audit Trail (NEW - Feature 008)
  auditTrailEntries AuditTrailEntry[] @relation("UserAuditTrails")

  // Calculation History (Feature 004)
  calculationHistory CalculationHistory[]

  // Methodology Configurations
  methodologyConfigs MethodologyConfig[]

  // Calculation Snapshots (Feature 004)
  calculationSnapshots CalculationSnapshot[]

  // Security and Password Reset
  security     UserSecurity?
  passwordResets PasswordReset[]

  @@map("users")
}

model Asset {
  id              String   @id @default(cuid())
  userId          String
  category        String   // cash, gold, silver, business, property, stocks, crypto
  name            String
  value           Float
  currency        String   @default("USD")
  acquisitionDate DateTime
  metadata        String?  // Encrypted JSON for category-specific details
  isActive        Boolean  @default(true)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Calculation modifier fields (Feature 021)
  calculationModifier  Float   @default(1.0)  // 0.0 (restricted), 0.3 (passive), 1.0 (full)
  isPassiveInvestment  Boolean @default(false)
  isRestrictedAccount  Boolean @default(false)

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshotValues SnapshotAssetValue[] // NEW relationship

  @@map("assets")
  @@index([userId])
  @@index([category])
  @@index([userId, category])
  @@index([userId, isActive])
  @@index([acquisitionDate])
  @@index([userId, isPassiveInvestment])
  @@index([userId, isRestrictedAccount])
}

model Liability {
  id        String    @id @default(cuid())
  userId    String
  type      String    // loan, mortgage, credit_card, business_debt, other
  name      String
  amount    Float
  currency  String    @default("USD")
  creditor  String?
  dueDate   DateTime?
  isActive  Boolean   @default(true)
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("liabilities")
  @@index([userId])
  @@index([type])
  @@index([userId, type])
  @@index([userId, isActive])
  @@index([dueDate])
}

model ZakatCalculation {
  id                    String   @id @default(cuid())
  userId                String
  calculationDate       DateTime
  methodology           String   // standard, hanafi, shafi_i, custom
  calendarType          String   // lunar, solar
  totalAssets           Float
  totalLiabilities      Float
  netWorth              Float
  nisabThreshold        Float
  nisabSource           String   // gold, silver
  isZakatObligatory     Boolean
  zakatAmount           Float
  zakatRate             Float    @default(0.025) // 2.5%
  breakdown             String   // JSON with detailed calculation steps
  assetsIncluded        String   // JSON snapshot of assets used
  liabilitiesIncluded   String   // JSON snapshot of liabilities used
  regionalAdjustments   String?  // JSON with local preferences
  createdAt             DateTime @default(now())

  // Relationships
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments ZakatPayment[]
  paymentRecords PaymentRecord[]

  @@map("zakat_calculations")
  @@index([userId])
  @@index([calculationDate])
  @@index([userId, calculationDate(sort: Desc)])
  @@index([methodology])
  @@index([calendarType])
}

model AssetSnapshot {
  id              String   @id @default(cuid())
  userId          String
  name            String?  // Snapshot name/title
  description     String?  // Snapshot description
  snapshotDate    DateTime
  snapshotType    String   // annual, custom, backup
  totalValue      Float
  totalAssets     Float?   // Total assets value
  totalLiabilities Float?  // Total liabilities value
  netWorth        Float?   // Net worth (assets - liabilities)
  assetCount      Int
  liabilitiesCount Int?    // Number of liabilities
  assetsData      String   // Complete encrypted JSON of all assets
  liabilitiesData String   // Complete encrypted JSON of all liabilities
  exchangeRates   String   // JSON with currency conversion rates
  islamicYear     String?  // Hijri year
  tags            String?  // JSON array of tags
  metadata        String?  // Additional metadata JSON
  notes           String?
  isLocked        Boolean  @default(false)
  createdAt       DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("asset_snapshots")
  @@index([userId])
  @@index([snapshotDate])
  @@index([userId, snapshotDate(sort: Desc)])
  @@index([snapshotType])
  @@index([isLocked])
  @@index([userId, isLocked])
}

model ZakatPayment {
  id                  String   @id @default(cuid())
  userId              String
  calculationId       String?
  paymentDate         DateTime
  amount              Float
  currency            String   @default("USD")
  recipients          String   // JSON array of payment recipients
  paymentMethod       String   // cash, bank_transfer, crypto, etc.
  receiptNumber       String?
  islamicYear         String   // Hijri year
  notes               String?
  status              String   @default("completed") // pending, completed, verified
  verificationDetails String?  // JSON with supporting documentation
  createdAt           DateTime @default(now())

  // Relationships
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  calculation ZakatCalculation? @relation(fields: [calculationId], references: [id])

  @@map("zakat_payments")
  @@index([userId])
  @@index([paymentDate])
  @@index([islamicYear])
  @@index([userId, paymentDate(sort: Desc)])
  @@index([userId, islamicYear])
  @@index([calculationId])
  @@index([status])
}

model CalculationMethodology {
  id                 String  @id @default(cuid())
  name               String  @unique // Standard, Hanafi, Shafi'i, Custom
  description        String
  scholarlySource    String
  nisabCalculation   String  // JSON rules for nisab determination
  assetRules         String  // JSON rules for asset handling
  liabilityRules     String  // JSON rules for liability deduction
  calendarRules      String  // JSON rules for lunar vs solar
  zakatRates         String  // JSON mapping of rates by category
  regionalVariations String  // JSON for local adaptations
  isActive           Boolean @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt

  @@map("calculation_methodologies")
}

model NisabThreshold {
  id                String   @id @default(cuid())
  effectiveDate     DateTime
  goldPricePerGram  Float
  silverPricePerGram Float
  currency          String   @default("USD")
  goldNisabGrams    Float    @default(87.48)  // Islamic scholarly consensus
  silverNisabGrams  Float    @default(612.36) // Islamic scholarly consensus
  goldNisabValue    Float    // Calculated: goldPricePerGram * goldNisabGrams
  silverNisabValue  Float    // Calculated: silverPricePerGram * silverNisabGrams
  priceSource       String   // API, manual entry
  exchangeRates     String   // JSON with major currency rates
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())

  @@map("nisab_thresholds")
  @@index([effectiveDate])
}

model UserSession {
  id                 String    @id @default(cuid())
  userId             String
  accessToken        String    // JWT access token (short-lived)
  refreshToken       String    // JWT refresh token (longer-lived)
  ipAddress          String?
  userAgent          String?
  issuedAt           DateTime
  expiresAt          DateTime
  refreshedAt        DateTime?
  isActive           Boolean   @default(true)
  terminatedAt       DateTime?
  terminationReason  String?   // logout, expire, security
  createdAt          DateTime  @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
  @@index([userId])
  @@index([accessToken])
  @@index([refreshToken])
  @@index([expiresAt])
}

// Implementation Verification Entities

model TestResult {
  id            String   @id @default(cuid())
  testType      String   // UNIT, INTEGRATION, E2E, CONTRACT, SECURITY, PERFORMANCE
  testName      String
  status        String   // PASSED, FAILED, SKIPPED, PENDING
  executionTime Int      // milliseconds
  coverage      Float    // 0-100 percentage
  errors        String?  // JSON array of error messages
  metadata      String?  // JSON blob for additional context
  feature       String   // Feature being tested
  createdAt     DateTime @default(now())

  // Relationships
  implementationGapId String?
  implementationGap   ImplementationGap? @relation(fields: [implementationGapId], references: [id])
  qualityMetrics      QualityMetric[]

  @@map("test_results")
  @@index([testType, status, createdAt])
  @@index([feature])
  @@unique([testType, testName])
}

model ImplementationGap {
  id                    String   @id @default(cuid())
  category              String   // MISSING_FEATURE, INCOMPLETE_FEATURE, SECURITY_VIOLATION, etc.
  severity              String   // CRITICAL, HIGH, MEDIUM, LOW
  description           String
  expectedBehavior      String
  actualBehavior        String
  affectedComponents    String?  // JSON array of component/file names
  constitutionalPrinciple String
  resolutionPlan        String
  estimatedEffort       Int      // hours
  assignedTo            String?
  status                String   // IDENTIFIED, IN_PROGRESS, RESOLVED, VERIFIED
  createdAt             DateTime @default(now())
  resolvedAt            DateTime?

  // Relationships
  testResults     TestResult[]
  qualityMetrics  QualityMetric[]

  @@map("implementation_gaps")
  @@index([severity, status])
  @@index([category])
}

model QualityMetric {
  id                  String   @id @default(cuid())
  metricType          String   // CODE_COVERAGE, PERFORMANCE, SECURITY_SCORE, etc.
  metricName          String
  currentValue        Float
  targetValue         Float
  thresholdMin        Float?
  thresholdMax        Float?
  thresholdOptimal    Float?
  unit                String   // %, ms, requests/sec, etc.
  measurementDate     DateTime @default(now())
  component           String
  environment         String   // DEVELOPMENT, TESTING, STAGING, PRODUCTION
  trend               String   // IMPROVING, STABLE, DEGRADING
  automatedCollection Boolean  @default(false)

  // Relationships
  testResultId         String?
  testResult           TestResult? @relation(fields: [testResultId], references: [id])
  implementationGapId  String?
  implementationGap    ImplementationGap? @relation(fields: [implementationGapId], references: [id])

  @@map("quality_metrics")
  @@index([metricType, component, measurementDate])
  @@index([environment])
}

model MigrationRecord {
  id              String   @id @default(cuid())
  migrationName   String
  sourceType      String   // USER_DATA, ASSET_DATA, CALCULATION_DATA, SETTINGS_DATA
  sourceLocation  String
  recordCount     Int
  successCount    Int
  failureCount    Int
  checksumBefore  String
  checksumAfter   String?
  migrationLog    String   // JSON array of log entries
  rollbackData    String?  // JSON blob for rollback
  status          String   // PENDING, IN_PROGRESS, COMPLETED, FAILED, PARTIALLY_COMPLETED
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  duration        Int?     // seconds

  @@map("migration_records")
  @@index([status, sourceType])
  @@index([migrationName])
}

// Encryption remediation entries for admin workflows to track undecryptable records
model EncryptionRemediation {
  id         String   @id @default(cuid())
  targetType String   // e.g., 'user_profile', 'payment', 'snapshot', etc.
  targetId   String   // the id of the target record (e.g., user id or payment id)
  status     String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, UNRECOVERABLE
  note       String?  // Admin or automated note about the remediation
  sampleData String?  // Short sample of the encrypted payload to inspect
  attemptCount Int    @default(0)
  createdBy  String?  // admin user id who created the remediation entry
  createdAt  DateTime @default(now())
  resolvedAt DateTime?

  @@map("encryption_remediations")
  @@index([targetType])
  @@index([targetId])
  @@index([status])
}

model ComplianceVerification {
  id                  String   @id @default(cuid())
  calculationType     String   // ZAKAT_STANDARD, ZAKAT_HANAFI, ZAKAT_SHAFII, etc.
  inputData           String   // JSON blob of input parameters
  expectedResult      Float
  actualResult        Float
  accuracy            Float    // 0-100 percentage
  authoritativeSource String
  sourceCitation      String
  verificationDate    DateTime @default(now())
  methodology         String
  currency            String
  marketData          String?  // JSON blob of market rates
  status              String   // PENDING, VERIFIED, DISCREPANCY, FAILED
  notes               String?

  @@map("compliance_verifications")
  @@index([calculationType, status])
  @@index([verificationDate])
}

model ApiContract {
  id                    String   @id @default(cuid())
  endpoint              String
  method                String   // GET, POST, PUT, DELETE, PATCH
  version               String
  requestSchema         String   // JSON schema
  responseSchema        String   // JSON schema
  authenticationRequired Boolean @default(false)
  rateLimitingRpm       Int?     // requests per minute
  rateLimitingRph       Int?     // requests per hour
  rateLimitingBurst     Int?     // burst limit
  expectedStatusCodes   String?  // JSON array of valid HTTP status codes
  errorHandling         String?  // JSON blob
  lastUpdated           DateTime @default(now())
  complianceStatus      String   // COMPLIANT, PARTIAL, NON_COMPLIANT, UNTESTED
  testCoverage          Float    // 0-100 percentage

  @@map("api_contracts")
  @@index([endpoint, method])
  @@index([complianceStatus])
  @@unique([endpoint, method, version])
}

model UserWorkflow {
  id                   String   @id @default(cuid())
  workflowName         String
  description          String
  userType             String   // NEW_USER, RETURNING_USER, ADMIN_USER
  steps                String   // JSON array of workflow steps
  prerequisites        String?  // JSON array of setup requirements
  testAutomated        Boolean  @default(false)
  criticalPath         Boolean  @default(false)
  estimatedDuration    Int      // minutes
  lastTested           DateTime?
  successRate          Float    // 0-100 percentage
  commonFailures       String?  // JSON array of common failure points
  browserChrome        Boolean  @default(false)
  browserFirefox       Boolean  @default(false)
  browserSafari        Boolean  @default(false)
  browserEdge          Boolean  @default(false)

  @@map("user_workflows")
  @@index([criticalPath, testAutomated])
  @@index([workflowName])
}

// ============================================================================
// Tracking & Analytics Models
// Feature: 003-tracking-analytics
// ============================================================================

model YearlySnapshot {
  id                     String   @id @default(cuid())
  userId                 String
  
  // Hawl Tracking (NEW FIELDS)
  hawlStartDate          DateTime?
  hawlStartDateHijri     String?
  hawlCompletionDate     DateTime?
  hawlCompletionDateHijri String?
  nisabThresholdAtStart  String?  // Encrypted - Value locked at Hawl start
  nisabBasis             String?  // "gold" or "silver"
  
  // Existing Fields (preserved)
  calculationDate        DateTime
  gregorianYear          Int
  gregorianMonth         Int
  gregorianDay           Int
  hijriYear              Int
  hijriMonth             Int
  hijriDay               Int
  totalWealth            String   // Encrypted
  totalLiabilities       String   // Encrypted
  zakatableWealth        String   // Encrypted
  zakatAmount            String   // Encrypted
  methodologyUsed        String
  nisabThreshold         String   // Encrypted (deprecated in favor of nisabThresholdAtStart)
  nisabType              String   // (deprecated in favor of nisabBasis)
  
  // Status Management (UPDATED - now supports DRAFT, FINALIZED, UNLOCKED)
  status                 String   // "DRAFT", "FINALIZED", "UNLOCKED"
  
  assetBreakdown         String   // Encrypted JSON
  calculationDetails     String   // Encrypted JSON
  userNotes              String?  // Encrypted
  isPrimary              Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  finalizedAt            DateTime? // NEW - Timestamp of finalization

  // Relationships
  user                   User              @relation("UserYearlySnapshots", fields: [userId], references: [id], onDelete: Cascade)
  payments               PaymentRecord[]
  summary                AnnualSummary?
  reminders              ReminderEvent[]
  auditTrail             AuditTrailEntry[] // NEW relationship

  @@map("nisab_year_records")
  @@index([userId, calculationDate(sort: Desc)])
  @@index([userId, gregorianYear])
  @@index([userId, hijriYear])
  @@index([userId, status])
  @@index([userId, isPrimary])
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, gregorianYear, gregorianMonth])
  @@index([userId, status, gregorianYear])
  @@index([userId, hawlStartDate]) // NEW: Hawl tracking indexes
  @@index([userId, hawlCompletionDate]) // NEW: Hawl completion queries
}

// NEW: Audit Trail Entry for Nisab Year Record unlock/edit events
model AuditTrailEntry {
  id                     String   @id @default(cuid())
  nisabYearRecordId      String   // Foreign key to YearlySnapshot (nisab_year_records)
  userId                 String   // User who performed the action
  eventType              String   // "UNLOCKED", "EDITED", "REFINALIZED", "CREATED", "FINALIZED"
  timestamp              DateTime @default(now())
  unlockReason           String?  // Encrypted - Required for UNLOCKED events (min 10 chars)
  changesSummary         String?  // Encrypted JSON - What fields were modified
  beforeState            String?  // Encrypted JSON - Snapshot before change
  afterState             String?  // Encrypted JSON - Snapshot after change
  ipAddress              String?  // Security tracking (optional)
  userAgent              String?  // Security tracking (optional)

  // Relationships
  nisabYearRecord        YearlySnapshot @relation(fields: [nisabYearRecordId], references: [id], onDelete: Cascade)
  user                   User            @relation("UserAuditTrails", fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_trail_entries")
  @@index([nisabYearRecordId, timestamp(sort: Desc)])
  @@index([userId, timestamp(sort: Desc)])
  @@index([eventType])
}

// NEW: Precious Metal Price Cache for Nisab calculations
model PreciousMetalPrice {
  id                     String   @id @default(cuid())
  metalType              String   // "gold" or "silver"
  pricePerGram           Float    // In base currency (USD)
  currency               String   @default("USD")
  fetchedAt              DateTime @default(now())
  sourceApi              String   @default("metals-api.com")
  expiresAt              DateTime // fetchedAt + 24 hours

  @@map("precious_metal_prices")
  @@index([metalType, fetchedAt(sort: Desc)])
  @@unique([metalType, fetchedAt]) // Prevent duplicate fetches
}

model PaymentRecord {
  id                  String   @id @default(cuid())
  userId              String
  snapshotId          String
  calculationId       String?  // Associated Zakat calculation
  amount              String   // Encrypted
  paymentDate         DateTime
  recipientName       String   // Encrypted
  recipientType       String
  recipientCategory   String
  notes               String?  // Encrypted
  receiptReference    String?  // Encrypted
  paymentMethod       String
  status              String   // recorded or verified
  currency            String   @default("USD")
  exchangeRate        Float    @default(1.0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relationships
  user                User            @relation("UserPaymentRecords", fields: [userId], references: [id], onDelete: Cascade)
  snapshot            YearlySnapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  calculation         ZakatCalculation? @relation(fields: [calculationId], references: [id])

  @@map("payment_records")
  @@index([userId, paymentDate(sort: Desc)])
  @@index([snapshotId])
  @@index([userId, snapshotId])
  @@index([userId, status])
  @@index([userId, recipientCategory])
  @@index([userId, createdAt(sort: Desc)])
}

model AnalyticsMetric {
  id                  String   @id @default(cuid())
  userId              String
  metricType          String
  startDate           DateTime
  endDate             DateTime
  calculatedValue     String   // Encrypted JSON
  visualizationType   String
  parameters          String   // JSON
  calculatedAt        DateTime @default(now())
  expiresAt           DateTime
  version             Int      @default(1)

  // Relationships
  user                User     @relation("UserAnalyticsMetrics", fields: [userId], references: [id], onDelete: Cascade)

  @@map("analytics_metrics")
  @@index([userId, metricType, expiresAt])
  @@index([expiresAt])
  @@index([userId, metricType, startDate, endDate])
  @@index([userId, calculatedAt(sort: Desc)])
}

model AnnualSummary {
  id                     String   @id @default(cuid())
  userId                 String
  snapshotId             String   @unique
  gregorianYear          Int
  hijriYear              Int
  startDate              DateTime
  endDate                DateTime
  totalZakatCalculated   String   // Encrypted
  totalZakatPaid         String   // Encrypted
  outstandingZakat       String   // Encrypted
  numberOfPayments       Int
  recipientSummary       String   // Encrypted JSON
  assetBreakdown         String   // Encrypted JSON
  comparativeAnalysis    String   // Encrypted JSON
  methodologyUsed        String
  nisabInfo              String   // Encrypted JSON
  userNotes              String?  // Encrypted
  generatedAt            DateTime @default(now())
  version                Int      @default(1)

  // Relationships
  user                   User            @relation("UserAnnualSummaries", fields: [userId], references: [id], onDelete: Cascade)
  snapshot               YearlySnapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("annual_summaries")
  @@index([userId, gregorianYear])
  @@index([userId, hijriYear])
  @@index([snapshotId])
  @@index([userId, generatedAt(sort: Desc)])
}

model ReminderEvent {
  id                  String    @id @default(cuid())
  userId              String
  eventType           String
  triggerDate         DateTime
  title               String
  message             String    // Encrypted
  priority            String    // high, medium, low
  status              String    // pending, shown, acknowledged, dismissed
  relatedSnapshotId   String?
  metadata            String?   // JSON
  acknowledgedAt      DateTime?
  createdAt           DateTime  @default(now())

  // Relationships
  user                User            @relation("UserReminderEvents", fields: [userId], references: [id], onDelete: Cascade)
  snapshot            YearlySnapshot? @relation(fields: [relatedSnapshotId], references: [id], onDelete: SetNull)

  @@map("reminder_events")
  @@index([userId, triggerDate])
  @@index([userId, status])
  @@index([userId, eventType])
  @@index([userId, status, triggerDate])
  @@index([userId, priority, status])
}

model CalculationHistory {
  id                String   @id @default(cuid())
  userId            String
  
  // Methodology and Calendar Info
  methodology       String   // 'standard', 'hanafi', 'shafi', 'custom'
  methodologyConfigId String? // FK to MethodologyConfig for custom methodologies
  calendarType      String   // 'hijri', 'gregorian'
  calculationDate   DateTime @default(now())
  
  // Zakat Year Boundaries
  zakatYearStart    DateTime
  zakatYearEnd      DateTime
  
  // Calculation Results (Encrypted)
  totalWealth       String   // Encrypted
  nisabThreshold    String   // Encrypted
  zakatDue          String   // Encrypted
  zakatRate         Float    @default(2.5)
  
  // Detailed Asset Breakdown (encrypted JSON)
  assetBreakdown    String   // Encrypted JSON of asset categories and values
  
  // Lock/Unlock Workflow (Immutability Control)
  isLocked          Boolean  @default(true)
  lockedAt          DateTime?
  unlockedAt        DateTime?
  unlockedBy        String?  // User ID who unlocked
  unlockReason      String?  // Audit trail for unlock
  
  // User Notes and Metadata
  notes             String?  // Encrypted
  metadata          String?  // Encrypted JSON for additional calculation details
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  // Relationships
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  methodologyConfig MethodologyConfig? @relation(fields: [methodologyConfigId], references: [id])

  @@map("calculation_history")
  @@index([userId, calculationDate])
  @@index([userId, methodology])
  @@index([calculationDate])
  @@index([isLocked])
}

model SnapshotAssetValue {
  id            String   @id @default(cuid())
  snapshotId    String
  assetId       String
  assetName     String   // Denormalized for historical accuracy
  assetCategory String   // Denormalized (cash, gold, silver, etc.)
  capturedValue String   // Encrypted value at calculation time
  capturedAt    DateTime @default(now())
  isZakatable   Boolean  // Based on methodology rules
  // Preserved modifier state at snapshot time (nullable for legacy snapshots)
  calculationModifier  Float?
  isPassiveInvestment  Boolean?
  isRestrictedAccount  Boolean?
  createdAt     DateTime @default(now())

  // Relationships
  snapshot      CalculationSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  asset         Asset               @relation(fields: [assetId], references: [id])

  @@map("snapshot_asset_values")
  @@index([snapshotId])
  @@index([assetId])
}

model MethodologyConfig {
  id             String   @id @default(cuid())
  userId         String
  name           String
  nisabBasis     String
  customNisabValue Float?
  rate           Float
  assetRules     String   // Encrypted JSON
  isCustom       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  // Relationships
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  calculations   CalculationHistory[] // Custom methodologies used in calculations
  calculationSnapshots CalculationSnapshot[] // Snapshots using this methodology config

  @@map("methodology_configs")
  @@index([userId])
}

model CalculationSnapshot {
  id                String   @id @default(cuid())
  userId            String
  calculationDate   DateTime @default(now())
  methodology       String   // "STANDARD" | "HANAFI" | "SHAFII" | "CUSTOM"
  methodologyConfigId String?  // FK to MethodologyConfig for CUSTOM
  totalWealth       String   // ENCRYPTED: Base64-encoded AES-256
  zakatDue          String   // ENCRYPTED: Base64-encoded AES-256
  nisabThreshold    String   // ENCRYPTED: Base64-encoded AES-256
  isLocked          Boolean  @default(true)
  lockedAt          DateTime?
  unlockedAt        DateTime?
  unlockedBy        String?  // User ID who unlocked
  unlockReason      String?  // Audit trail
  calendarType      String   // "GREGORIAN" | "HIJRI" (snapshot of user pref)
  zakatYearStart    DateTime // Start of Zakat year (Gregorian)
  zakatYearEnd      DateTime // End of Zakat year (Gregorian)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  // Relationships
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  methodologyConfig MethodologyConfig? @relation(fields: [methodologyConfigId], references: [id])
  assetValues       SnapshotAssetValue[]

  @@map("calculation_snapshots")
  @@index([userId, calculationDate])
  @@index([methodology])
  @@index([isLocked])
  @@index([userId, isLocked])
  @@index([userId, methodology])
  @@index([zakatYearStart])
  @@index([zakatYearEnd])
}

model UserSecurity {
  id            String   @id @default(cuid())
  userId        String   @unique
  failedAttempts Int      @default(0)
  lockedUntil   DateTime?
  lastFailedAt  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now())

  // Relationships
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_security")
}

model PasswordReset {
  id            String   @id @default(cuid())
  userId        String
  token         String   @unique
  expiresAt     DateTime
  used          Boolean  @default(false)
  createdAt     DateTime @default(now())

  // Relationships
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
  @@index([token])
  @@index([expiresAt])
}