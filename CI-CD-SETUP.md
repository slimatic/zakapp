# CI/CD Pipeline Setup

This document describes the CI/CD pipeline setup for the zakapp project.

## Changes Made

### 1. Root Package Lock File
- **File Added**: `package-lock.json`
- **Purpose**: Ensures consistent dependency versions across CI environments
- **Generated by**: `npm install --package-lock-only` in the root directory

### 2. GitHub Actions Workflows

#### Test Workflow (`.github/workflows/test.yml`)
- **Triggers**: Push to main, develop, and copilot/** branches; PRs to main and develop
- **Matrix Testing**: Tests on Node.js 18.x and 20.x
- **Steps**:
  1. Install root dependencies using `npm ci`
  2. Install and build shared package
  3. Install backend dependencies
  4. Run backend tests with coverage
  5. **Verify coverage file exists** (NEW: Added verification step)
  6. Upload coverage to Codecov
  7. Run frontend tests
  8. Upload frontend coverage to Codecov (with fail_ci_if_error: false)

**Quality Gates**: 
- âœ… No `continue-on-error` flags on critical test steps
- âœ… Coverage file verification before upload
- âœ… Backend tests must pass to proceed

#### Build Workflow (`.github/workflows/build.yml`)
- **Triggers**: Push to main and develop; PRs to main and develop
- **Matrix Testing**: Builds on Node.js 18.x and 20.x
- **Steps**:
  1. Install root dependencies
  2. Install and build shared package
  3. Install backend dependencies
  4. Lint and type-check backend
  5. Build backend
  6. Install, lint, and build frontend

**Quality Gates**: 
- âœ… No `continue-on-error` flags on any build steps
- âœ… Lint and type-check must pass
- âœ… Build failures will fail the workflow

### 3. Jest Configuration Updates (October 2025)

#### Backend Jest Setup (`backend/jest.setup.cjs`)
- **UPDATED**: Removed process.exit() mocking (anti-pattern removed)
- **Current Purpose**: Sets test timeout to 10 seconds for slower CI environments
- **Clean State**: No more mocking of console or process methods

#### Backend Jest Config (`backend/jest.config.cjs`)
- **Coverage Settings**:
  - `coverageDirectory: 'coverage'` - Explicit coverage output directory
  - `coverageReporters: ['json', 'lcov', 'text', 'clover']` - Multiple formats for Codecov
  - `coverageThreshold`: Conservative targets (40-50%) based on current coverage
- **Test Isolation**:
  - `testPathIgnorePatterns`: Excludes Playwright E2E tests from Jest runs
  - `roots: ['<rootDir>/src']` - Only run backend unit/integration tests
- **Performance**:
  - `maxWorkers: process.env.CI ? '50%' : undefined` - Optimal CI performance
  - `testTimeout: 15000` - Adequate time for integration tests

#### Backend Package.json
- **Test Scripts**:
  - `test:coverage`: Includes `--maxWorkers=50%` for CI optimization
  - No `--forceExit` flag (anti-pattern avoided)

### 4. .gitignore Updates
- **Added**: `*.tsbuildinfo` to prevent TypeScript build info files from being committed

## Coverage Generation

### Issue RESOLVED âœ… (October 2025)

The original issue was that `src/index.ts` called `process.exit(1)` during errors, which would kill Jest before coverage files could be written. This has been **completely resolved** with the following improvements:

**Solutions Implemented**:
1. **Removed process.exit() mocking**: The `jest.setup.cjs` no longer mocks `process.exit()` (anti-pattern removed)
2. **Refactored error handling**: `index.ts` now throws errors instead of calling `process.exit()` in error handlers
3. **Proper test isolation**: Added comprehensive test data cleanup in `setup.ts`
4. **Fixed encryption**: Updated deprecated `crypto.createCipher()` to `crypto.createCipheriv()`
5. **Disabled rate limiting**: Rate limiters skip execution in test environment
6. **Excluded Playwright tests**: Jest config now correctly excludes E2E tests

**Current Status**:
- âœ… Coverage files generate successfully: `backend/coverage/coverage-final.json` (199KB)
- âœ… Jest completes without process.exit issues
- âœ… 9/14 test suites passing (64% success rate)
- âœ… Core functionality tests passing (zakat, sessions, corruption handling)

## Test Isolation Pattern

Backend tests use unique usernames per test file to avoid conflicts:

```typescript
// Use timestamp or unique identifier for test users
const timestamp = Date.now();
const testUser = {
  username: `testuser${timestamp}`,
  email: `testuser${timestamp}@test.com`,
  password: 'TestPassword123!',
  confirmPassword: 'TestPassword123!',
};
```

Tests should use `beforeAll` for user registration and login to avoid rate limiting issues, and each test file should use a unique username pattern.

## Verification

To verify the CI/CD pipeline locally:

```bash
# Clean everything
rm -rf node_modules shared/node_modules shared/dist backend/node_modules backend/coverage

# Install root dependencies
npm ci

# Install and build shared package
cd shared && npm ci && npm run build && cd ..

# Install backend dependencies
cd backend && npm ci

# Run tests with coverage
cd backend && npm run test:coverage

# Verify coverage file exists
ls -lh backend/coverage/coverage-final.json
```

## Expected Outcomes

1. âœ… `package-lock.json` exists in root directory
2. âœ… GitHub Actions workflows created in `.github/workflows/`
3. âœ… Tests run successfully (some may fail, but Jest completes)
4. âœ… Coverage file `backend/coverage/coverage-final.json` is generated
5. âœ… Codecov can upload coverage from the generated file

## Troubleshooting

### Coverage File Not Generated

**Symptoms**: Codecov upload fails with "coverage file not found"

**Solutions**:
1. Verify tests complete successfully: `cd backend && npm run test:coverage`
2. Check coverage file exists: `ls -lh backend/coverage/coverage-final.json`
3. Ensure Jest config has `coverageDirectory: 'coverage'`
4. Verify no process.exit() calls in application code

### Tests Fail with Rate Limiting (429 errors)

**Symptoms**: Tests fail with "Too many requests" errors

**Solution**: Rate limiters are now disabled in test environment (`skip: NODE_ENV === 'test'`)

### Duplicate Registration Errors

**Symptoms**: "User already exists" errors in zakat or auth tests

**Solutions**:
1. Test isolation improved with `beforeEach` cleanup in `setup.ts`
2. Verify test data directories are cleaned between tests
3. Use unique usernames with timestamps for test users

### Jest Doesn't Exit / Hangs

**Symptoms**: Tests complete but Jest doesn't exit, or hangs indefinitely

**Solutions**:
1. âœ… **RESOLVED**: Removed process.exit() mocking
2. Check for open handles: `npm test -- --detectOpenHandles`
3. Verify no long-running timers or unclosed connections

### Encryption Tests Fail

**Symptoms**: "Encryption failed" errors in security tests

**Solution**: âœ… **RESOLVED**: Fixed deprecated crypto.createCipher() â†’ crypto.createCipheriv()

### Playwright Tests Run in Jest

**Symptoms**: Playwright tests fail with "needs to be invoked via npx playwright test"

**Solution**: âœ… **RESOLVED**: Updated jest.config.cjs with `testPathIgnorePatterns`

## Testing with Different Node.js Versions

To test with multiple Node.js versions locally:

```bash
# Install nvm (Node Version Manager) if not already installed
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# Install and test with Node.js 18
nvm install 18
nvm use 18
cd backend && npm run test:coverage

# Install and test with Node.js 20
nvm install 20
nvm use 20
cd backend && npm run test:coverage
```

## Current Status (October 2025)

- âœ… Coverage files generate reliably
- âœ… No process.exit() anti-patterns
- âœ… Workflows have proper quality gates
- âœ… Test isolation improved significantly
- âœ… 64% test suite success rate (9/14 passing)
- ðŸ”„ Some test suites need additional fixes (assetBulk, enhancedAssets, assets, auth, security)

Related: [GitHub Issue #180](https://github.com/slimatic/zakapp/issues/180)
