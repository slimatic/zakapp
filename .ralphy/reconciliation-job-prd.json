{
  "title": "Update hawlDetectionJob as Reconciliation Backup",
  "issue_id": "zakapp-0q1.6",
  "priority": "P2",
  "overview": "Transform the hawlDetectionJob from primary Hawl detection mechanism to a safety net / reconciliation system that catches missed events and fixes inconsistencies.",
  "current_state": {
    "description": "hawlDetectionJob runs hourly and is the ONLY mechanism for detecting Nisab crossing and creating DRAFT records. It's the primary system.",
    "file": "server/src/jobs/hawlDetectionJob.ts",
    "frequency": "Every hour (cron: 0 * * * *)"
  },
  "desired_state": {
    "description": "Job becomes a backup/reconciliation system that runs AFTER the real-time triggers handle primary detection. It catches missed events, fixes drift, and monitors system health.",
    "frequency": "Every hour (keep same for initial rollout, can reduce to 6-12 hours later)",
    "role": "Safety net, not primary detection"
  },
  "requirements": [
    {
      "id": "REQ-1",
      "title": "Add reconciliation logic to detect wealth drift",
      "description": "For users with active DRAFT records, compare actualWealth vs recordedWealth. If drift > $0.01, log warning and fix mismatch.",
      "acceptance_criteria": [
        "Fetch active DRAFT records",
        "Calculate actual wealth for each user",
        "Compare with recorded wealth in DRAFT",
        "Log warning if drift detected",
        "Update record wealth if drift > $0.01",
        "Track metrics: usersWithDrift, usersFixed, averageDrift, maxDrift"
      ]
    },
    {
      "id": "REQ-2",
      "title": "Add monitoring and alerting",
      "description": "If job consistently finds mismatches (>5% of users have drift), alert that real-time system may be failing.",
      "acceptance_criteria": [
        "Calculate drift percentage (users with drift / total users)",
        "Log metrics at INFO level",
        "Log warning if drift rate > 5%",
        "Include drift metrics in job completion logs"
      ]
    },
    {
      "id": "REQ-3",
      "title": "Update job documentation",
      "description": "Document the new role as reconciliation backup, not primary detection.",
      "acceptance_criteria": [
        "Update JSDoc comments explaining new role",
        "Add comments explaining reconciliation logic",
        "Document when to reduce frequency (after real-time system is proven stable)"
      ]
    },
    {
      "id": "REQ-4",
      "title": "Preserve existing functionality",
      "description": "Job should still detect Nisab achievement for users WITHOUT active DRAFT records (handles edge cases where real-time triggers failed).",
      "acceptance_criteria": [
        "Keep existing Nisab detection logic",
        "Only create records if real-time system missed it",
        "Log when backup detection triggers (indicates real-time failure)"
      ]
    }
  ],
  "implementation_guidance": {
    "file_to_modify": "server/src/jobs/hawlDetectionJob.ts",
    "key_changes": [
      "Add new function: reconcileExistingRecords()",
      "Add new function: detectMissedNisabCrossings()",
      "Split job into two phases: (1) reconciliation, (2) detection",
      "Add metrics collection object",
      "Add drift calculation logic",
      "Update logging to include metrics"
    ],
    "pseudo_code": {
      "reconcileExistingRecords": [
        "Fetch all DRAFT records",
        "For each record:",
        "  - Get user's current actual wealth",
        "  - Get recorded wealth from DRAFT",
        "  - Calculate drift = abs(actual - recorded)",
        "  - If drift > 0.01:",
        "    - Log warning with userId, actual, recorded, drift",
        "    - Update record with actual wealth",
        "    - Increment metrics.usersFixed",
        "    - Track drift for average calculation",
        "Return metrics"
      ],
      "detectMissedNisabCrossings": [
        "Fetch users WITHOUT active DRAFT records",
        "For each user:",
        "  - Calculate wealth",
        "  - Check if above Nisab",
        "  - If yes:",
        "    - Log warning: 'Real-time trigger missed this user'",
        "    - Create DRAFT record (backup)",
        "    - Increment metrics.missedDetections"
      ]
    }
  },
  "testing": {
    "manual_tests": [
      "Run job with no DRAFT records - should work normally",
      "Create DRAFT with wrong wealth - job should fix it",
      "Create user above Nisab without DRAFT - job should detect and create",
      "Check logs for metrics output"
    ],
    "success_metrics": {
      "drift_rate": "< 1% in normal operation",
      "missed_detections": "0 after real-time system is proven stable",
      "job_duration": "< 30 seconds for 1000 users"
    }
  },
  "dependencies": {
    "completed": [
      "zakapp-0q1.1 - AssetService triggers",
      "zakapp-0q1.2 - handleWealthChange method",
      "zakapp-0q1.5 - Integration tests"
    ],
    "required_services": [
      "HawlTrackingService",
      "WealthAggregationService",
      "NisabYearRecordService"
    ]
  },
  "files_to_read": [
    "server/src/jobs/hawlDetectionJob.ts",
    "server/src/services/hawlTrackingService.ts",
    "server/src/services/wealthAggregationService.ts",
    "server/src/services/nisabYearRecordService.ts"
  ],
  "success_criteria": [
    "Job runs successfully without errors",
    "Reconciliation logic detects and fixes wealth drift",
    "Backup detection catches users missed by real-time system",
    "Metrics are logged for monitoring",
    "Documentation updated to reflect new role",
    "No regression in existing functionality"
  ]
}
