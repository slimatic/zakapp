{
  "tasks": [
    {
      "id": "fix-tests-1",
      "title": "Fix auth/register response format in integration tests (Part 1)",
      "description": "Update integration tests to use new auth/register response format. The API response changed from flat structure {accessToken, user} to nested structure {success: true, data: {tokens: {accessToken}, user: {}}}. Update first 6 test files to use new format.",
      "files": [
        "server/tests/integration/liveTracking.test.ts",
        "server/tests/integration/hawlInterruption.test.ts",
        "server/tests/integration/statusTransitions.test.ts",
        "server/tests/integration/finalization.test.ts",
        "server/tests/integration/invalidOperations.test.ts",
        "server/tests/integration/hawlDetectionAssets.test.ts"
      ],
      "requirements": [
        "Replace registerResponse.body.accessToken with registerResponse.body.data.tokens.accessToken",
        "Replace registerResponse.body.refreshToken with registerResponse.body.data.tokens.refreshToken",
        "Replace registerResponse.body.user.id with registerResponse.body.data.user.id",
        "Replace registerResponse.body.user.email with registerResponse.body.data.user.email",
        "Replace registerResponse.body.user with registerResponse.body.data.user (when not accessing specific property)",
        "Replace response.body.accessToken with response.body.data.tokens.accessToken (for any 'response' variable)",
        "Replace response.body.user with response.body.data.user (for any 'response' variable)",
        "Do NOT modify string literals or comments",
        "After each file is fixed, run: npm test -- <filepath> to verify it works",
        "If test still fails, examine error and fix additional issues"
      ],
      "success_criteria": [
        "All 6 test files pass when run individually",
        "No more 'Cannot read properties of undefined' errors in beforeAll/beforeEach",
        "userId and authToken are properly set from registration response"
      ],
      "completed": true
    },
    {
      "id": "fix-tests-2",
      "title": "Fix auth/register response format in integration tests (Part 2)",
      "description": "Continue updating remaining integration tests to use new auth/register response format.",
      "files": [
        "server/tests/integration/unlockEdit.test.ts",
        "server/src/__tests__/integration/assets.api.test.ts",
        "server/src/__tests__/integration/assets.eligibility.test.ts",
        "server/src/__tests__/integration/analytics-api.test.ts",
        "server/src/__tests__/integration/encryption-admin.test.ts",
        "server/src/__tests__/authController.isVerified.test.ts"
      ],
      "requirements": [
        "Apply same replacements as Part 1",
        "Replace registerResponse.body.accessToken with registerResponse.body.data.tokens.accessToken",
        "Replace registerResponse.body.user.id with registerResponse.body.data.user.id",
        "Replace response.body.accessToken with response.body.data.tokens.accessToken",
        "Replace response.body.user with response.body.data.user",
        "After each file is fixed, run: npm test -- <filepath> to verify",
        "Pay special attention to analytics-api.test.ts which has 401 auth errors"
      ],
      "success_criteria": [
        "All 6 test files pass",
        "analytics-api.test.ts no longer has 401 Unauthorized errors",
        "All integration tests can successfully register users and get tokens"
      ],
      "completed": true
    },
    {
      "id": "fix-tests-3",
      "title": "Fix contract test validation failures",
      "description": "Update contract tests to expect numeric types for wealth fields instead of strings. In zakapp-0q1.5, nisabYearRecordService._mapToResponse() was fixed to return numbers for totalWealth, totalLiabilities, zakatableWealth, and zakatAmount fields (previously returned as strings after decryption).",
      "files": [
        "server/tests/contract/nisabYearRecords.get.test.ts",
        "server/tests/contract/nisabYearRecords.getById.test.ts",
        "server/tests/contract/nisabYearRecords.put.test.ts",
        "server/tests/contract/nisabYearRecords.delete.test.ts",
        "server/tests/contract/nisabYearRecords.finalize.test.ts",
        "server/tests/contract/nisabYearRecords.unlock.test.ts"
      ],
      "requirements": [
        "Run each contract test file to see specific validation errors",
        "Look for schema validation failures for fields: totalWealth, totalLiabilities, zakatableWealth, zakatAmount",
        "Update test expectations/schemas to expect number type instead of string type for these fields",
        "Ensure assetBreakdown remains as encrypted string (don't change)",
        "Ensure calculationDetails remains as string (don't change)",
        "After fixing each file, verify: npm test -- <filepath>",
        "Reference implementation: server/src/services/nisabYearRecordService.ts lines 774-803"
      ],
      "success_criteria": [
        "All 48 contract tests pass",
        "No more validation errors about expected string but got number",
        "Wealth fields properly validated as numbers"
      ],
      "completed": true
    },
    {
      "id": "fix-tests-4",
      "title": "Fix methodology documentation test failures",
      "description": "Investigate and fix failing tests in methodology-documentation.test.ts. These tests validate methodology documentation, references, and calculation explanations.",
      "files": [
        "server/src/__tests__/methodology-documentation.test.ts"
      ],
      "requirements": [
        "Run test file to see specific failure messages: npm test -- server/src/__tests__/methodology-documentation.test.ts",
        "Analyze each failure - likely issues with: methodology references, documentation strings, calculation validation",
        "Fix based on actual error messages",
        "If tests expect different methodology strings, update test expectations to match actual implementation",
        "Verify all ~25 tests pass after fixes"
      ],
      "success_criteria": [
        "All methodology documentation tests pass",
        "No assertion failures",
        "Documentation validation works correctly"
      ],
      "completed": true
    },
    {
      "id": "fix-tests-5",
      "title": "Fix remaining test failures and verify",
      "description": "Fix any remaining test failures (calendarService, MetalPriceScraperService) and run full test suite to verify all 522 tests pass.",
      "files": [
        "server/src/__tests__/calendarService.test.ts",
        "server/src/__tests__/MetalPriceScraperService.test.ts"
      ],
      "requirements": [
        "Run each test file to see specific errors",
        "Fix calendarService date conversion issues",
        "Fix MetalPriceScraperService silver price scraping failures",
        "After individual fixes, run full test suite: cd server && npm test",
        "Verify final output shows: Test Files 52 passed (52), Tests 522 passed (522)",
        "If any tests fail, analyze and fix them",
        "Some tests may be flaky - run 2-3 times if intermittent failures"
      ],
      "success_criteria": [
        "All 522 tests pass",
        "0 test failures",
        "0 skipped tests (except intentionally disabled)",
        "Test suite completes successfully"
      ]
    }
  ]
}