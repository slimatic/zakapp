{
  "tasks": [
    {
      "id": "fix-remaining-1",
      "title": "Fix remaining API response format issues in integration tests",
      "description": "Complete the response format fixes that were started. Many tests still use old response patterns like createResponse.body.record.id instead of createResponse.body.data.id, or response.body.record instead of response.body.data",
      "files": [
        "server/tests/integration/finalization.test.ts",
        "server/tests/integration/hawlInterruption.test.ts",
        "server/tests/integration/statusTransitions.test.ts",
        "server/tests/integration/unlockEditRefinalize.test.ts",
        "server/tests/integration/errorHandling.test.ts",
        "server/tests/integration/nisabAchievement.test.ts",
        "server/tests/integration/liveWealth.test.ts",
        "server/tests/integration/asset-management.test.ts",
        "server/tests/integration/user-registration.test.ts"
      ],
      "requirements": [
        "Find and replace response format patterns:",
        "createResponse.body.record → createResponse.body.data",
        "response.body.record → response.body.data",
        "updateResponse.body.record → updateResponse.body.data",
        "deleteResponse.body.record → deleteResponse.body.data (though delete may just return {success: true})",
        "After each file, run: npm test -- <filepath> to verify",
        "If test still fails, read the error carefully and fix the actual issue"
      ],
      "success_criteria": [
        "All 9 integration test files pass",
        "No more 'Cannot read properties of undefined' errors",
        "Response data is properly accessed via .data property"
      ],
      "completed": true
    },
    {
      "id": "fix-remaining-2",
      "title": "Fix remaining contract test failures",
      "description": "Fix contract tests for assets, auth, nisab records, and calendar that are still failing due to response format or schema validation issues",
      "files": [
        "server/tests/contract/assets-post.test.ts",
        "server/tests/contract/assets-get.test.ts",
        "server/tests/contract/assets-put.test.ts",
        "server/tests/contract/assets-delete.test.ts",
        "server/tests/contract/auth-register.test.ts",
        "server/tests/contract/auth-refresh.test.ts",
        "server/tests/contract/nisabYearRecords.delete.test.ts",
        "server/tests/contract/nisabYearRecords.unlock.test.ts",
        "server/tests/contract/calendar.contract.test.ts"
      ],
      "requirements": [
        "Run each contract test to see the specific validation errors",
        "For auth-register.test.ts: Update expectations to match new nested response format {success: true, data: {user, tokens}}",
        "For asset contract tests: Ensure response schemas expect {success: true, data: <asset>} format",
        "For nisabYearRecords tests: Ensure numeric fields (totalWealth, etc) are validated as numbers not strings",
        "Update schema validators or test expectations to match actual API responses",
        "After each file, verify: npm test -- <filepath>"
      ],
      "success_criteria": [
        "All 9 contract test files pass",
        "Schema validations match actual API response structure",
        "No contract validation errors"
      ],
      "completed": true
    },
    {
      "id": "fix-remaining-3",
      "title": "Fix unit test failures",
      "description": "Fix unit tests for services and components that are failing, likely due to mock configuration or updated response formats",
      "files": [
        "server/tests/unit/services/nisabYearRecordService.test.ts",
        "server/tests/unit/services/hawlTrackingService.test.ts",
        "server/tests/unit/services/auditTrailService.test.ts",
        "server/tests/unit/services/nisabCalculationService.test.ts",
        "server/tests/unit/services/wealthAggregationService.test.ts",
        "server/tests/unit/security/payment-security-audit.test.ts",
        "server/tests/unit/components/AuditTrailView.test.ts",
        "server/tests/unit/components/FinalizationModal.test.ts",
        "server/tests/unit/components/HawlProgressIndicator.test.ts",
        "server/tests/unit/components/NisabComparisonWidget.test.ts",
        "server/tests/unit/components/UnlockReasonDialog.test.ts"
      ],
      "requirements": [
        "Run each unit test file to see specific failure",
        "Common issues: mock return values, type expectations, function signatures",
        "For service tests: Update mocks to return correct data types (numbers not strings for wealth fields)",
        "For component tests: Update props or mock responses to match new formats",
        "After each file, verify: npm test -- <filepath>"
      ],
      "success_criteria": [
        "All 11 unit test files pass",
        "Mocks properly configured",
        "Type expectations match actual implementations"
      ]
    },
    {
      "id": "fix-remaining-4",
      "title": "Fix accessibility and performance tests",
      "description": "Fix the remaining edge case test files: accessibility tests and any performance test issues",
      "files": [
        "server/tests/accessibility/a11y.test.ts",
        "server/tests/performance/wealthAggregation.performance.test.ts"
      ],
      "requirements": [
        "Run each test file to see specific failures",
        "For a11y.test.ts: May need to update component imports or test setup",
        "For performance tests: Fix foreign key constraint errors and test data setup",
        "Verify fixes: npm test -- <filepath>"
      ],
      "success_criteria": [
        "Both test files pass",
        "No foreign key constraint errors",
        "Accessibility tests run successfully"
      ]
    },
    {
      "id": "fix-remaining-5",
      "title": "Final verification and BD tracking update",
      "description": "Run full test suite, verify all 677 tests pass, and update BD issue tracking",
      "requirements": [
        "Run full test suite: cd server && npm test",
        "Verify output shows 0 failures, ~677 tests passing",
        "If any tests still fail, analyze and fix them",
        "Once all tests pass, update BD tracking with: bd sync"
      ],
      "success_criteria": [
        "Full test suite passes: Test Files 103 passed (103)",
        "All 677 tests pass (or close to it, accounting for intentionally skipped tests)",
        "No remaining test failures",
        "BD tracking updated"
      ]
    }
  ]
}